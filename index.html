<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>LernDashboard Digital</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6b46c1">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="prefetch" href="edit-resource.html">
    <link rel="prefetch" href="new-resource.html">

    <!-- DYNAMISCHER JSPDF-LOADER -->
<script>
 // @ts-nocheck  
const REPO_PATH = (
    location.hostname === 'localhost' ||
    location.hostname === '127.0.0.1' ||
    location.protocol === 'file:'
) ? '/' : 'https://matthiasklossmpz.github.io/lerndashboard-test/';

    window.jspdfLoaded = false;

    const jspdfScript = document.createElement('script');
    jspdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';

    jspdfScript.onload = () => {
        const autotableScript = document.createElement('script');
        autotableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';

        autotableScript.onload = () => {
            window.jspdfLoaded = true;
            console.log('jsPDF + autoTable erfolgreich geladen');

            // BUTTON AKTIVIEREN
            const matrixBtn = document.getElementById('matrixPdfBtn');
            if (matrixBtn) {
                matrixBtn.disabled = false;
                matrixBtn.textContent = 'Matrix PDF';
                matrixBtn.onclick = exportMatrixPDF; // Jetzt sicher zuweisen
            }
        };

        autotableScript.onerror = () => {
            console.error('Fehler beim Laden von jsPDF autoTable');
            alert('Fehler: PDF-Export (Matrix) konnte nicht geladen werden.');
        };

        document.head.appendChild(autotableScript);
    };

    jspdfScript.onerror = () => {
        console.error('Fehler beim Laden von jsPDF');
        alert('Fehler: PDF-Bibliothek konnte nicht geladen werden.');
    };

    document.head.appendChild(jspdfScript);

    // Optional: Ladehinweis im Button anzeigen

</script>

    <!-- jsPDF + Autotable (für Tabellen in PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
    .logo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        width: 100%;
    }
    .logo-left {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
    }
    .logo-right svg {
        height: 80px !important;
        width: auto;
    }
    .logo-title {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .title-main {
        font-size: 24px;
        font-weight: 800;
        color: #333;
    }
    .title-sub {
        font-size: 14px;
        color: #666;
    }
    :root {
        --primary: #6b46c1;
        --primary-light: #7e5be0;
        --danger: #e53e3e;
        --bg: #f5f7fa;
        --card: #ffffff;
        --shadow: 0 1px 3px rgba(0,0,0,0.1);
        --tool: #1e90ff;
        --competence: #ff8c00;
        --grade: #50c878;
        --subject: #9b59b6;
        --text: #333;
        --text-light: #555;
        --favorite: #f39c12;
        --level: #00bfff;  
        }
    .dark {
        --bg: #1a1a1a;
        --card: #2d2d2d;
        --text: #e0e0e0;
        --text-light: #bbbbbb;
        --shadow: 0 1px 3px rgba(0,0,0,0.3);
        background: #111 !important;
        color: var(--text) !important;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0; padding: 20px;
        background: var(--bg); color: var(--text);
    }
    .main { width: 100%; }
.centered-button-wrapper {
    display: flex;
    justify-content: center;
    margin: 6px 0 12px !important;   /* Kleiner Abstand oben/unten – einheitlich */
    width: 100%;
}
.resources-container {
    flex: 1 1 600px;           /* Mindestbreite 600px, wächst */
    min-width: 0;              /* Verhindert Overflow */
    order: 1;
}

.sidebar {
    width: 340px !important;
    min-width: 340px;
    flex: 0 0 340px;
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    box-shadow: var(--shadow);
    position: sticky;
    top: 20px;
    align-self: flex-start;
    order: 2;
    margin-left: auto; /* Schiebt Sidebar ans rechte Ende */
}
    .sidebar h3 { margin: 0 0 16px; color: var(--primary); font-size: 16px; text-align: center; }
    .stat-bar { margin: 12px 0; }
    .stat-bar label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; color: var(--text-light); }
    .bar-container { height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; }
    .bar { height: 100%; background: var(--primary); border-radius: 5px; transition: width 0.4s ease; }
    .bar-value { font-weight: bold; color: var(--primary); }
    .filter-container { background: linear-gradient(135deg, #eef5ff, #e0edff); padding: 14px; border-radius: 12px; border: 1px solid #cce0ff; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); width: 100%; }
    .filters { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; min-width: 140px; flex: 1; }
    .filter-group label { font-size: 12px; color: #555; margin-bottom: 4px; font-weight: 600; }
    .filter-group select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; }
    .search-container {
        position: relative;
        flex: 1;
        max-width: 280px !important;
        min-width: 180px;
        margin-right: 10px;
    }
    .search-input { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    #suggestions { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ccc; max-height: 180px; overflow-y: auto; z-index: 1000; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
    #suggestions div { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
    #suggestions div:hover { background: #f0f4ff; }
    .reset-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin-left: 12px;
        align-self: flex-end;
    }
    .export-buttons { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { background: var(--primary); color: white; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: normal; transition: 0.2s; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .file-input { display: none; }
    .new-resource-btn { display: block; margin: 20px auto; padding: 14px 28px; font-size: 17px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 6px 16px rgba(107,70,193,0.3); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; max-width: 360px; }
    .new-resource-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(107,70,193,0.4); }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 16px 0; }
    .stat-card { background: var(--card); padding: 12px; border-radius: 10px; text-align: center; box-shadow: var(--shadow); font-weight: 600; }
    .stat-card span { display: block; font-size: 22px; color: var(--primary); margin-top: 6px; }
    .resource-item { margin: 12px 0; padding: 16px; border: 1px solid #e0e0e0; border-radius: 12px; background: var(--card); box-shadow: var(--shadow); transition: transform 0.2s; }
    .resource-item:hover { transform: translateY(-2px); }
    .resource-content { margin-bottom: 12px; line-height: 1.6; font-size: 15px; }
    .tag {
        display: inline-block;
        padding: 4px 10px;
        margin: 2px 4px 2px 0;
        border-radius: 16px;
        font-size: 11px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .tag:hover {
        opacity: 0.85;
        transform: scale(1.05);
    }
    .grade-tag { background: var(--grade); }
    .tool-tag { background: var(--tool); }
    .competence-tag { background: var(--competence); }
    .level-tag { background: var(--level); }
    .subject-tag { background: var(--subject); }
    .description { margin-top: 10px; font-size: 13px; color: var(--text-light); background: #f8f9fa; padding: 8px; border-radius: 6px; border-left: 3px solid var(--primary); }
    .action-icons { display: flex; gap: 8px; justify-content: flex-end; align-items: center; }
    .action-icon { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .action-icon:hover { transform: scale(1.15); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .action-icon svg { width: 18px; height: 18px; fill: currentColor; }
    .edit-icon { background: #e8f5e8; color: #27ae60; } .edit-icon:hover { background: #27ae60; color: white; }
    .delete-icon { background: #ffe8e8; color: #e74c3c; } .delete-icon:hover { background: #e74c3c; color: white; }
    .favorite-icon { background: #fff8e1; color: #f39c12; } .favorite-icon.active { background: #f39c12; color: white; }
    #editForm { display: none; margin-top: 25px; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    .form-group textarea { min-height: 90px; resize: vertical; }
    #editForm button { margin-right: 10px; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    #editForm button[type="submit"] { background: var(--primary); color: white; }
    #editForm button[type="button"] { background: #95a5a6; color: white; }
    .version-info {
        position: fixed;
        bottom: 10px;
        right: 10px;
        font-size: 11px;
        color: var(--text-light);
        background: var(--card);
        padding: 4px 8px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        z-index: 100;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    .version-info:hover { opacity: 1; }

/* === SCHUL-BUTTON: IDENTISCH ZUM NEUE-RESSOURCE-BUTTON (OHNE ICON) === */
.school-btn {
    background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
    margin: 16px auto 8px !important;
    max-width: 100% !important;
    font-size: 16px !important;
    padding: 14px 20px !important;
    box-shadow: 0 6px 16px rgba(155, 89, 182, 0.3) !important;
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    border: none;
    color: white;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    width: 100%;
}

.school-btn:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 12px 28px rgba(155, 89, 182, 0.4) !important;
}

.school-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.7s;
}

.school-btn:hover::before {
    left: 100%;
}

/* Wenn Schulname gesetzt → grün */
#schoolButton[data-set="true"] {
    background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
    box-shadow: 0 6px 16px rgba(46, 204, 113, 0.3) !important;
}

#schoolButton[data-set="true"]:hover {
    box-shadow: 0 12px 28px rgba(46, 204, 113, 0.4) !important;
}
.content-wrapper {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    width: 100%;
}
/* ==================== MOBILE OPTIMIERUNGEN – FINAL ==================== */
@media (max-width: 768px) {
    body { 
        padding: 10px; 
        overflow-x: hidden; /* Verhindert horizontales Scrollen */
    }

    /* --- HEADER --- */
    .logo-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 14px;
        margin-bottom: 18px;
    }
    .logo-left, .logo-right {
        width: 100%;
        justify-content: center;
    }
    .logo-left svg { height: 85px !important; }
    .logo-right svg { height: 55px !important; }
    .title-main { font-size: 19px; }
    .title-sub { font-size: 12.5px; }

    /* --- FILTER --- */
    .filter-container { 
        padding: 12px; 
        margin-bottom: 14px;
    }
    .filters {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    .filter-group, .search-container {
        min-width: 0;
        max-width: none !important;
        flex: 1;
    }
    .search-container {
        margin: 0;
    }
    .reset-btn {
        margin: 8px 0 0 0;
        align-self: stretch;
        padding: 10px;
    }

    /* --- SIDEBAR: KEIN STICKY MEHR, VOLLBREITE --- */
    .sidebar {
        width: 100% !important;
        position: static !important;   /* WICHTIG: sticky deaktivieren */
        top: auto !important;
        padding: 14px;
        order: 2; /* Sidebar NACH Ressourcen */
        margin-top: 10px;
        z-index: 1; /* Sicherstellen, dass nichts überlagert */
    }
    .resources-container {
        order: 1;
        min-width: 0;
    }
/* === MOBILE: Sidebar unter Ressourcen === */
@media (max-width: 992px) {
    .content-wrapper {
        flex-direction: column;
    }
.resources-container,
    .sidebar {
        width: 100% !important;
        min-width: 0 !important;
        flex: none !important;
        order: unset !important;
        margin-left: 0 !important;
    }
    .sidebar {
        position: static;
        top: auto;
        margin-top: 20px;
    }
}
    /* --- SCHULNAME-BUTTON (MOBILE) --- */
#schoolButton {
    font-size: 12.5px;
    padding: 9px 10px;
    min-height: 42px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#schoolButton:hover {
    box-shadow: 0 4px 10px rgba(0,0,0,0.18);
}

#schoolButton[data-set="true"]:hover {
    box-shadow: 0 4px 10px rgba(197, 143, 224, 0.35);
}

/* === EXPORT-BUTTONS – EINHEITLICHES FARBKONZEPT === */
.export-buttons .btn {
    font-weight: 600;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    transition: all 0.2s ease;
}

/* 1. ALLE EXPORT → VIOLETT */
.btn.csv,
.btn.pdf,
.btn.matrix {
    background: var(--primary);
    color: white;
}

/* 2. IMPORT & VORLAGE → BLAU */
.btn.import,
.btn.template {
    background: #2980b9;
    color: white;
}

/* 3. DRUCKEN → DUNKELGRAU */
.btn.print {
    background: #2c3e50;
    color: white;
}

/* 4. BACKUP → GRÜN (wie gewünscht) */
.btn[onclick="autoBackup()"] {
    background: #2ecc71;
    color: white;
}

/* Hover für alle */
.export-buttons .btn:hover {
    opacity: 0.92;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
    .export-buttons {
        flex-wrap: wrap;
        gap: 8px;
        justify-content: stretch;
    }
    .btn {
        flex: 1 1 45%;
        min-width: 0;
        font-size: 13px;
        padding: 9px 8px;
        white-space: nowrap;
    }

/* --- NEUE RESSOURCE BUTTON (MOBILE) --- */
.new-resource-btn {
    max-width: 100%;
    font-size: 15.5px;
    padding: 13px 18px;
    margin: 18px auto;
    box-shadow: 0 6px 16px rgba(0, 210, 211, 0.3);
}

.new-resource-btn:hover {
    box-shadow: 0 10px 24px rgba(0, 210, 211, 0.4);
}

    /* --- STATS --- */
    .stats {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .stat-card span { font-size: 17px; }

    /* --- RESSOURCEN --- */
    .resource-item {
    margin: 0 0 16px 0;         /* Kein margin links/rechts */
    padding: 16px;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    background: var(--card);
    box-shadow: var(--shadow);
    transition: transform 0.2s;
    break-inside: avoid;       /* Verhindert Zeilenumbruch in Karten */
    }
    .action-icons { gap: 5px; }
    .action-icon { width: 30px; height: 30px; }
    .action-icon svg { width: 15px; height: 15px; }

    /* --- VERSION INFO --- */
    .version-info {
        position: fixed;
        bottom: 8px;
        left: 8px;
        right: 8px;
        text-align: center;
        font-size: 9.5px;
        padding: 3px 6px;
        z-index: 10;
    }

    /* --- TOUCH OPTIMIERUNG --- */
    .btn, .action-icon, .tag, .reset-btn, .new-resource-btn, select, input {
        min-height: 44px;
        touch-action: manipulation;
    }
        .btn.import {
        font-weight: normal !important;
        text-align: center !important;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        padding: 9px 8px;
    }
    .btn.import span {
        display: block;
        width: 100%;
        text-align: center;
        pointer-events: none;
    }
    .btn.import input[type="file"] {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        opacity: 0;
        cursor: pointer;
    }
}
/* === NEUE RESSOURCE – TÜRKIS-GRADIENT (DESKTOP & BASIS) === */
.new-resource-btn {
    display: block;
    margin: 20px auto;
    padding: 14px 28px;
    font-size: 17px;
    font-weight: 700;
    background: linear-gradient(135deg, #00d2d3, #48cae4);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 6px 16px rgba(0, 210, 211, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    max-width: 360px;
    position: relative;
    overflow: hidden;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.new-resource-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.7s;
}

.new-resource-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 28px rgba(0, 210, 211, 0.4);
}

.new-resource-btn:hover::before {
    left: 100%;
}


/* Sehr kleine Bildschirme */
@media (max-width: 380px) {
    .stats { grid-template-columns: 1fr; }
    .export-buttons { flex-direction: column; }
    .btn { flex: 1 1 auto; }
}
/* Filter aktiv: blasses Rot + Akzent OHNE Verschiebung */
.filter-container.active {
    background: linear-gradient(135deg, #fff5f5, #ffeaea) !important;
    box-shadow: 0 2px 8px rgba(255, 0, 0, 0.08) !important;
    position: relative;
    overflow: hidden;
    transition: background 0.3s ease, box-shadow 0.3s ease;
}

.filter-container.active::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
    background: rgba(255, 0, 0, 0.4);
    pointer-events: none; /* damit Klicks durchgehen */
}
    </style>
</head>
<body>
<!-- DRUCK-FOOTER: Schulname (unsichtbar) -->
<div id="printSchoolName" style="position: fixed; bottom: 0; left: 0; font-size: 9pt; color: #666; display: none;">
    Schule: <span id="printSchoolNameText"></span>
</div>
<div style="background: #ff4444; color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
  TESTVERSION – nur für internen Gebrauch! (Diese Änderungen sind noch nicht live)
</div>

<!-- Kleiner Abstand, damit der Rest nicht unter dem Banner verschwindet -->
<div style="height: 70px;"></div>
    
    <div class="main">
        <!-- ZWEI LOGOS + TITEL -->
        <div class="logo-header">
            <div class="logo-left" onclick="toggleDarkMode()">
                <!-- APP-LOGO -->
<svg class="logo-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" style="width: auto; height: 130px; cursor: pointer;">
    <defs>
        <linearGradient id="frameGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#8e67d6"/>
            <stop offset="100%" stop-color="#5e3ab0"/>
        </linearGradient>
        <linearGradient id="screenGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#f0f4ff"/>
            <stop offset="100%" stop-color="#d0e0ff"/>
        </linearGradient>
    </defs>
    <rect x="14" y="14" width="36" height="36" rx="8" fill="url(#frameGrad)" stroke="#4a2e8c" stroke-width="2"/>
    <rect x="16" y="16" width="32" height="32" rx="6" fill="#ffffff"/>
    <rect x="18" y="18" width="28" height="28" rx="4" fill="url(#screenGrad)"/>
    <g transform="translate(19.465148,19.604556)">
        <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#4caf50"/>
        <circle cx="3.5" cy="2.5" r="1.5" fill="#ffffff"/>
        <path d="m 2.5,4.5 h 2" stroke="#ffffff" stroke-width="1"/>
        <g transform="translate(9)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#ff9800"/>
            <path d="M 2,2 5,5 M 5,2 2,5" stroke="#ffffff" stroke-width="1.2" stroke-linecap="round"/>
        </g>
        <g transform="translate(18)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#e91e63"/>
            <circle cx="3.5" cy="3.5" r="2" fill="#ffffff"/>
            <circle cx="4" cy="3" r="0.8" fill="#333333"/>
        </g>
        <g transform="translate(0,9)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#f44336"/>
            <path d="M 2,5 V 3 L 5,4 V 6 L 2,7 Z" fill="#ffffff"/>
            <circle cx="4.5" cy="1.5" r="1" fill="#ffffff"/>
        </g>
        <g transform="translate(9,9)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#2196f3"/>
            <path d="M 2.5,2 5,3.5 v -3 z" fill="#ffffff"/>
        </g>
        <g transform="translate(18,9)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#9c27b0"/>
            <path d="m 1.5,2 h 4 m -4,1.5 h 4 M 1.5,5 h 2" stroke="#ffffff" stroke-width="0.8"/>
        </g>
        <g transform="translate(0,18)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#3f51b5"/>
            <path d="m 1.5,5.5 h 1 v -2 h -1 z m 1.5,0 h 1 v -3 H 3 Z m 1.5,0 h 1 v -1 h -1 z" fill="#ffffff"/>
        </g>
        <g transform="translate(9,18)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#00bcd4"/>
            <circle cx="3.5" cy="3.5" r="2.5" stroke="#ffffff" stroke-width="0.8" fill="none"/>
            <path d="m 1.5,3.5 h 4 m -2,-2 v 4" stroke="#ffffff" stroke-width="0.6"/>
        </g>
        <g transform="translate(18,18)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#eeeeee"/>
            <path d="m 1.5,2 h 4 m -4,2 h 4" stroke="#999999" stroke-width="0.8"/>
            <path d="M 1.5,2 2.2,2.7 M 1.5,2 2.9,3.4" stroke="#4caf50" stroke-width="1"/>
        </g>
    </g>
    <circle cx="20" cy="20" r="3" fill="#fff" opacity="0.5"/>
</svg>
                <div class="logo-title">
                    <div class="title-main">LernDashboard</div>
                    <div class="title-sub">Digital</div>
                </div>
            </div>
            <!-- BUNDESLAND-LOGO (rechts) -->
            <div class="logo-right">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 116.22047 61.596849" style="width: auto; height: 80px;">
                    <defs>
                        <style>
                            .cls-1{fill:#005e90;}.cls-2{fill:url(#Unbenannter_Verlauf_5);}.cls-3{fill:url(#Unbenannter_Verlauf_62);}.cls-4{fill:url(#Unbenannter_Verlauf_41);}.cls-5{fill:#f2b700;}.cls-6{fill:url(#Unbenannter_Verlauf_32);}.cls-7{fill:url(#Unbenannter_Verlauf_6);}.cls-8{fill:url(#Unbenannter_Verlauf_6-2);}
                        </style>
                        <linearGradient id="Unbenannter_Verlauf_5" x1="77.08391" y1="22.21157" x2="113.43772" y2="30.60451" gradientUnits="userSpaceOnUse">
                            <stop offset="0.05" stop-color="#5e9841"/><stop offset="0.4596" stop-color="#679d48"/><stop offset="0.65" stop-color="#6da14d"/><stop offset="0.95" stop-color="#5e9841"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_62" x1="77.08391" y1="22.21157" x2="113.43772" y2="30.60451" gradientUnits="userSpaceOnUse">
                            <stop offset="0.05" stop-color="#289b38"/><stop offset="0.36963" stop-color="#319f41"/><stop offset="0.65" stop-color="#3da54c"/><stop offset="0.95" stop-color="#289b38"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_41" x1="94.87943" y1="13.29865" x2="94.87943" y2="24.93903" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#2676a1"/><stop offset="0.00529" stop-color="#2576a1"/><stop offset="0.17354" stop-color="#116897"/><stop offset="0.33964" stop-color="#046192"/><stop offset="0.5" stop-color="#005e90"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_32" x1="90.27939" y1="14.03253" x2="90.27939" y2="0.00081" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#6dc6e8"/><stop offset="0.19323" stop-color="#58bee5"/><stop offset="0.73219" stop-color="#21a8dc"/><stop offset="0.99375" stop-color="#0ca0d9"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_6" x1="113.26653" y1="13.74329" x2="113.26653" y2="13.73981" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#96c5e2"/><stop offset="0.21183" stop-color="#7fb9dc"/><stop offset="0.51882" stop-color="#64aad5"/><stop offset="0.79155" stop-color="#54a1d1"/><stop offset="1" stop-color="#4e9ecf"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_6-2" x1="112.71431" y1="13.71899" x2="112.71431" y2="13.71558" xlink:href="#Unbenannter_Verlauf_6"/>
                    </defs>
                    <title>NEU_Zeichenfläche 1</title>
                    <g id="tut_gut._40" data-name="tut gut. 40">
                        <path class="cls-1" d="M53.75344,52.80545a3.9581,3.9581,0,0,1-2.40381.78858c-1.52832,0-2.90527-.84571-2.90527-3.10694V44.70438H46.76028A13.6736,13.6736,0,0,0,46.9761,43.013l1.5791-.2583.271-1.95459a11.66615,11.66615,0,0,1,1.70362-.481V43.013h3.20752a13.6736,13.6736,0,0,1-.21582,1.69141h-2.9917v5.27246c0,1.27686.6372,1.69434,1.50586,1.69434a3.2961,3.2961,0,0,0,1.93408-.68506A5.89055,5.89055,0,0,1,53.75344,52.80545Z"/>
                        <path class="cls-1" d="M63.99856,53.52469a7.80025,7.80025,0,0,1-.7041-2.63086,3.86811,3.86811,0,0,1-3.79737,2.69971c-2.06787,0-3.312-1.333-3.312-3.77393v-6.48a14.32361,14.32361,0,0,1,2.08545-.58886v6.64062c0,1.45117.70947,2.22656,1.83789,2.22656,1.64355,0,3.10742-1.59668,3.10742-3.915v-1.4624c0-1.61963-.03125-2.77685-.05517-3.19824a10.5755,10.5755,0,0,1,2.10058-.06543c.01709.35889.04053,1.48975.04053,3.26367V49.3953a12.13883,12.13883,0,0,0,.46387,3.69482A4.53265,4.53265,0,0,1,63.99856,53.52469Z"/>
                        <path class="cls-1" d="M74.62942,52.80545a3.95815,3.95815,0,0,1-2.40381.78858c-1.52832,0-2.90528-.84571-2.90528-3.10694V44.70438H67.63625a13.67169,13.67169,0,0,0,.21582-1.69141l1.5791-.2583.271-1.95459a11.66636,11.66636,0,0,1,1.70361-.481V43.013H74.6133a13.67169,13.67169,0,0,1-.21582,1.69141h-2.9917v5.27246c0,1.27686.63721,1.69434,1.50586,1.69434a3.296,3.296,0,0,0,1.93408-.68506A5.89051,5.89051,0,0,1,74.62942,52.80545Z"/>
                        <path class="cls-1" d="M88.55569,51.67264c1.75.33594,2.498,1.188,2.498,2.43164,0,2.06543-2.11426,3.78516-5.418,3.78516-2.62841,0-4.54052-1.05371-4.54052-2.6499,0-1.39454,1.23925-2.30274,2.69287-2.69629a2.03468,2.03468,0,0,1-1.27149-1.814,1.89434,1.89434,0,0,1,.78711-1.51123,3.13428,3.13428,0,0,1-1.8042-2.86865c0-2.22461,2.0708-3.59863,4.50147-3.59863a5.61022,5.61022,0,0,1,1.73144.25781H91.2051a11.4867,11.4867,0,0,1-.2207,1.56445l-1.49756-.41553a3.09669,3.09669,0,0,1,.69336,1.99707c0,2.22071-2.05811,3.58448-4.49512,3.58448a5.97529,5.97529,0,0,1-1.24121-.12451.79386.79386,0,0,0-.13672.44287c0,.4375.3291.86279,1.7417,1.13427l2.50684.48145ZM89.06447,54.49c0-.47314-.3208-.82324-1.57617-1.06445l-1.96875-.37793c-1.35449.2749-2.48925.92041-2.48925,1.71582,0,.80908,1.25048,1.42285,2.89013,1.42285C87.77346,56.18631,89.06447,55.4368,89.06447,54.49Zm-5.563-8.19726A2.0449,2.0449,0,0,0,85.77785,48.157a2.165,2.165,0,0,0,2.40088-1.94629,2.05016,2.05016,0,0,0-2.271-1.87842A2.17934,2.17934,0,0,0,83.50149,46.29276Z"/>
                        <path class="cls-1" d="M101.107,53.52469a7.80046,7.80046,0,0,1-.70411-2.63086,3.86809,3.86809,0,0,1-3.79736,2.69971c-2.06787,0-3.312-1.333-3.312-3.77393v-6.48a14.32325,14.32325,0,0,1,2.08545-.58886v6.64062c0,1.45117.70947,2.22656,1.83789,2.22656,1.64355,0,3.10742-1.59668,3.10742-3.915v-1.4624c0-1.61963-.03125-2.77685-.05518-3.19824a10.57563,10.57563,0,0,1,2.10059-.06543c.01709.35889.04053,1.48975.04053,3.26367V49.3953a12.13883,12.13883,0,0,0,.46387,3.69482A4.53265,4.53265,0,0,1,101.107,53.52469Z"/>
                        <path class="cls-1" d="M111.73781,52.80545a3.95809,3.95809,0,0,1-2.4038.78858c-1.52832,0-2.90528-.84571-2.90528-3.10694V44.70438h-1.68408a13.67169,13.67169,0,0,0,.21582-1.69141l1.5791-.2583.271-1.95459a11.66636,11.66636,0,0,1,1.70361-.481V43.013h3.20752a13.67169,13.67169,0,0,1-.21582,1.69141h-2.9917v5.27246c0,1.27686.63721,1.69434,1.50586,1.69434a3.29608,3.29608,0,0,0,1.93408-.68506A5.89055,5.89055,0,0,1,111.73781,52.80545Z"/>
                        <path class="cls-1" d="M113.79616,52.3787a1.31151,1.31151,0,0,1,1.28466-1.3794,1.129,1.129,0,0,1,1.13965,1.21436A1.31177,1.31177,0,0,1,114.9358,53.594,1.12982,1.12982,0,0,1,113.79616,52.3787Z"/>
                    </g>
                    <g id="MV_40" data-name="MV 40">
                        <path class="cls-1" d="M70.86079.186,56.3,31.2433H50.56612L36.00536.186a.09132.09132,0,0,1,.08216-.11994h.90427A13.42714,13.42714,0,0,1,40.578.44591a6.59341,6.59341,0,0,1,3.43214,3.50857c1.51057,2.97876,9.42287,19.602,9.42287,19.602s7.91237-16.6232,9.42294-19.602A6.5933,6.5933,0,0,1,66.28805.44591,13.42772,13.42772,0,0,1,69.87429.06606h.90428A.09135.09135,0,0,1,70.86079.186Z"/>
                        <path class="cls-1" d="M32.78247.07069h-.41792a15.44729,15.44729,0,0,0-3.88737.42444c-1.77327.625-3.05629,2.13153-5.26713,6.58515-1.48466,2.99024-5.77485,11.94025-5.777,11.94452-.00213-.00427-4.29232-8.95428-5.777-11.94452C9.44525,2.62666,8.16223,1.12013,6.389.49513A15.44716,15.44716,0,0,0,2.50159.07069H2.08368L0,31.2518H5.92717L7.39906,8.8536,15.75948,26.493h3.34718L27.46708,8.8536,28.939,31.2518h5.92717Z"/>
                    </g>
                    <g id="Bildzeichen_40" data-name="Bildzeichen 40">
                        <path class="cls-2" d="M100.9129,20.95462c-5.679.31559-12.82928,2.6454-17.21232,3.37a52.42079,52.42079,0,0,1-7.24636.61441v6.24207h36.85037V21.45885a47.93751,47.93751,0,0,0-8.41788-.61591C103.67309,20.84294,102.34472,20.87528,100.9129,20.95462Z"/>
                        <path class="cls-3" d="M100.9129,20.95462c-5.679.31559-12.82928,2.6454-17.21232,3.37a52.42079,52.42079,0,0,1-7.24636.61441v6.24207h36.85037V21.45885a47.93751,47.93751,0,0,0-8.41788-.61591C103.67309,20.84294,102.34472,20.87528,100.9129,20.95462Z"/>
                        <path class="cls-4" d="M94.87955,13.29865c-8.53535,0-18.42531.73388-18.42531.73388V24.939a52.41512,52.41512,0,0,0,7.24635-.61445c4.383-.72454,11.53325-3.05438,17.21228-3.37,1.43183-.07935,2.76024-.11169,3.97382-.11169a47.934,47.934,0,0,1,8.41792.616V13.74329S103.72831,13.29865,94.87955,13.29865Z"/>
                        <path class="cls-5" d="M104.10456.00061a64.43537,64.43537,0,0,0-2.6283,9.25488,39.51381,39.51381,0,0,0-.687,4.10034c6.72951.11976,12.51539.38746,12.51539.38746V0Z"/>
                        <path class="cls-6" d="M101.47625,9.25549a64.40366,64.40366,0,0,1,2.6283-9.25407L76.45424.00081V14.03253s9.88995-.73389,18.4253-.73389c1.97325,0,3.9783.02283,5.90967.05719A39.51043,39.51043,0,0,1,101.47625,9.25549Z"/>
                        <path class="cls-7" d="M113.30461,13.74329l-.07617-.00348Z"/>
                        <path class="cls-8" d="M112.75442,13.719l-.08022-.00341Z"/>
                    </g>
                </svg>
            </div>
        </div>

        <!-- FILTER -->
        <div class="filter-container">
            <div class="filters">
                <div class="filter-group">
                    <label>Fach</label>
                    <select id="filterSubject"><option value="">Alle</option></select>
                </div>
                <div class="filter-group">
                    <label>Klasse</label>
                    <select id="filterGrade"><option value="">Alle</option></select>
                </div>
                <div class="filter-group">
    <label>Kompetenz</label>
    <select id="filterCompetence"><option value="">Alle</option></select>
</div>
<div class="filter-group">
    <label>Niveaustufe</label>
    <select id="filterLevel">
        <option value="">Alle</option>
        <option value="Niveaustufe 1">Niveaustufe 1</option>
        <option value="Niveaustufe 2">Niveaustufe 2</option>
        <option value="Niveaustufe 3">Niveaustufe 3</option>
        <option value="Niveaustufe 4">Niveaustufe 4</option>
        <option value="Niveaustufe 5">Niveaustufe 5</option>
    </select>
</div>
<div class="filter-group">
    <label>Tool</label>
    <select id="filterTool"><option value="">Alle</option></select>
</div>
                <div class="filter-group">
                    <label>Favoriten</label>
                    <select id="filterFavorite">
                        <option value="">Alle</option>
                        <option value="true">Nur Favoriten</option>
                    </select>
                </div>
                <div class="search-container">
                    <label>Thema</label>
                    <input type="text" id="searchTopic" class="search-input" placeholder="z.B. Klimawandel">
                    <div id="suggestions"></div>
                </div>
                <button class="reset-btn" onclick="resetFilters()">Reset</button>
            </div>
        </div>

        <!-- STATISTIK -->
        <div class="stats">
            <div class="stat-card"><div>Gesamt</div><span id="statTotal">0</span></div>
            <div class="stat-card"><div>Favoriten</div><span id="statFavorites">0</span></div>
            <div class="stat-card"><div>Tools</div><span id="statTools">0</span></div>
            <div class="stat-card"><div>Fächer</div><span id="statSubjects">0</span></div>
        </div>

         <!-- EXPORT – HORIZONTAL GRUPPIERT + FILTERABHÄNGIGKEIT KLAR -->
        <div class="export-buttons">
            <!-- GRUPPE 1: Filter-Exporte (CSV, PDF, Matrix) -->
            <div class="export-group horizontal">
                <h4 class="export-group-title" id="filterExportTitle">Filter-Exporte</h4>
                <div class="btn-row">
                    <button class="btn csv filtered-export" onclick="exportCSV()" 
                            title="Exportiert gefilterte Ressourcen als CSV (Fach, Klasse, Tool, etc.)">CSV</button>
                    <button class="btn pdf filtered-export" onclick="exportPDF()" 
                            title="Exportiert gefilterte Ressourcen als PDF (nur sichtbare Einträge)">PDF</button>
                    <button class="btn matrix filtered-export" onclick="exportMatrixCSV()" 
                            style="background:#e67e22;" 
                            title="Matrix als CSV – basierend auf aktuellen Filtern">Matrix CSV</button>
                    <button class="btn matrix filtered-export" id="matrixPdfBtn"style="background:#9c27b0; color:white;"title="Matrix als PDF – nur gefilterte Daten"
                            disabled>Matrix PDF</button>
                    <button class="btn matrix filtered-export" onclick="exportMatrixExcel()" 
                            style="background:#27ae60; color:white; border:2px solid #1e7e34;" 
                            title="Formatierte Excel-Matrix mit aktuellen Filtern">Matrix Excel</button>
                </div>
            </div>

<!-- GRUPPE 2: Datenmanagement (unabhängig von Filtern) -->
<div class="export-group horizontal">
    <h4 class="export-group-title">Datenmanagement</h4>
    <div class="btn-row">
        <button class="btn print" onclick="printOptimized()"
                title="Druckt die aktuelle Ansicht (unabhängig von Filtern)">Drucken</button>
        <label class="btn import" title="Importiert neue Ressourcen aus einer CSV-Datei">
            <input type="file" id="importFile" accept=".csv,text/csv" class="file-input" onchange="importCSV(event)">
            <span>Import</span>
        </label>
        <button class="btn template" onclick="exportTemplate()"
                title="Lädt eine leere CSV-Vorlage zum Ausfüllen">Vorlage</button>
        <button class="btn" onclick="autoBackup()"
                title="Erstellt sofort ein lokales Backup aller Daten">Backup jetzt</button>
    </div>
    </div>

<!-- ZENTRIERTE NEUE-RESSOURCE-BUTTON -->
<div class="centered-button-wrapper">
    <button class="new-resource-btn" onclick="openNewResourceWindow()"> Neue Ressource
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="margin-left: 6px;">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
    </button>
</div>
        <!-- RESSOURCEN + SIDEBAR -->
        <div class="content-wrapper">
            <div class="resources-container">
                <div id="resourcesList"></div>
            </div>
            <div class="sidebar">
                <h3>Fächer-Statistik</h3>
                <div style="margin: 12px 0; text-align:center;">
                <button id="schoolButton" class="new-resource-btn school-btn" onclick="setSchoolName()">
                <span id="schoolButtonText">Schule einstellen</span></button>
                </div>
                <div id="statsFach"></div>
            </div>
        </div>
    </div>

    <!-- SVG SYMBOLS -->
    <svg style="display:none">
        <symbol id="edit-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></symbol>
        <symbol id="delete-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        <symbol id="star-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></symbol>
    </svg>

<script>
// === 1. DATEN LADEN ===
let resources = JSON.parse(localStorage.getItem('resources') || '[]');
let tools = new Set(resources.map(r => r.tool?.trim().toLowerCase()).filter(Boolean));
let dropdownsInitialized = false;

// === DATEN FÜR DROPDOWNS ===
const subjects = ['Deutsch','Mathematik','Englisch','Biologie','Chemie','Physik','Geschichte','Geografie','Politik','Wirtschaft','Informatik','Kunst','Musik','Sport','Ethik','Religion'];
const grades = ['Klasse 5','Klasse 6','Klasse 7','Klasse 8','Klasse 9','Klasse 10','Klasse 11','Klasse 12','Klasse 13'];
const competences = [
    'Suchen, Verarbeiten und Aufbewahren',
    'Kommunizieren und Kooperieren',
    'Produzieren und Präsentieren',
    'Schützen und sicher Agieren',
    'Problemlösen und Handeln',
    'Analysieren und Reflektieren'
];

// === 2. ALLE FUNKTIONEN DEFINIEREN (VOR ALLEM ANDEREN!) ===

// --- escapeJs ---
function escapeJs(str) {
    if (!str) return '';
    return str.replace(/'/g, "\\'").replace(/"/g, "\\\"");
}

// --- getSchoolName ---
function getSchoolName() {
    return localStorage.getItem('schoolName');
}

// --- updateSchoolButton ---
function updateSchoolButton() {
    const btn = document.getElementById('schoolButton');
    if (!btn) return;
    const name = getSchoolName();
    if (name) {
        btn.textContent = name;
        btn.title = 'Schulname ändern';
        btn.dataset.set = 'true';
    } else {
        btn.textContent = 'Schule einstellen';
        btn.title = 'Schulname festlegen';
        btn.dataset.set = 'false';
    }
}

// --- setFilterAndApply ---
function setFilterAndApply(filterId, value) {
    const select = document.getElementById(filterId);
    if (select) {
        select.value = value;
        applyFilters();
        document.querySelector('.filter-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// --- updateToolFilter ---
function updateToolFilter() {
    const s = document.getElementById('filterTool');
    if (s) {
        s.innerHTML = '<option value="">Alle</option>';
        const uniqueTools = [...new Set(resources.map(r => r.tool).filter(Boolean))];
        uniqueTools.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' })).forEach(tool => {
            s.add(new Option(tool, tool.toLowerCase()));
        });
    }
}

// --- updateFilterHighlight ---
function updateFilterHighlight() {
    const container = document.querySelector('.filter-container');
    if (!container) return;
    const selects = container.querySelectorAll('select');
    const search = container.querySelector('#searchTopic');
    const isActive = Array.from(selects).some(s => s.value && s.value !== '') ||
                     (search && search.value.trim() !== '');
    container.classList.toggle('active', isActive);
}

// --- updateFilterStatus ---
function updateFilterStatus() {
    const isFiltered = getFilteredResources().length < resources.length;
    const title = document.getElementById('filterExportTitle');
    if (title) {
        title.textContent = isFiltered ? 'Filter-Exporte (aktiv)' : 'Filter-Exporte';
        title.style.color = isFiltered ? '#e74c3c' : 'var(--primary)';
    }
    document.querySelectorAll('.filtered-export').forEach(btn => {
        btn.classList.toggle('active', isFiltered);
    });
}

// --- populateDropdowns ---
function populateDropdowns() {
    const addOptions = (id, options) => {
        const select = document.getElementById(id);
        if (select) {
            select.innerHTML = '<option value="">Alle</option>';
            options.forEach(opt => select.add(new Option(opt, opt)));
        }
    };
    addOptions('filterSubject', subjects);
    addOptions('filterGrade', grades);
    addOptions('filterCompetence', competences);
    updateToolFilter();
}

// --- applyFilters ---
function applyFilters() {
    const filtered = getFilteredResources();
    displayResources(filtered);
    updateStats();
    updateFilterHighlight();
    updateFilterStatus();
}

// --- getFilteredResources ---
function getFilteredResources() {
    const f = {
        subject: document.getElementById('filterSubject')?.value?.toLowerCase() || '',
        grade: document.getElementById('filterGrade')?.value || '',
        competence: document.getElementById('filterCompetence')?.value || '',
        level: document.getElementById('filterLevel')?.value || '',
        tool: document.getElementById('filterTool')?.value?.toLowerCase() || '',
        favorite: document.getElementById('filterFavorite')?.value === 'true',
        topic: document.getElementById('searchTopic')?.value?.toLowerCase().trim() || ''
    };
    return resources.filter(r => {
        const topic = r.topic?.toLowerCase() || '';
        const subject = r.subject?.toLowerCase() || '';
        const grade = r.grade || '';
        const competence = r.competence || '';
        const level = r.level || '';
        const tool = r.tool?.toLowerCase() || '';
        const isFavorite = r.favorite || false;
        if (f.subject && subject !== f.subject) return false;
        if (f.grade && grade !== f.grade) return false;
        if (f.competence && competence !== f.competence) return false;
        if (f.level && level !== f.level) return false;
        if (f.tool && tool !== f.tool) return false;
        if (f.favorite && !isFavorite) return false;
        if (f.topic && !topic.includes(f.topic)) return false;
        return true;
    });
}

// --- displayResources ---
function displayResources(list) {
    const c = document.getElementById('resourcesList');
    if (!c) return;
    c.innerHTML = '';
    list.forEach((r, i) => {
        const realIndex = resources.findIndex(res =>
            res.topic === r.topic &&
            res.subject === r.subject &&
            res.grade === r.grade &&
            res.competence === r.competence &&
            (res.tool || '') === (r.tool || '') &&
            (res.description || '') === (r.description || '')
        );
        const d = document.createElement('div');
        d.className = 'resource-item';
        d.dataset.index = realIndex >= 0 ? realIndex : i;
        d.innerHTML = `
            <div class="resource-content">
                <strong>${r.topic}</strong>
                <span class="tag subject-tag" onclick="setFilterAndApply('filterSubject', '${escapeJs(r.subject)}')">${r.subject}</span>
                <span class="tag grade-tag" onclick="setFilterAndApply('filterGrade', '${escapeJs(r.grade)}')">${r.grade}</span>
                <span class="tag competence-tag" onclick="setFilterAndApply('filterCompetence', '${escapeJs(r.competence)}')">${r.competence}</span>
                <span class="tag level-tag">${r.level || '—'}</span>
               ${r.tool ? `<span class="tag tool-tag" onclick="setFilterAndApply('filterTool', '${escapeJs(r.tool.toLowerCase())}')">${escapeJs(r.tool)}</span>` : ''}
                ${r.description ? `<div class="description">${r.description}</div>` : ''}
            </div>
            <div class="action-icons">
                <div class="action-icon favorite-icon ${r.favorite ? 'active' : ''}"
                     onclick="toggleFavorite(${realIndex})">
                    <svg><use xlink:href="#star-icon"/></svg>
                </div>
                <div class="action-icon edit-icon"
                     onclick="editResource(${realIndex})">
                    <svg><use xlink:href="#edit-icon"/></svg>
                </div>
                <div class="action-icon delete-icon"
                     onclick="deleteResource(${realIndex})">
                    <svg><use xlink:href="#delete-icon"/></svg>
                </div>
            </div>`;
        c.appendChild(d);
    });
}

// --- updateStats ---
function updateStats() {
    const filtered = getFilteredResources();
    document.getElementById('statTotal').textContent = filtered.length;
    document.getElementById('statFavorites').textContent = filtered.filter(r => r.favorite).length;
    document.getElementById('statTools').textContent = [...new Set(filtered.map(r => r.tool).filter(Boolean))].length;
    document.getElementById('statSubjects').textContent = [...new Set(filtered.map(r => r.subject))].length;
    updateSubjectBarStats(filtered);
}

// --- updateSubjectBarStats ---
function updateSubjectBarStats(filtered) {
    const count = filtered.reduce((a, r) => (a[r.subject] = (a[r.subject] || 0) + 1, a), {});
    const container = document.getElementById('statsFach');
    if (!container) return;
    container.innerHTML = '';
    const max = Math.max(...Object.values(count)) || 1;
    Object.entries(count)
        .sort((a, b) => b[1] - a[1])
        .forEach(([k, v]) => {
            const div = document.createElement('div');
            div.className = 'stat-bar';
            div.innerHTML = `
                <label>${k} <span class="bar-value">${v}</span></label>
                <div class="bar-container">
                    <div class="bar" style="width:${(v / max * 100)}%"></div>
                </div>`;
            container.appendChild(div);
        });
}

// --- checkForAppUpdate ---
function checkForAppUpdate() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(reg => {
            if (reg) reg.update();
        });
    }
}

// --- registerUpdateListener ---
function registerUpdateListener() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
        });
    }
}

// === 3. DOMContentLoaded (jetzt sicher!) ===
document.addEventListener('DOMContentLoaded', () => {
    const version = targetVersion || new URL(location.href).searchParams.get('v') || '1.5.3.4';
    const versionEl = document.getElementById('versionInfo');
    if (versionEl) versionEl.textContent = `v${version} – © Matthias Kloß MPZ NB`;

    updateSchoolButton();  // ← Jetzt definiert!
    updateFilterStatus();  // ← Jetzt definiert!

    if (!dropdownsInitialized && document.getElementById('filterSubject')) {
        populateDropdowns();
        applyFilters();
        dropdownsInitialized = true;
    }
});

// === 4. UPDATE-CHECK ===
document.addEventListener('DOMContentLoaded', () => {
    registerUpdateListener();
    checkForAppUpdate();
    window.addEventListener('focus', checkForAppUpdate);
});

    function updateSubjectBarStats(filtered) {
        const count = filtered.reduce((a, r) => (a[r.subject] = (a[r.subject] || 0) + 1, a), {});
        const container = document.getElementById('statsFach');
        if (!container) return;
        container.innerHTML = '';
        const max = Math.max(...Object.values(count)) || 1;
        Object.entries(count)
            .sort((a, b) => b[1] - a[1])
            .forEach(([k, v]) => {
                const div = document.createElement('div');
                div.className = 'stat-bar';
                div.innerHTML = `
                    <label>${k} <span class="bar-value">${v}</span></label>
                    <div class="bar-container">
                        <div class="bar" style="width:${(v / max * 100)}%"></div>
                    </div>`;
                container.appendChild(div);
            });
    }

    // === EINMALIGE HILFSFUNKTION: Gefilterte Ressourcen zurückgeben ===
function getFilteredResources() {
    const f = {
        subject: document.getElementById('filterSubject')?.value?.toLowerCase() || '',
        grade: document.getElementById('filterGrade')?.value || '',
        competence: document.getElementById('filterCompetence')?.value || '',
        level: document.getElementById('filterLevel')?.value || '',
        tool: document.getElementById('filterTool')?.value?.toLowerCase() || '',
        favorite: document.getElementById('filterFavorite')?.value === 'true',
        topic: document.getElementById('searchTopic')?.value?.toLowerCase().trim() || ''
    };

    return resources.filter(r => {
        const topic = r.topic?.toLowerCase() || '';
        const subject = r.subject?.toLowerCase() || '';
        const grade = r.grade || '';
        const competence = r.competence || '';
        const level = r.level || '';
        const tool = r.tool?.toLowerCase() || '';
        const isFavorite = r.favorite || false;

        if (f.subject && subject !== f.subject) return false;
        if (f.grade && grade !== f.grade) return false;
        if (f.competence && competence !== f.competence) return false;
        if (f.level && level !== f.level) return false;
        if (f.tool && tool !== f.tool) return false;
        if (f.favorite && !isFavorite) return false;
        if (f.topic && !topic.includes(f.topic)) return false;
        return true;
    });
}

    // === FILTER & ANZEIGE ===
function applyFilters() {
    const filtered = getFilteredResources();
    displayResources(filtered);
    updateStats();
    updateFilterHighlight();
    updateFilterStatus();
}
// === FILTER-HIGHLIGHT: Färbe .filter-container bei aktivem Filter ===
function updateFilterHighlight() {
    const container = document.querySelector('.filter-container');
    if (!container) return;
    const selects = container.querySelectorAll('select');
    const search = container.querySelector('#searchTopic');
    const isActive = Array.from(selects).some(s => s.value && s.value !== '') ||
                     (search && search.value.trim() !== '');
    container.classList.toggle('active', isActive);
}

function updateFilterStatus() {
    const isFiltered = getFilteredResources().length < resources.length;
    const title = document.getElementById('filterExportTitle');
    if (title) {
        title.textContent = isFiltered ? 'Filter-Exporte (aktiv)' : 'Filter-Exporte';
        title.style.color = isFiltered ? '#e74c3c' : 'var(--primary)';
    }
    document.querySelectorAll('.filtered-export').forEach(btn => {
        btn.classList.toggle('active', isFiltered);
    });
}

// Wird bei jedem Filterwechsel aufgerufen
const originalApplyFilters = applyFilters;
window.applyFilters = function() {
    originalApplyFilters();
    updateFilterHighlight();
    updateFilterStatus();
};

    function resetFilters() {
        ['filterSubject','filterGrade','filterCompetence','filterLevel','filterTool','filterFavorite'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        const search = document.getElementById('searchTopic');
        if (search) search.value = '';
        applyFilters();
    }

function showAlert(message, callback) {
    const modal = document.createElement('div');
    modal.className = 'modal-outer';
    modal.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.6);display:flex;justify-content:center;
        align-items:center;z-index:10001;
    `;
    modal.innerHTML = `
        <div style="
            background:#fff;padding:24px;border-radius:16px;max-width:400px;
            text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.2);
        ">
            <p style="margin:0 0 16px;white-space:pre-line;line-height:1.5;">
                ${message.replace(/\n/g, '<br>')}
            </p>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button id="alert-ok-btn" 
                        style="background:#6b46c1;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">
                    OK
                </button>
                ${callback ? `
                <button id="alert-cancel-btn" 
                        style="background:#95a5a6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">
                    Abbrechen
                </button>` : ''}
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    const removeModal = () => modal.remove();

    // Jetzt mit korrekten IDs!
    modal.querySelector('#alert-ok-btn')?.addEventListener('click', () => {
        removeModal();
        if (callback) callback();
    });

    modal.querySelector('#alert-cancel-btn')?.addEventListener('click', removeModal);

    // Optional: ESC zum Abbrechen
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            removeModal();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
}

function toggleFavorite(i) {
    resources[i].favorite = !resources[i].favorite;
    localStorage.setItem('resources', JSON.stringify(resources)); // JETZT DA!
    applyFilters();
}

function displayResources(list) {
    const c = document.getElementById('resourcesList');
    if (!c) return;
    c.innerHTML = '';
    list.forEach((r, i) => {
        // SICHERER INDEX: Vergleich aller Felder
        const realIndex = resources.findIndex(res => 
            res.topic === r.topic && 
            res.subject === r.subject && 
            res.grade === r.grade && 
            res.competence === r.competence &&
            (res.tool || '') === (r.tool || '') &&
            (res.description || '') === (r.description || '')
        );

        const d = document.createElement('div');
        d.className = 'resource-item';
        d.dataset.index = realIndex >= 0 ? realIndex : i; // Fallback

        d.innerHTML = `
            <div class="resource-content">
                <strong>${r.topic}</strong>
                <span class="tag subject-tag" onclick="setFilterAndApply('filterSubject', '${escapeJs(r.subject)}')">${r.subject}</span>
                <span class="tag grade-tag" onclick="setFilterAndApply('filterGrade', '${escapeJs(r.grade)}')">${r.grade}</span>
                <span class="tag competence-tag" onclick="setFilterAndApply('filterCompetence', '${escapeJs(r.competence)}')">${r.competence}</span>
                <span class="tag level-tag">${r.level || '—'}</span>
               ${r.tool ? `<span class="tag tool-tag" onclick="setFilterAndApply('filterTool', '${escapeJs(r.tool.toLowerCase())}')">${escapeJs(r.tool)}</span>` : ''}
                ${r.description ? `<div class="description">${r.description}</div>` : ''}
                ${r.lastModified ? `<div style="font-size:11px; color:#888; margin-top:6px;">Zuletzt: ${r.lastModified}</div>` : ''}
            </div>
            <div class="action-icons">
                <div class="action-icon favorite-icon ${r.favorite ? 'active' : ''}"
                     onclick="toggleFavorite(${realIndex})">
                    <svg><use xlink:href="#star-icon"/></svg>
                </div>
                <div class="action-icon edit-icon"
                     onclick="editResource(${realIndex})">
                    <svg><use xlink:href="#edit-icon"/></svg>
                </div>
                <div class="action-icon delete-icon"
                     onclick="deleteResource(${realIndex})">
                    <svg><use xlink:href="#delete-icon"/></svg>
                </div>
            </div>`;
        c.appendChild(d);
    });
}

    // === BEARBEITEN ===
    function editResource(i) {
        const r = resources[i];
        const data = encodeURIComponent(JSON.stringify(r));
        const url = `edit-resource.html?index=${i}&data=${data}`;
        const popup = window.open(url, 'editResource', 'width=680,height=760,resizable=yes,scrollbars=yes');
        if (popup) {
            popup.focus();
        } else {
            alert('Popup wurde blockiert – bitte erlauben!');
        }
    }

function deleteResource(i) {
    const resource = resources[i];
    if (!resource) return;

    // Bestätigungs-Popup
    showAlert(
        `Möchtest du die Ressource wirklich löschen?\n\n` +
        `<strong>${resource.topic}</strong>\n` +
        `${resource.subject} | ${resource.grade} | ${resource.competence}${resource.level ? ' | ' + resource.level : ''}`,
        () => {
            // Bestätigt → Löschen mit Animation
            const anim = document.getElementById('deleteAnimation');
            anim.classList.add('delete-active');

            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBQ==');
                audio.volume = 0.2;
                audio.play();
            } catch(e) {}

            setTimeout(() => {
                resources.splice(i, 1);
                localStorage.setItem('resources', JSON.stringify(resources));
                applyFilters();
                anim.classList.remove('delete-active');
            }, 1600);
        }
    );
}

    // === AUTOCOMPLETE ===
    const searchInput = document.getElementById('searchTopic');
    const suggestions = document.getElementById('suggestions');
    if (searchInput && suggestions) {
        searchInput.oninput = e => {
            suggestions.innerHTML = '';
            const v = e.target.value.toLowerCase().trim();
            if (!v) { suggestions.style.display = 'none'; return; }
            const m = [...new Set(resources.map(r => r.topic).filter(t => t.toLowerCase().includes(v)))].slice(0, 6);
            if (!m.length) { suggestions.style.display = 'none'; return; }
            m.forEach(t => {
                const d = document.createElement('div');
                d.textContent = t;
                d.onclick = () => { searchInput.value = t; suggestions.style.display = 'none'; applyFilters(); };
                suggestions.appendChild(d);
            });
            suggestions.style.display = 'block';
        };
        document.addEventListener('click', e => {
            if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });
    }
// === CSV-PARSER (ROBUST & KORREKT) ===
function parseCSVLine(line) {
    if (!line) return [];
    const result = [];
    let field = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const next = line[i + 1];

        if (char === '"') {
            if (inQuotes && next === '"') {
                field += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(field);
            field = '';
        } else {
            field += char;
        }
    }
    result.push(field);
    return result.map(s => s.replace(/^"|"$/g, '').trim());
}

function exportTemplate() {
    const template = [
        'Thema,Unterrichtsfach,Klassenstufe,Kompetenzbereich,Niveaustufe,Digitales Hilfsmittel,Beschreibung',
        'Beispiel: Klimawandel,Geografie,Klasse 7,Analysieren und Reflektieren,Niveaustufe 3,Google Earth,"Beschreibung des Einsatzes..."'
    ].join('\n');

    const blob = new Blob(['\uFEFF' + template], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Lerndashboard_Vorlage.csv';
    link.click();
}

function applyFilters() {
    const filtered = getFilteredResources();
    displayResources(filtered);
    updateStats();                  // ← Statistiken mit gefilterten Daten
    updateFilterHighlight();        // ← Filter-Container rot
    updateFilterStatus();           // ← "Filter-Exporte (aktiv)" + Button-Puls
}

function exportCSV() {
    const filtered = getFilteredResources();
    if (filtered.length === 0) {
        showAlert("Keine gefilterten Daten zum Exportieren!\nTipp: Filter zurücksetzen oder Daten prüfen.");
        return;
    }

    const COLUMNS = ['Thema', 'Unterrichtsfach', 'Klassenstufe', 'Kompetenzbereich', 'Niveaustufe', 'Digitales_Hilfsmittel', 'Beschreibung'];
    const csvContent = filtered.map(r => [
        `"${(r.topic || '').replace(/"/g, '""')}"`,
        `"${(r.subject || '')}"`,
        `"${(r.grade || '')}"`,
        `"${(r.competence || '')}"`,
        `"${(r.level || '')}"`,
        `"${(r.tool || '').replace(/"/g, '""')}"`,
        `"${(r.description || '').replace(/"/g, '""')}"`
    ].join(',')).join('\n');

    const fullCsv = `${COLUMNS.join(',')}\n${csvContent}`;
    const blob = new Blob(['\uFEFF' + fullCsv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `LernDashboard_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
    // Nach dem Download des CSV
    showFancyAlert('CSV Export erfolgreich!', 'success');}

function exportPDF() {
    const filtered = getFilteredResources();
    if (filtered.length === 0) {
        showAlert("Keine gefilterten Daten zum Exportieren!\nTipp: Filter zurücksetzen oder Daten prüfen.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let y = 30;
    const lineHeight = 6;
    const startX = 15;
    let pageNumber = 1;

    // Schulname
    const schoolName = getSchoolName() || 'Deine Schule';
    doc.setFontSize(11);
    doc.setTextColor(schoolName === 'Deine Schule' ? 150 : 80);
    doc.setFont('helvetica', 'italic');
    doc.text(schoolName, pageWidth - 15, 15, { align: 'right' });

    // Titel
    doc.setFontSize(20);
    doc.setTextColor(107, 70, 193);
    doc.setFont('helvetica', 'bold');
    doc.text('LernDashboard Digital', pageWidth / 2, y, { align: 'center' });
    y += 8;
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text('Gefilterte Unterrichtsideen', pageWidth / 2, y, { align: 'center' });
    y += 10;
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text(`Exportiert am: ${new Date().toLocaleDateString('de-DE')}`, pageWidth - 15, y, { align: 'right' });
    y += 12;

    const addPageIfNeeded = (h) => {
        if (y + h > pageHeight - 25) {
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Seite ${pageNumber}`, pageWidth - 20, pageHeight - 10);
            doc.addPage();
            pageNumber++;
            y = 20;
            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text('LernDashboard Digital – Fortsetzung', pageWidth / 2, y, { align: 'center' });
            y += 8;
        }
    };

    const tagColors = { subject: [155,89,182], grade: [80,200,120], competence: [255,140,0], level: [0,191,255], tool: [30,144,255] };

    filtered.forEach((r, i) => {
        const topic = r.topic || '—';
        const subject = r.subject || '—';
        const grade = r.grade || '—';
        const competence = r.competence || '—';
        const level = r.level || '—';
        const tool = r.tool || '—';
        const description = r.description || '';

        doc.setFontSize(11);
        doc.setTextColor(0);
        doc.setFont('helvetica', 'bold');
        const topicLines = doc.splitTextToSize(`${i + 1}. ${topic}`, pageWidth - 30);
        addPageIfNeeded(topicLines.length * lineHeight + 5);
        doc.text(topicLines, startX, y);
        y += topicLines.length * lineHeight + 3;

        let x = startX;
        const tagHeight = 5, tagPadding = 2, tagGap = 6, textY = y - 0.7;
        const tags = [{text:subject,type:'subject'},{text:grade,type:'grade'},{text:competence,type:'competence'},{text:level,type:'level'},{text:tool,type:'tool'}];
        doc.setFontSize(8.5);
        doc.setFont('helvetica', 'normal');
        tags.forEach(tag => {
            if (tag.text === '—') return;
            const color = tagColors[tag.type];
            const textWidth = doc.getTextWidth(tag.text);
            const tagWidth = textWidth + 2 * tagPadding;
            doc.setFillColor(...color);
            doc.roundedRect(x, y - tagHeight + 0.8, tagWidth, tagHeight, 1.8, 1.8, 'F');
            doc.setTextColor(255);
            doc.text(tag.text, x + tagPadding, textY);
            x += tagWidth + tagGap;
        });
        y += 6;

        if (description) {
            doc.setFontSize(9);
            doc.setTextColor(70);
            doc.setFont('helvetica', 'italic');
            const descLines = doc.splitTextToSize(description, pageWidth - 30);
            const descHeight = descLines.length * lineHeight;
            addPageIfNeeded(descHeight + 8);
            doc.setFillColor(248, 250, 252);
            doc.rect(startX - 1, y - 1.5, pageWidth - 30 + 2, descHeight + 3, 'F');
            doc.text(descLines, startX, y + lineHeight - 1);
            y += descHeight + 6;
        } else y += 4;

        doc.setDrawColor(220);
        doc.setLineWidth(0.3);
        doc.line(startX, y, pageWidth - 15, y);
        y += 8;
    });

    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(`Seite ${pageNumber}`, pageWidth - 20, pageHeight - 10);
    doc.save(`LernDashboard_${new Date().toISOString().slice(0, 10)}.pdf`);
    showFancyAlert('PDF Export erfolgreich!', 'success');
}

// === BEARB. BESTÄTIGUNG (ohne Ton) ===
function showEditConfirmation() {
    const anim = document.getElementById('editAnimation');
    anim.classList.add('edit-active');

    // Nach 1,6 Sekunden automatisch ausblenden
    setTimeout(() => {
        anim.classList.remove('edit-active');
    }, 1600);
}
        // === HINZUFÜGEN BESTÄTIGUNG ===
function showAddConfirmation() {
    const anim = document.getElementById('addAnimation');
    anim.classList.add('add-active');
    setTimeout(() => anim.classList.remove('add-active'), 1600);
}
    // === INIT ===
    ['filterSubject','filterGrade','filterTool','filterCompetence','filterLevel','filterFavorite'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', applyFilters);
    });
    const searchEl = document.getElementById('searchTopic');
    if (searchEl) searchEl.addEventListener('input', applyFilters);

if (!navigator.onLine) {
    showAlert('Offline-Modus aktiv – Änderungen werden lokal gespeichert.');
}

window.addEventListener('online', () => {
    showAlert('Internetverbindung wiederhergestellt.');
});
window.addEventListener('offline', () => {
    showAlert('Offline-Modus aktiv – Änderungen werden lokal gespeichert.');
});
    populateDropdowns();
    applyFilters();

// === POPUP-KOMMUNIKATION (NEU + UPDATE) ===
window.addEventListener('message', function(event) {
    // NEUE RESSOURCE HINZUFÜGEN
    if (event.data?.action === 'addResource') {
        const resource = event.data.resource;
        if (resource && resource.topic && resource.subject && resource.grade && resource.competence && resource.level) {
            // Tool: Originalgroßschreibung beibehalten, nur für Filter klein
            const originalTool = resource.tool?.trim();
            if (originalTool) {
                resource.tool = originalTool;
                tools.add(originalTool.toLowerCase());
            }
            resources.push(resource);
            localStorage.setItem('resources', JSON.stringify(resources));
            applyFilters();
            updateToolFilter();
            showAddConfirmation();
        }
    }
    // RESSOURCE AKTUALISIEREN
    else if (event.data?.action === 'updateResource') {
        const { index, resource } = event.data;
        if (index >= 0 && index < resources.length && resource) {
            const originalTool = resource.tool?.trim();
            if (originalTool) {
                resource.tool = originalTool;
                tools.add(originalTool.toLowerCase());
            }
            resources[index] = resource;
            localStorage.setItem('resources', JSON.stringify(resources));
            applyFilters();
            updateToolFilter();
            showEditConfirmation();
        }
    }
});

// === CHROME TOOLTIP-FIX BEIM DRUCKEN ===
let printTooltipFix = false;
window.addEventListener('beforeprint', () => {
    printTooltipFix = true;  // Flag setzen
    // Sofort Tooltips ausblenden
    document.querySelectorAll('.btn[title]').forEach(btn => {
        btn.blur();  // Hover "abbrechen"
    });
});

window.addEventListener('afterprint', () => {
    printTooltipFix = false;
    // Tooltip-Container leeren (falls sichtbar)
    document.querySelectorAll('::after, ::before').forEach(el => el.remove());  // Fallback-Cleanup
    // Oder: Hover manuell zurücksetzen
    document.body.style.cursor = 'default';
});

  function openNewResourceWindow() {
    const url = 'new-resource.html';
    const popup = window.open(url, 'newResource', 'width=680,height=760,resizable=yes,scrollbars=yes');
    if (popup) {
        popup.focus();
    } else {
        alert('Popup wurde blockiert – bitte erlauben!');
    }
}
function exportMatrixCSV() {
    const subjectFilter = document.getElementById('filterSubject')?.value?.trim() || '';
    const gradeFilter = document.getElementById('filterGrade')?.value?.trim() || '';
    const toolFilter = document.getElementById('filterTool')?.value?.trim().toLowerCase() || '';

    // === DYNAMISCHE ÜBERSCHRIFT (mit | und "Alle Klassen") ===
    const subjectText = subjectFilter ? subjectFilter : 'Alle Fächer';
    let gradeText = '';
    if (gradeFilter) {
        gradeText = gradeFilter;
    } else {
        gradeText = 'Alle Klassen';
    }
    const toolText = toolFilter ? ` | Tool: ${toolFilter}` : '';
    const title = `${subjectText} | ${gradeText}${toolText}`;

    const competences = [
        "Suchen, Verarbeiten und Aufbewahren",
        "Kommunizieren und Kooperieren",
        "Produzieren und Präsentieren",
        "Schützen und sicher Agieren",
        "Problemlösen und Handeln",
        "Analysieren und Reflektieren"
    ];
    const levels = ["Niveaustufe 1", "Niveaustufe 2", "Niveaustufe 3", "Niveaustufe 4", "Niveaustufe 5"];

    // === FARBMAPS FÜR NIVEAUSTUFEN (GRÜN → ROT) ===
const levelColors = {
    'Niveaustufe 1': 'FF32CD32', // Dunkelgrün
    'Niveaustufe 2': 'FF228B22', // Hellgrün
    'Niveaustufe 3': 'FFFFFF00', // Gelb
    'Niveaustufe 4': 'FFFFA500', // Orange
    'Niveaustufe 5': 'FF8B0000'  // Dunkelrot
};
    // === DATEN FÜR MATRIX (nur Fach, Klasse, Tool filtern) ===
    const matrix = {};
    competences.forEach(c => {
        matrix[c] = {};
        levels.forEach(l => matrix[c][l] = new Set());
    });

    // Gehe durch ALLE Ressourcen
    resources.forEach(r => {
        const subject = r.subject?.trim();
        const grade = r.grade?.trim();
        const tool = r.tool?.trim().toLowerCase();
        const comp = r.competence?.trim();
        const level = r.level?.trim();
        const topic = r.topic?.trim();

        if (!comp || !level || !topic) return;

        // Filterprüfung
        const matchesSubject = !subjectFilter || subject === subjectFilter;
        const matchesGrade = !gradeFilter || grade === gradeFilter;
        const matchesTool = !toolFilter || tool === toolFilter;

        if (matchesSubject && matchesGrade && matchesTool) {
            const entry = `${topic} (${grade}${r.tool ? ` – ${r.tool}` : ''})`;
            matrix[comp][level].add(entry);
        }
    });

    // === CSV GENERIEREN ===
    let csv = '\uFEFF'; // UTF-8 BOM
    csv += `"Titel: ${title}"\n\n`; // Dynamische Überschrift
    csv += '"Kompetenz";' + levels.map(l => `"${l}"`).join(';') + '\n';

    competences.forEach(comp => {
        let row = [`"${comp}"`];
        levels.forEach(level => {
            const entries = [...matrix[comp][level]];
            const cell = entries.length > 0 ? entries.join('\n') : '—';
            row.push(`"${cell}"`);
        });
        csv += row.join(';') + '\n';
    });

    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `LernDashboard_Matrix_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
    // Nach: link.click();
    showFancyAlert('Matrix CSV Export erfolgreich!', 'success');
}
// ──────────────────────────────────────────────────────────────
//  MATRIX → PDF 
// ──────────────────────────────────────────────────────────────
async function exportMatrixPDF() {
    const filtered = getFilteredResources();
    if (filtered.length === 0) {
        showAlert('Keine Daten für Matrix verfügbar!');
        return;
    }

    if (!window.jspdfLoaded) {
        showFancyAlert('jsPDF wird geladen...', 'info');
        await new Promise((resolve, reject) => {
            if (window.jspdf) {
                resolve();
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script.onload = () => {
                const autoScript = document.createElement('script');
                autoScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
                autoScript.onload = () => {
                    window.jspdfLoaded = true;
                    resolve();
                };
                autoScript.onerror = reject;
                document.head.appendChild(autoScript);
            };
            script.onerror = reject;
            document.head.appendChild(script);
        }).catch(err => {
            console.error('jsPDF Laden fehlgeschlagen:', err);
            showAlert('PDF-Bibliothek konnte nicht geladen werden. Bitte Seite neu laden.');
            return;
        });
    }

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const leftMargin = 12;
        const rightMargin = 12;
        const topMargin = 18;
        const usableWidth = pageWidth - leftMargin - rightMargin;
        const compColWidth = usableWidth * 0.22;
        const levelColWidth = (usableWidth - compColWidth) / 5;
        let currentY = topMargin;

        // Titel
        const subjectFilter = document.getElementById('filterSubject')?.value?.trim() || '';
        const gradeFilter = document.getElementById('filterGrade')?.value?.trim() || '';
        const toolFilter = document.getElementById('filterTool')?.value?.trim().toLowerCase() || '';
        const subjectText = subjectFilter ? subjectFilter : 'Alle Fächer';
        const gradeText = gradeFilter ? gradeFilter : 'Alle Klassen';
        const toolText = toolFilter ? ` | Tool: ${toolFilter}` : '';
        const title = `${subjectText} | ${gradeText}${toolText}`;
        doc.setFontSize(16);
        doc.setTextColor(107, 70, 193);
        doc.setFont('helvetica', 'bold');
        doc.text(title, pageWidth / 2, currentY, { align: 'center' });
        currentY += 7;

        // Schulname & Datum
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.setFont('helvetica', 'italic');
        const schoolName = localStorage.getItem('schoolName') || 'Deine Schule';
        doc.text(schoolName, leftMargin, currentY - 8);
        doc.text(`Export: ${new Date().toLocaleDateString('de-DE')}`, pageWidth - rightMargin, currentY - 8, { align: 'right' });
        currentY += 5;

        // Daten aufbauen
        const competences = [
            "Suchen, Verarbeiten und Aufbewahren",
            "Kommunizieren und Kooperieren",
            "Produzieren und Präsentieren",
            "Schützen und sicher Agieren",
            "Problemlösen und Handeln",
            "Analysieren und Reflektieren"
        ];
        const levels = ["Niveaustufe 1","Niveaustufe 2","Niveaustufe 3","Niveaustufe 4","Niveaustufe 5"];
        const levelColors = [
            [76,175,80],[139,195,74],[255,193,7],[255,152,0],[244,67,54]
        ];
        const matrix = {};
        competences.forEach(c => {
            matrix[c] = {};
            levels.forEach(l => matrix[c][l] = []);
        });
        resources.forEach(r => {
            const s = r.subject?.trim();
            const g = r.grade?.trim();
            const t = r.tool?.trim().toLowerCase();
            const c = r.competence?.trim();
            const l = r.level?.trim();
            const topic = r.topic?.trim();
            if (!c || !l || !topic) return;
            const match = (!subjectFilter || s === subjectFilter) &&
                          (!gradeFilter || g === gradeFilter) &&
                          (!toolFilter || t === toolFilter);
            if (match) {
                matrix[c][l].push(`${topic}\nKlasse ${g}${r.tool ? ` – ${r.tool}` : ''}`);
            }
        });

        // Hilfsfunktionen
        const drawLine = (x1,y1,x2,y2) => {
            doc.setDrawColor(180);
            doc.setLineWidth(0.25);
            doc.line(x1,y1,x2,y2);
        };
        const drawHeader = y => {
            const h = 11;
            let x = leftMargin;
            doc.setFillColor(107,70,193);
            doc.rect(x, y, compColWidth, h, 'F');
            doc.setTextColor(255);
            doc.setFontSize(10);
            doc.setFont('helvetica','bold');
            doc.text('Kompetenz', x+4, y+7.5);
            x += compColWidth;
            levels.forEach((lvl,i) => {
                doc.setFillColor(...levelColors[i]);
                doc.rect(x, y, levelColWidth, h, 'F');
                doc.setTextColor(255);
                const lines = doc.splitTextToSize(lvl, levelColWidth-8);
                const lineH = 3.8;
                const startY = y + (h - lines.length*lineH)/2 + lineH;
                doc.text(lines, x + levelColWidth/2, startY, {align:'center'});
                x += levelColWidth;
            });
            doc.setDrawColor(120);
            doc.setLineWidth(0.5);
            doc.line(leftMargin, y+h, pageWidth-rightMargin, y+h);
            return y + h;
        };
        const drawCenteredText = (lines, x, y, w, h, lineH, bold=false) => {
            const totalH = lines.length * lineH;
            const startY = y + (h - totalH)/2 + lineH*0.7;
            doc.setFont('helvetica', bold?'bold':'normal');
            doc.text(lines, x+4, startY);
        };

        // Header zeichnen
        let headerBottom = drawHeader(currentY);
        currentY = headerBottom;

        // Zeilen zeichnen
        const COMP_FS = 9.5, LEVEL_FS = 8.0;
        const LH_COMP = COMP_FS * 1.2 * 0.3528;
        const LH_LEVEL = LEVEL_FS * 1.2 * 0.3528;
        const MIN_ROW_H = 16;
        competences.forEach(comp => {
            const compLines = doc.splitTextToSize(comp, compColWidth-8);
            const compH = compLines.length * LH_COMP;
            let maxLevelH = 0;
            levels.forEach(l => {
                const raw = matrix[comp][l].length ? matrix[comp][l].join('\n\n') : '—';
                const lines = doc.splitTextToSize(raw, levelColWidth-8);
                const h = lines.length * LH_LEVEL;
                if (h > maxLevelH) maxLevelH = h;
            });
            const rowH = Math.max(MIN_ROW_H, Math.max(compH, maxLevelH) + 8);
            if (currentY + rowH > pageHeight - 20) {
                drawLine(leftMargin, headerBottom-3, leftMargin, currentY);
                drawLine(pageWidth-rightMargin, headerBottom-3, pageWidth-rightMargin, currentY);
                doc.addPage();
                currentY = topMargin;
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Fortsetzung – Seite ${doc.getCurrentPageInfo().pageNumber}`, pageWidth - rightMargin, currentY, {align:'right'});
                currentY += 8;
                headerBottom = drawHeader(currentY);
                currentY = headerBottom;
            }
            const rowY = currentY;
            let x = leftMargin;
            doc.setFillColor(248,249,255);
            doc.rect(x, rowY, compColWidth, rowH, 'F');
            doc.setTextColor(0);
            doc.setFontSize(COMP_FS);
            drawCenteredText(compLines, x, rowY, compColWidth, rowH, LH_COMP, true);
            drawLine(x+compColWidth, rowY, x+compColWidth, rowY+rowH);
            x += compColWidth;
            levels.forEach((lvl, j) => {
                const raw = matrix[comp][lvl].length ? matrix[comp][lvl].join('\n\n') : '—';
                const lines = doc.splitTextToSize(raw, levelColWidth-8);
                doc.setFillColor(255,255,255);
                doc.rect(x, rowY, levelColWidth, rowH, 'F');
                doc.setTextColor(60);
                doc.setFontSize(LEVEL_FS);
                drawCenteredText(lines, x, rowY, levelColWidth, rowH, LH_LEVEL);
                if (j < 4) drawLine(x+levelColWidth, rowY, x+levelColWidth, rowY+rowH);
                x += levelColWidth;
            });
            drawLine(leftMargin, rowY+rowH, pageWidth-rightMargin, rowY+rowH);
            currentY += rowH;
        });

        // Abschlusslinien
        drawLine(leftMargin, headerBottom-3, leftMargin, currentY);
        drawLine(pageWidth-rightMargin, headerBottom-3, pageWidth-rightMargin, currentY);
        const totalPages = doc.getNumberOfPages();
        for (let i=1; i<=totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text(`Seite ${i}`, pageWidth-rightMargin, pageHeight-8, {align:'right'});
        }

        doc.save(`LernDashboard_Matrix_${new Date().toISOString().slice(0,10)}.pdf`);
        showFancyAlert('PDF erfolgreich erstellt!', 'success');
    } catch (err) {
        console.error('PDF-Erstellung fehlgeschlagen:', err);
        showAlert('Fehler beim Erstellen der PDF. Bitte Seite neu laden und erneut versuchen.');
    }
}
function exportMatrixExcel() {
    const filtered = getFilteredResources();
    if (filtered.length === 0) {
        showFancyAlert('Keine Daten für die Matrix!', 'warning');
        return;
    }

    const competences = [
        "Suchen, Verarbeiten und Aufbewahren",
        "Kommunizieren und Kooperieren",
        "Produzieren und Präsentieren",
        "Schützen und sicher Agieren",
        "Problemlösen und Handeln",
        "Analysieren und Reflektieren"
    ];
    const levels = ["Niveaustufe 1", "Niveaustufe 2", "Niveaustufe 3", "Niveaustufe 4", "Niveaustufe 5"];

    // === FARBEN ===
    const levelColors = {
        'Niveaustufe 1': 'FF4CAF50',
        'Niveaustufe 2': 'FF8BC34A',
        'Niveaustufe 3': 'FFFFC107',
        'Niveaustufe 4': 'FFFF9800',
        'Niveaustufe 5': 'FFF44336'
    };
    const headerColor = 'FF6B46C1';
    const contentColor = 'FFF8F9FA';

    // === FILTER-INFO ===
    const subjectFilter = document.getElementById('filterSubject')?.value || 'Alle Fächer';
    const gradeFilter = document.getElementById('filterGrade')?.value || 'Alle Klassen';
    const competenceFilter = document.getElementById('filterCompetence')?.value || '';
    const levelFilter = document.getElementById('filterLevel')?.value || '';
    const toolFilter = document.getElementById('filterTool')?.value || '';
    let filterParts = [subjectFilter, gradeFilter];
    if (competenceFilter) filterParts.push(competenceFilter);
    if (levelFilter) filterParts.push(levelFilter);
    if (toolFilter) filterParts.push(`Tool: ${toolFilter}`);
    const filterText = filterParts.join(' | ');

    // === SCHULNAME & DATUM ===
    const schoolName = localStorage.getItem('schoolName') || 'Deine Schule';
    const exportDate = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });

    // === Matrix aufbauen ===
    const matrix = {};
    competences.forEach(c => matrix[c] = {});
    levels.forEach(l => competences.forEach(c => matrix[c][l] = []));
    filtered.forEach(r => {
        if (r.competence && r.level && matrix[r.competence][r.level]) {
            const entry = `${r.topic} (${[r.subject, r.grade, r.tool].filter(Boolean).join(', ')})`;
            const desc = r.description ? `: ${r.description}` : '';
            matrix[r.competence][r.level].push(entry + desc);
        }
    });

    // === Workbook ===
    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet('Kompetenzmatrix');

    // === KOPFZEILE ===
    const headerTopRow = sheet.addRow(['', '', '', '', '', '']);
    headerTopRow.height = 35;
    const schoolCell = headerTopRow.getCell(1);
    schoolCell.value = schoolName;
    schoolCell.font = { bold: true, size: 14, color: { argb: headerColor } };
    schoolCell.alignment = { horizontal: 'left', vertical: 'middle' };
    schoolCell.border = { top: { style: 'thin', color: { argb: 'FFCCCCCC' } }, left: { style: 'thin', color: { argb: 'FFCCCCCC' } }, bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } }, right: { style: 'thin', color: { argb: 'FFCCCCCC' } } };

    sheet.mergeCells('B1:E1');
    const filterCell = sheet.getCell('B1');
    filterCell.value = filterText;
    filterCell.font = { bold: true, size: 14, color: { argb: headerColor } };
    filterCell.alignment = { horizontal: 'center', vertical: 'middle' };
    filterCell.border = { top: { style: 'thin', color: { argb: 'FFCCCCCC' } }, left: { style: 'thin', color: { argb: 'FFCCCCCC' } }, bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } }, right: { style: 'thin', color: { argb: 'FFCCCCCC' } } };

    const dateCell = headerTopRow.getCell(6);
    dateCell.value = `Export: ${exportDate}`;
    dateCell.font = { size: 12, color: { argb: 'FF666666' } };
    dateCell.alignment = { horizontal: 'right', vertical: 'middle' };
    dateCell.border = { top: { style: 'thin', color: { argb: 'FFCCCCCC' } }, left: { style: 'thin', color: { argb: 'FFCCCCCC' } }, bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } }, right: { style: 'thin', color: { argb: 'FFCCCCCC' } } };

    sheet.addRow([]);
    const headerRow = sheet.addRow(['Kompetenzbereich', ...levels]);
    headerRow.eachCell((cell, colNumber) => {
        let fillColor = colNumber === 1 ? headerColor : levelColors[levels[colNumber - 2]];
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        cell.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
        cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
        cell.border = { top: { style: 'thin', color: { argb: 'FFCCCCCC' } }, left: { style: 'thin', color: { argb: 'FFCCCCCC' } }, bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } }, right: { style: 'thin', color: { argb: 'FFCCCCCC' } } };
    });
    headerRow.height = 45;

    competences.forEach(comp => {
        const rowValues = [comp, ...levels.map(l => matrix[comp][l].join('\n\n') || '–')];
        const row = sheet.addRow(rowValues);
        const compCell = row.getCell(1);
        compCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: headerColor } };
        compCell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        compCell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
        compCell.border = { top: { style: 'thin', color: { argb: 'FFCCCCCC' } }, left: { style: 'thin', color: { argb: 'FFCCCCCC' } }, bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } }, right: { style: 'thin', color: { argb: 'FFCCCCCC' } } };

        row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
            if (colNumber > 1) {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: contentColor } };
                cell.alignment = { vertical: 'top', horizontal: 'left', wrapText: true };
                if (cell.value && cell.value !== '–') cell.value = '\n' + cell.value + '\n';
                if (cell.value === '–') cell.font = { color: { argb: 'FF999999' }, italic: true };
                cell.border = { top: { style: 'thin', color: { argb: 'FFCCCCCC' } }, left: { style: 'thin', color: { argb: 'FFCCCCCC' } }, bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } }, right: { style: 'thin', color: { argb: 'FFCCCCCC' } } };
            }
        });

        let maxLines = 1;
        row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
            if (colNumber > 1 && cell.value) {
                const lines = (cell.value.toString().match(/\n/g) || []).length + 1;
                if (lines > maxLines) maxLines = lines;
            }
        });
        row.height = Math.max(70, maxLines * 22);
    });

    sheet.columns = [{ width: 36 }, { width: 44 }, { width: 44 }, { width: 44 }, { width: 44 }, { width: 44 }];

    // === EXPORT MIT BESTÄTIGUNG ===
    workbook.xlsx.writeBuffer().then(buffer => {
        const blob = new Blob([buffer], { type: 'application/octet-stream' });
        saveAs(blob, `Kompetenzmatrix_${new Date().toISOString().slice(0,10)}.xlsx`);
        showFancyAlert('Excel-Matrix erfolgreich erstellt!', 'success');
    }).catch(err => {
        console.error("Export-Fehler:", err);
        showFancyAlert('Export fehlgeschlagen!', 'error');
    });
}
// === Hilfsfunktion: Base64 → Blob ===
function base64ToBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    return new Blob(byteArrays, { type: contentType });
}
// === Hilfsfunktion: Base64 → Blob ===
function base64ToBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    return new Blob(byteArrays, { type: contentType });
}

// === BACKUP MIT MODAL + AUTOMATISCHER DOWNLOAD ===
function autoBackup() {
    const allResources = JSON.parse(localStorage.getItem('resources') || '[]');
    
    if (allResources.length === 0) {
        showFancyAlert('Keine Daten zum Sichern!', 'warning');
        return;
    }

    // Modal erstellen (unverändert)
    const modal = document.createElement('div');
    modal.style.cssText = `
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.6); backdrop-filter:blur(8px);
        display:flex; justify-content:center; align-items:center;
        z-index:20000; font-family:Segoe UI,sans-serif;
    `;
    modal.innerHTML = `
        <div style="
            background:var(--card); padding:32px; border-radius:20px; text-align:center;
            width:90%; max-width:420px; box-shadow:0 16px 48px rgba(0,0,0,0.3);
            transform:scale(0.9); opacity:0;
            transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s ease;
        ">
            <div id="backupIcon" style="width:80px; height:80px; margin:0 auto 20px;">
                <svg width="80" height="80" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="4"/>
                    <circle id="backupCircle" cx="50" cy="50" r="44" fill="none" stroke="#6b46c1" stroke-width="4"
                            stroke-dasharray="276.46" stroke-dashoffset="276.46"
                            style="transition:stroke-dashoffset 1s ease;"/>
                    <path id="backupCheck" d="M30 50 L45 65 L70 35" fill="none" stroke="#27ae60" stroke-width="6"
                          stroke-linecap="round" stroke-linejoin="round"
                          style="stroke-dasharray:100; stroke-dashoffset:100;"/>
                </svg>
            </div>
            <p id="backupTitle" style="font-size:19px; font-weight:700; color:var(--text); margin:0 0 8px;">
                Backup wird erstellt...
            </p>
            <p id="backupSubtitle" style="font-size:14px; color:var(--text-light); margin:0;">
                ${allResources.length} Ressourcen werden gesichert
            </p>
            <div style="margin-top:20px; height:6px; background:#e0e0e0; border-radius:3px; overflow:hidden;">
                <div id="backupProgress" style="width:0%; height:100%; background:#6b46c1; border-radius:3px; transition:width 0.8s ease;"></div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // Animation: Modal einblenden (unverändert)
    requestAnimationFrame(() => {
        modal.querySelector('div').style.transform = 'scale(1)';
        modal.querySelector('div').style.opacity = '1';
    });

    // Fortschritt simulieren (unverändert)
    const progress = modal.querySelector('#backupProgress');
    const circle = modal.querySelector('#backupCircle');
    const title = modal.querySelector('#backupTitle');
    const subtitle = modal.querySelector('#backupSubtitle');
    const check = modal.querySelector('#backupCheck');

    setTimeout(() => {
        progress.style.width = '100%';
        circle.style.strokeDashoffset = '0';
    }, 100);

    // CSV generieren & downloaden – FRÜHER AUSLÖSEN (nach 300ms, während Animation läuft)
    setTimeout(() => {
        const headers = ['Thema','Unterrichtsfach','Klassenstufe','Kompetenzbereich','Niveaustufe','Digitales_Hilfsmittel','Beschreibung'];
        const csv = [
            headers.join(','),
            ...allResources.map(r => [
                `"${(r.topic||'').replace(/"/g,'""')}"`,
                `"${r.subject||''}"`,
                `"${r.grade||''}"`,
                `"${r.competence||''}"`,
                `"${r.level||''}"`,
                `"${(r.tool||'').replace(/"/g,'""')}"`,
                `"${(r.description||'').replace(/"/g,'""')}"`
            ].join(','))
        ].join('\n');

        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `LernDashboard_Backup_${new Date().toISOString().slice(0,10)}.csv`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Erfolg anzeigen (unverändert)
        title.textContent = 'Backup erfolgreich!';
        title.style.color = '#27ae60';
        subtitle.textContent = 'Datei wird heruntergeladen...';
        check.style.strokeDashoffset = '0';
        check.style.animation = 'draw 0.6s ease forwards';

        // Modal nach 1,5 Sek schließen (unverändert)
        setTimeout(() => {
            modal.style.opacity = '0';
            setTimeout(() => modal.remove(), 400);
        }, 1500);
    }, 300);  // ← Hier früher: 300ms statt 1000ms
}

// Hilfsfunktion: HTML escapen (sicherer für Inhalte)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function printOptimized() {
    const schoolName = localStorage.getItem('schoolName') || 'Deine Schule';
    const allResources = resources;

    if (allResources.length === 0) {
        showFancyAlert('Keine Ressourcen zum Drucken.', 'warning');
        return;
    }

    // --- Statistik berechnen ---
    const subjectCount = allResources.reduce((a, r) => {
        const s = r.subject || 'Unbekannt';
        a[s] = (a[s] || 0) + 1;
        return a;
    }, {});

    const uniqueTools = new Set(allResources.map(r => r.tool).filter(Boolean)).size;
    const favorites = allResources.filter(r => r.favorite).length;

    // --- HTML generieren ---
    let printHtml = `
        <div class="print-content" style="
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 12mm 10mm;
            line-height: 1.35;
            font-size: 10.5pt;
            color: #000;
        ">
            <h1 style="
                text-align: center;
                color: #6b46c1;
                margin: 0 0 8mm;
                font-size: 16pt;
                font-weight: 700;
            ">
                LernDashboard Digital – Alle Ressourcen
            </h1>
            <p style="
                text-align: center;
                color: #555;
                margin: 0 0 12mm;
                font-size: 10pt;
            ">
                Schule: <strong>${escapeHtml(schoolName)}</strong> | 
                Exportiert: ${new Date().toLocaleDateString('de-DE')}
            </p>
    `;

    allResources.forEach((r, i) => {
        printHtml += `
            <div class="print-resource" style="
                margin-bottom: 5mm;
                padding-bottom: 4mm;
                border-bottom: 1px solid #ddd;
                page-break-inside: auto;
                break-inside: auto;
            ">
                <h3 style="
                    margin: 0 0 1.5mm;
                    color: #6b46c1;
                    font-size: 11.5pt;
                    font-weight: 600;
                ">
                    ${i + 1}. ${escapeHtml(r.topic || '–')}
                </h3>
                <p style="
                    margin: 1mm 0;
                    font-size: 10pt;
                    line-height: 1.25;
                    color: #333;
                ">
                    <strong>Fach:</strong> ${escapeHtml(r.subject || '–')} | 
                    <strong>Klasse:</strong> ${escapeHtml(r.grade || '–')} | 
                    <strong>Kompetenz:</strong> ${escapeHtml(r.competence || '–')}
                </p>
                <p style="
                    margin: 1mm 0;
                    font-size: 10pt;
                    line-height: 1.25;
                    color: #333;
                ">
                    <strong>Niveau:</strong> ${escapeHtml(r.level || '–')} | 
                    <strong>Tool:</strong> ${escapeHtml(r.tool || '–')}
                </p>
                ${r.description ? `
                <div style="
                    margin: 2mm 0 0;
                    padding: 2mm 6mm;
                    background: #f9f9f9;
                    border-left: 3px solid #6b46c1;
                    font-size: 10pt;
                    line-height: 1.3;
                    border-radius: 0 5px 5px 0;
                    display: inline-block;
                    max-width: 100%;
                    box-sizing: border-box;
                ">
                    ${escapeHtml(r.description)}
                </div>` : ''}
            </div>
        `;
    });

    // --- Statistik ---
    printHtml += `
        <div class="print-stats" style="
            margin-top: 12mm;
            padding-top: 8mm;
            border-top: 2px solid #6b46c1;
            page-break-before: avoid;
        ">
            <h2 style="
                color: #6b46c1;
                margin: 0 0 5mm;
                font-size: 13pt;
                font-weight: 600;
            ">Statistik</h2>
            <div style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 3mm 8mm;
                font-size: 10pt;
                margin-bottom: 6mm;
            ">
                <div><strong>Gesamt:</strong> ${allResources.length} Ressourcen</div>
                <div><strong>Favoriten:</strong> ${favorites}</div>
                <div><strong>Tools:</strong> ${uniqueTools}</div>
                <div><strong>Fächer:</strong> ${Object.keys(subjectCount).length}</div>
            </div>
            <p style="margin: 0 0 3mm; font-size: 10pt;"><strong>Nach Fächern:</strong></p>
            <ul style="
                columns: 2;
                column-gap: 10mm;
                margin: 0;
                padding-left: 12mm;
                font-size: 9.5pt;
                line-height: 1.25;
            ">
    `;

    Object.entries(subjectCount)
        .sort((a, b) => b[1] - a[1])
        .forEach(([subj, count]) => {
            printHtml += `<li><strong>${escapeHtml(subj)}:</strong> ${count}</li>`;
        });

    printHtml += `</ul></div></div>`;

    // --- In .main einfügen ---
    const mainContainer = document.querySelector('.main');
    const originalMain = mainContainer.innerHTML;

    mainContainer.innerHTML = printHtml;

    // --- Drucken ---
    window.print();

    // --- Zurücksetzen ---
    setTimeout(() => {
        mainContainer.innerHTML = originalMain;
    }, 500);
}

// === CSV IMPORT – 100% SICHER & MIT DEBUG ===
function importCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const csv = e.target.result;
        if (!csv.trim()) {
            showAlert('CSV-Datei ist leer!');
            return;
        }
        showImportPreview(csv);
    };
    reader.readAsText(file, 'UTF-8');
    event.target.value = '';
}

// Vorschau-Popup
function showImportPreview(csvString) {
    const lines = csvString.split('\n').map(l => l.trim()).filter(l => l);
    if (lines.length < 1) {
        showAlert('Keine Daten in der CSV gefunden.');
        return;
    }

    const headers = parseCSVLine(lines[0]);
    const data = [];

    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((h, idx) => row[h] = (values[idx] || '').trim());
        if (row['Thema']) data.push(row);
    }

    if (data.length === 0) {
        showAlert('Keine gültigen Einträge mit "Thema" gefunden.');
        return;
    }

    // Vorschau-Tabelle
    let previewHtml = `<div style="max-height:300px;overflow-y:auto;margin:10px 0;"><table style="width:100%;border-collapse:collapse;font-size:13px;">`;
    previewHtml += `<tr style="background:#6b46c1;color:white;"><th style="padding:6px;">${headers.slice(0, 5).join('</th><th style="padding:6px;">')}</th></tr>`;
    data.slice(0, 5).forEach(row => {
        previewHtml += `<tr style="border-bottom:1px solid #eee;"><td style="padding:6px;">${Object.values(row).slice(0, 5).map(escapeHtml).join('</td><td style="padding:6px;">')}</td></tr>`;
    });
    if (data.length > 5) previewHtml += `<tr><td colspan="5" style="text-align:center;color:#666;padding:6px;font-style:italic;">... und ${data.length - 5} weitere</td></tr>`;
    previewHtml += `</table></div>`;

    const modal = document.createElement('div');
    modal.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);display:flex;justify-content:center;align-items:center;z-index:20000;`;
    modal.innerHTML = `
        <div style="background:var(--card);padding:24px;border-radius:16px;max-width:90%;width:600px;box-shadow:0 16px 48px rgba(0,0,0,0.3);">
            <h3 style="margin:0 0 12px;color:var(--text);font-size:18px;">Import-Vorschau</h3>
            <p style="margin:0 0 12px;color:var(--text-light);font-size:14px;">${data.length} Ressourcen gefunden</p>
            ${previewHtml}
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
                <button onclick="this.closest('[style*=\'fixed\']').remove()" style="padding:8px 16px;border:1px solid #ccc;border-radius:8px;background:#f0f0f0;cursor:pointer;">Abbrechen</button>
                <button id="confirmImportBtn" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Importieren</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('#confirmImportBtn').onclick = () => {
        modal.remove();
        performImport(data);
    };
}
function performImport(data) {
    let imported = 0;
    let duplicates = 0;

    data.forEach(entry => {
        const thema = entry['Thema']?.trim();
        const fach = entry['Unterrichtsfach'] || '';
        const klasse = entry['Klassenstufe'] || '';
        const tool = entry['Digitales_Hilfsmittel'] || '';

        const exists = resources.some(r =>
            r.topic === thema && r.subject === fach && r.grade === klasse && r.tool === tool
        );

        if (!exists && thema) {
            resources.push({
                topic: thema,
                subject: fach,
                grade: klasse,
                competence: entry['Kompetenzbereich'] || '',
                level: entry['Niveaustufe'] || '',
                tool: tool,
                description: entry['Beschreibung'] || '',
                favorite: false
            });
            imported++;
        } else if (thema) {
            duplicates++;
        }
    });

    localStorage.setItem('resources', JSON.stringify(resources));
    populateDropdowns();
    applyFilters();
    updateStats();
    updateSubjectStats();

    // Erfolgs-Popup
    showFancyAlert(
        imported > 0
            ? `${imported} Ressource${imported > 1 ? 'n' : ''} importiert!`
            : 'Keine neuen Ressourcen importiert.',
        imported > 0 ? 'success' : 'warning',
        duplicates > 0 ? `${duplicates} Duplikat${duplicates > 1 ? 'e' : ''} übersprungen.` : ''
    );
}
function performImport(data) {
    let imported = 0;
    let duplicates = 0;

    data.forEach(entry => {
        const thema = entry['Thema']?.trim();
        const fach = entry['Unterrichtsfach'] || '';
        const klasse = entry['Klassenstufe'] || '';
        const tool = entry['Digitales_Hilfsmittel'] || '';

        const exists = resources.some(r =>
            r.topic === thema && r.subject === fach && r.grade === klasse && r.tool === tool
        );

        if (!exists && thema) {
            resources.push({
                topic: thema,
                subject: fach,
                grade: klasse,
                competence: entry['Kompetenzbereich'] || '',
                level: entry['Niveaustufe'] || '',
                tool: tool,
                description: entry['Beschreibung'] || '',
                favorite: false
            });
            imported++;
        } else if (thema) {
            duplicates++;
        }
    });

    localStorage.setItem('resources', JSON.stringify(resources));
    populateDropdowns();
    applyFilters();
    updateStats();
    updateSubjectStats();

    // Erfolgs-Popup
    showFancyAlert(
        imported > 0
            ? `${imported} Ressource${imported > 1 ? 'n' : ''} importiert!`
            : 'Keine neuen Ressourcen importiert.',
        imported > 0 ? 'success' : 'warning',
        duplicates > 0 ? `${duplicates} Duplikat${duplicates > 1 ? 'e' : ''} übersprungen.` : ''
    );
}

// Eigentlicher Import mit Fortschritt
function importWithProgress(csv, totalCount) {
    const modal = document.createElement('div');
    // ... (der Rest des Modal-HTML bleibt gleich, wie in deinem Code)

    document.body.appendChild(modal);
    requestAnimationFrame(() => {
        modal.querySelector('div').style.transform = 'scale(1)';
        modal.querySelector('div').style.opacity = '1';
    });

    const progressBar = modal.querySelector('#importProgress');
    const circle = modal.querySelector('#progressCircle');
    const title = modal.querySelector('#importTitle');
    const subtitle = modal.querySelector('#importSubtitle');
    const check = modal.querySelector('#checkMark');

    setTimeout(() => {
        try {
            const rows = csv.split('\n').map(r => r.trim()).filter(r => r);
            if (rows.length < 1) throw new Error('Keine gültigen Zeilen gefunden.');

            const headers = parseCSVLine(rows[0]);
            let imported = 0;
            let duplicates = 0;

            for (let i = 1; i < rows.length; i++) {
                const values = parseCSVLine(rows[i]);
                const entry = {};
                headers.forEach((h, idx) => entry[h] = values[idx] || '');

                const thema = entry['Thema']?.trim();
                if (!thema) continue;

                const fach = entry['Unterrichtsfach'] || '';
                const klasse = entry['Klassenstufe'] || '';
                const tool = entry['Digitales_Hilfsmittel'] || '';

                const exists = resources.some(r =>
                    r.topic === thema && r.subject === fach && r.grade === klasse && r.tool === tool
                );

                if (!exists) {
                    resources.push({
                        topic: thema,
                        subject: fach,
                        grade: klasse,
                        competence: entry['Kompetenzbereich'] || '',
                        level: entry['Niveaustufe'] || '',
                        tool: tool,
                        description: entry['Beschreibung'] || '',
                        favorite: false
                    });
                    imported++;
                } else {
                    duplicates++;
                }

                // Realer Fortschritt
                const percent = Math.round((i / (rows.length - 1)) * 100);
                progressBar.style.width = `${percent}%`;
                circle.style.strokeDashoffset = 276.46 * (1 - percent / 100);
                subtitle.textContent = `${i} von ${rows.length - 1}`;
            }

            localStorage.setItem('resources', JSON.stringify(resources));
            populateDropdowns();
            applyFilters();
            updateStats();
            updateSubjectStats();

            title.textContent = 'Import abgeschlossen!';
            title.style.color = '#27ae60';
            if (imported === 0) {
                subtitle.textContent = `Keine neuen Ressourcen (Duplikate: ${duplicates})`;
                check.style.stroke = '#f39c12';  // Gelb für Warnung
            } else {
                subtitle.textContent = `${imported} Ressourcen hinzugefügt (Duplikate: ${duplicates})`;
            }
            check.style.strokeDashoffset = '0';
            check.style.animation = 'draw 0.6s ease forwards';

        } catch (err) {
            console.error('Import-Fehler:', err);
            title.textContent = 'Import fehlgeschlagen!';
            title.style.color = '#e74c3c';
            subtitle.textContent = err.message || 'Unbekannter Fehler – prüfe CSV-Format.';
        }

        setTimeout(() => {
            modal.style.opacity = '0';
            setTimeout(() => modal.remove(), 400);
        }, 2000);  // Länger anzeigen für Lesbarkeit
    }, 300);
}
function updateSubjectStats() {
    const filtered = getFilteredResources();
    const count = filtered.reduce((a, r) => {
        const subject = r.subject || 'Unbekannt';
        a[subject] = (a[subject] || 0) + 1;
        return a;
    }, {});

    const container = document.getElementById('statsFach');
    if (!container) return;

    container.innerHTML = '';
    const max = Math.max(...Object.values(count), 1);

    Object.entries(count)
        .sort((a, b) => b[1] - a[1])
        .forEach(([subject, value]) => {
            const div = document.createElement('div');
            div.className = 'stat-bar';
            div.innerHTML = `
                <label>${subject} <span class="bar-value">${value}</span></label>
                <div class="bar-container">
                    <div class="bar" style="width: ${(value / max * 100)}%"></div>
                </div>
            `;
            container.appendChild(div);
        });
}
// === HILFSFUNKTIONEN ===
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current);
    return result.map(s => s.trim().replace(/^"|"$/g, ''));
}
function showFancyAlert(title, type = 'info', subtitle = '') {
    // Entferne alte Modals (sicherheitshalber)
    document.querySelectorAll('[data-fancy-alert]').forEach(m => m.remove());

    const modal = document.createElement('div');
    modal.dataset.fancyAlert = 'true';
    modal.style.cssText = `
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(8px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 30000;
        padding: 20px;
        box-sizing: border-box;
    `;

    const colors = {
        success: '#27ae60',
        warning: '#f39c12',
        info: '#6b46c1'
    };

    modal.innerHTML = `
        <div style="
            background: var(--card);
            padding: 28px;
            border-radius: 16px;
            text-align: center;
            max-width: 90%;
            width: 380px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease;
        ">
            <div style="margin: 0 auto 16px; width: 64px; height: 64px;">
                <svg width="64" height="64" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="4"/>
                    <circle cx="50" cy="50" r="44" fill="none" stroke="${colors[type]}" stroke-width="4"
                            stroke-dasharray="276.46" stroke-dashoffset="276.46"
                            style="animation: drawCircle 1s ease forwards;"/>
                    <path d="M30 50 L45 65 L70 35" fill="none" stroke="${colors[type]}" stroke-width="6"
                          stroke-linecap="round" stroke-linejoin="round"
                          style="stroke-dasharray:100; stroke-dashoffset:100; animation: draw 0.6s ease forwards 0.5s;"/>
                </svg>
            </div>
            <p style="font-size: 18px; font-weight: 700; color: ${colors[type]}; margin: 0 0 8px;">
                ${title}
            </p>
            ${subtitle ? `<p style="font-size: 14px; color: var(--text-light); margin: 0 0 20px; line-height: 1.5;">
                ${subtitle}
            </p>` : ''}
            <button id="fancyAlertOK" style="
                padding: 10px 24px;
                background: ${colors[type]};
                color: white;
                border: none;
                border-radius: 10px;
                font-weight: 600;
                font-size: 15px;
                cursor: pointer;
                min-width: 100px;
                transition: all 0.2s;
            " onmouseover="this.style.opacity='0.9'"
                onmouseout="this.style.opacity='1'">
                OK
            </button>
        </div>
    `;

    document.body.appendChild(modal);

    // Button direkt anhängen – KEIN this.closest!
    modal.querySelector('#fancyAlertOK').onclick = () => {
        modal.style.opacity = '0';
        setTimeout(() => modal.remove(), 300);
    };
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// === INSTALLATIONS-FENSTER AUSLÖSEN ===
window.addEventListener('load', () => {
    // Warte kurz, bis SW aktiv ist
    setTimeout(() => {
        // LÖSE EINEN FETCH AUS (z. B. Bild laden)
        fetch(`${REPO_PATH}icon-192.png?t=${Date.now()}`)
            .then(() => console.log('Fetch ausgelöst → PWA-Install bereit'))
            .catch(() => {});
    }, 1000);
});

// === GLOBALE VARIABLEN ===
let newWorker = null;

let targetVersion = null;  // NEU: Ziel-Version speichern

// NEU: Empfange Version vom Service-Worker
navigator.serviceWorker.addEventListener('message', event => {
  if (event.data?.type === 'NEW_VERSION') {
    targetVersion = event.data.version;
  }
});

// === EINZIGES UPDATE-BANNER ===
function showUpdateReady() {
  if (document.getElementById('updateBanner')) return;

  const banner = document.createElement('div');
  banner.id = 'updateBanner';
  banner.innerHTML = `
    <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 16px 24px; border-radius: 16px; box-shadow: 0 8px 32px rgba(46,204,113,0.4); display: flex; align-items: center; gap: 14px; font-size: 15px; font-weight: 600; max-width: 380px; animation: slideIn 0.5s ease;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      <div>
        <strong>Update verfügbar!</strong><br>
        ${currentVersion} → <strong>${newVersion}</strong>
      </div>
      <button id="installNow" style="background: white; color: #27ae60; border: none; border-radius: 10px; padding: 8px 16px; font-weight: 600; cursor: pointer;">Jetzt installieren</button>
      <button id="closeBanner" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-left: 8px;">×</button>
    </div>
  `;
  document.body.appendChild(banner);

  // Installieren
  banner.querySelector('#installNow').onclick = () => {
    if (!newWorker) return;
    banner.style.opacity = '0';
    banner.style.transition = 'opacity 0.3s ease';
    newWorker.postMessage({ action: 'skipWaiting' });
  };

  // Schließen
  banner.querySelector('#closeBanner').onclick = () => {
    banner.remove();
  };

  // Auto-Schließen nach 15 Sekunden
  setTimeout(() => {
    const b = document.getElementById('updateBanner');
    if (b) b.remove();
  }, 15000);
}

// === ANIMATION FÜR BANNER (einmalig) ===
if (!document.getElementById('app-animations')) {
  const style = document.createElement('style');
  style.id = 'app-animations';
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
}


// === SERVICE WORKER REGISTRIERUNG ===
if ('serviceWorker' in navigator) {
  const swUrl = `service-worker.js?v=${Date.now()}`; // Cache-Busting
  navigator.serviceWorker.register(swUrl).then(reg => {
    console.log('SW registriert');

    // Update gefunden?
    reg.addEventListener('updatefound', () => {
      const installingWorker = reg.installing;
      if (installingWorker) {
        installingWorker.addEventListener('statechange', () => {
          if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
            newWorker = installingWorker;
            showUpdateReady(); // Zeige Banner
          }
        });
      }
    });

    // Sofort prüfen
    reg.update();
  });

  // Bei Controller-Wechsel: Seite neu laden
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
}

 </script>  <!-- ← ENDE SCRIPT -->

     <!-- Version-Info -->
    <div class="version-info" id="versionInfo">Lade Version...</div>

    <!-- === LÖSCH-ANIMATION === -->
    <div id="deleteAnimation" style="
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.5);backdrop-filter:blur(6px);
        display:none;justify-content:center;align-items:center;
        z-index:10000;
    ">
        <div style="
            background:var(--card);padding:40px;border-radius:20px;text-align:center;
            box-shadow:0 16px 48px rgba(0,0,0,0.25);
            transform:scale(0.8);opacity:0;
            transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1),opacity 0.4s ease;
        ">
            <div style="width:90px;height:90px;margin:0 auto 18px;position:relative;">
                <svg width="90" height="90" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="3"/>
                    <path d="M30 50 L45 65 L70 35" fill="none" stroke="#e74c3c" stroke-width="6"
                          stroke-linecap="round" stroke-linejoin="round"
                          style="stroke-dasharray:100;stroke-dashoffset:100;animation:draw 0.6s ease forwards 0.3s;"/>
                </svg>
            </div>
            <p style="font-size:20px;font-weight:700;color:#e74c3c;margin:0 0 6px;">
                Gelöscht!
            </p>
            <p style="font-size:14px;color:var(--text-light);margin:0;">
                Die Ressource wurde entfernt.
            </p>
        </div>
    </div>

    <style>
        @keyframes draw { to { stroke-dashoffset: 0; } }
        .delete-active { display: flex !important; }
        .delete-active > div { transform: scale(1) !important; opacity: 1 !important; }
        .edit-active { display: flex !important; }
         .edit-active > div { transform: scale(1) !important; opacity: 1 !important; }
        .add-active { display: flex !important; }
         .add-active > div { transform: scale(1) !important; opacity: 1 !important; }
    /* === TABELLEN: KEINE LÜCKEN ZWISCHEN ZELLEN === */
table, th, td {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    border: none !important;
}

th {
    background: #6b46c1 !important;
    color: white !important;
    padding: 14px 16px !important;
    font-weight: 600;
    text-align: left;
    font-size: 15px;
}

td {
    background: #f8f9fa !important;
    padding: 12px 16px !important;
    vertical-align: top;
    border-bottom: 1px solid #ddd !important;
}

/* Optional: Letzte Zeile ohne unteren Rand */
tr:last-child td {
    border-bottom: none !important;
}
/* === EXPORT: HORIZONTAL + FILTERABHÄNGIGKEIT KLAR === */
.export-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    align-items: flex-start;
    margin: 15px 0;
    justify-content: flex-start;
}

.export-group.horizontal {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 300px;
    flex: 1;
}

.export-group-title {
    margin: 0 !important;
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
    padding-bottom: 4px;
    border-bottom: 2px solid var(--primary-light);
    text-align: left;
}

#filterExportTitle {
    transition: color 0.3s ease;
}

.btn-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

/* === FILTER-EXPORT BUTTONS: Hervorhebung bei aktiven Filtern === */
.filtered-export {
    position: relative;
    transition: all 0.2s ease;
}

.filtered-export.active {
    animation: pulse 2s infinite;
    box-shadow: 0 0 0 2px #e74c3c !important;
    transform: translateY(-1px);
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 2px #e74c3c; }
    50% { box-shadow: 0 0 0 4px #e74c3c, 0 0 12px rgba(231, 76, 60, 0.4); }
}

/* === TOOLTIPS === */
.btn[title] {
    position: relative;
    cursor: pointer;
}
.btn[title]:hover::after,
.btn[title]:focus::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    white-space: nowrap;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    margin-bottom: 8px;
    max-width: 300px;
    white-space: normal;
    line-height: 1.4;
}
.btn[title]:hover::before,
.btn[title]:focus::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #333;
    margin-bottom: 2px;
    z-index: 1000;
}
/* === TOOLTIP MIT CSS-VARIABLEN (für JS-Steuerung) === */
.btn[title]::after,
.btn[title]::before {
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
}

.btn[title][style*="--show-tooltip: block"]::after,
.btn[title][style*="--show-tooltip: block"]::before {
    opacity: 1;
    visibility: visible;
}

/* === MOBILE === */
@media (max-width: 768px) {
    .export-buttons {
        flex-direction: column;
        gap: 16px;
    }
    .export-group.horizontal {
        min-width: 100%;
    }
    .export-group-title {
        text-align: center;
        font-size: 13.5px;
    }
    .btn-row {
        justify-content: center;
    }
    .btn[title]:hover::after,
    .btn[title]:hover::before {
        display: none;
    }
    .btn[title]:active::after,
    .btn[title]:active::before {
        display: block;
    }
}
@media print {
    /* Alles verstecken außer .main */
    body * {
        visibility: hidden !important;
    }
    .main, .main * {
        visibility: visible !important;
    }
    .main {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 12mm 10mm !important;
        margin: 0 !important;
    }

    /* TESTVERSION-BANNER & andere Störer verstecken */
    .test-banner,
    [class*="test"],
    [style*="TESTVERSION"],
    [style*="nicht live"],
    .version-info,
    .logo-header,
    .filter-container,
    .export-buttons,
    .sidebar,
    .new-resource-btn,
    #deleteAnimation,
    #editAnimation,
    #addAnimation {
        display: none !important;
    }

    /* Kein unnötiger Platz */
    * {
        float: none !important;
        position: static !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Ressourcen: mehr pro Seite */
    .print-resource {
        page-break-inside: auto !important;
        break-inside: auto !important;
        margin-bottom: 5mm !important;
    }

    /* Beschreibung: passt sich an */
    .print-resource > div[style*="background"] {
        display: inline-block !important;
        width: auto !important;
        margin: 2mm 0 0 !important;
        padding: 2mm 6mm !important;
    }

    /* Seitenlayout */
    @page {
        size: A4 portrait;
        margin: 12mm 10mm 18mm 10mm;
        @bottom-left {
            content: "Seite " counter(page);
            font-size: 8pt;
            color: #666;
        }
        @bottom-right {
            content: "LernDashboard Digital";
            font-size: 8pt;
            color: #666;
        }
    }

    /* Schulname unten */
    #printSchoolName {
        display: block !important;
        position: fixed !important;
        bottom: 8mm !important;
        left: 10mm !important;
        font-size: 8pt !important;
        color: #666 !important;
    }
}
/* === ZENTRIERTER BUTTON-WRAPPER === */
.centered-button-wrapper {
    display: flex;
    justify-content: center;
    margin: 6px 0 12px !important;   /* Kleiner Abstand oben/unten – einheitlich */
    width: 100%;
}
    </style>
<!-- === BEARBEITUNGS-BESTÄTIGUNG (ANIMATION – OHNE TON) === -->
<div id="editAnimation" style="
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); backdrop-filter:blur(6px);
    display:none; justify-content:center; align-items:center;
    z-index:10000;
">
    <div style="
        background:var(--card); padding:40px; border-radius:20px; text-align:center;
        box-shadow:0 16px 48px rgba(0,0,0,0.25);
        transform:scale(0.8); opacity:0;
        transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s ease;
    ">
        <div style="width:90px; height:90px; margin:0 auto 18px;">
            <svg width="90" height="90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="3"/>
                <path d="M30 50 L45 65 L70 35" fill="none" stroke="#27ae60" stroke-width="6"
                      stroke-linecap="round" stroke-linejoin="round"
                      style="stroke-dasharray:100; stroke-dashoffset:100; animation:draw 0.6s ease forwards 0.3s;"/>
            </svg>
        </div>
        <p style="font-size:20px; font-weight:700; color:#27ae60; margin:0 0 6px;">
            Bearbeitet!
        </p>
        <p style="font-size:14px; color:var(--text-light); margin:0;">
            Die Ressource wurde aktualisiert.
        </p>
    </div>
</div>
        <!-- === HINZUFÜGEN-BESTÄTIGUNG (ANIMATION) === -->
<div id="addAnimation" style="
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); backdrop-filter:blur(6px);
    display:none; justify-content:center; align-items:center;
    z-index:10000;
">
    <div style="
        background:var(--card); padding:40px; border-radius:20px; text-align:center;
        box-shadow:0 16px 48px rgba(0,0,0,0.25);
        transform:scale(0.8); opacity:0;
        transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s ease;
    ">
        <div style="width:90px; height:90px; margin:0 auto 18px;">
            <svg width="90" height="90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="3"/>
                <path d="M30 50 L45 65 L70 35" fill="none" stroke="#27ae60" stroke-width="6"
                      stroke-linecap="round" stroke-linejoin="round"
                      style="stroke-dasharray:100; stroke-dashoffset:100; animation:draw 0.6s ease forwards 0.3s;"/>
            </svg>
        </div>
        <p style="font-size:20px; font-weight:700; color:#27ae60; margin:0 0 6px;">
            Hinzugefügt!
        </p>
        <p style="font-size:14px; color:var(--text-light); margin:0;">
            Die Ressource ist im Dashboard.
        </p>
    </div>
</div>

</body>
</html> 