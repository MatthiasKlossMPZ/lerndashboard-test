<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>LernDashboard Digital</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6b46c1">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="prefetch" href="edit-resource.html">
    <link rel="prefetch" href="new-resource.html">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    .logo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        width: 100%;
    }
    .logo-left {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
    }
    .logo-right svg {
        height: 80px !important;
        width: auto;
    }
    .logo-title {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .title-main {
        font-size: 24px;
        font-weight: 800;
        color: #333;
    }
    .title-sub {
        font-size: 14px;
        color: #666;
    }
    :root {
        --primary: #6b46c1;
        --primary-light: #7e5be0;
        --danger: #e53e3e;
        --bg: #f5f7fa;
        --card: #ffffff;
        --shadow: 0 1px 3px rgba(0,0,0,0.1);
        --tool: #1e90ff;
        --competence: #ff8c00;
        --grade: #50c878;
        --subject: #9b59b6;
        --text: #333;
        --text-light: #555;
        --favorite: #f39c12;
        --level: #00bfff;  
        }
    .dark {
        --bg: #1a1a1a;
        --card: #2d2d2d;
        --text: #e0e0e0;
        --text-light: #bbbbbb;
        --shadow: 0 1px 3px rgba(0,0,0,0.3);
        background: #111 !important;
        color: var(--text) !important;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0; padding: 20px;
        background: var(--bg); color: var(--text);
    }
    .main { width: 100%; }
    .content-wrapper {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    .resources-container { flex: 1; min-width: 0; }
    .sidebar {
        width: 320px; background: var(--card); border-radius: 12px;
        padding: 16px; box-shadow: var(--shadow); height: fit-content;
        position: sticky; top: 20px; align-self: flex-start;
    }
    .sidebar h3 { margin: 0 0 16px; color: var(--primary); font-size: 16px; text-align: center; }
    .stat-bar { margin: 12px 0; }
    .stat-bar label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; color: var(--text-light); }
    .bar-container { height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; }
    .bar { height: 100%; background: var(--primary); border-radius: 5px; transition: width 0.4s ease; }
    .bar-value { font-weight: bold; color: var(--primary); }
    .filter-container { background: linear-gradient(135deg, #eef5ff, #e0edff); padding: 14px; border-radius: 12px; border: 1px solid #cce0ff; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); width: 100%; }
    .filters { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; min-width: 140px; flex: 1; }
    .filter-group label { font-size: 12px; color: #555; margin-bottom: 4px; font-weight: 600; }
    .filter-group select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; }
    .search-container {
        position: relative;
        flex: 1;
        max-width: 280px !important;
        min-width: 180px;
        margin-right: 10px;
    }
    .search-input { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    #suggestions { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ccc; max-height: 180px; overflow-y: auto; z-index: 1000; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
    #suggestions div { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
    #suggestions div:hover { background: #f0f4ff; }
    .reset-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin-left: 12px;
        align-self: flex-end;
    }
    .export-buttons { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { background: var(--primary); color: white; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: normal; transition: 0.2s; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .file-input { display: none; }
    .new-resource-btn { display: block; margin: 20px auto; padding: 14px 28px; font-size: 17px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 6px 16px rgba(107,70,193,0.3); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; max-width: 360px; }
    .new-resource-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(107,70,193,0.4); }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 16px 0; }
    .stat-card { background: var(--card); padding: 12px; border-radius: 10px; text-align: center; box-shadow: var(--shadow); font-weight: 600; }
    .stat-card span { display: block; font-size: 22px; color: var(--primary); margin-top: 6px; }
    .resource-item { margin: 12px 0; padding: 16px; border: 1px solid #e0e0e0; border-radius: 12px; background: var(--card); box-shadow: var(--shadow); transition: transform 0.2s; }
    .resource-item:hover { transform: translateY(-2px); }
    .resource-content { margin-bottom: 12px; line-height: 1.6; font-size: 15px; }
    .tag {
        display: inline-block;
        padding: 4px 10px;
        margin: 2px 4px 2px 0;
        border-radius: 16px;
        font-size: 11px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .tag:hover {
        opacity: 0.85;
        transform: scale(1.05);
    }
    .grade-tag { background: var(--grade); }
    .tool-tag { background: var(--tool); }
    .competence-tag { background: var(--competence); }
    .level-tag { background: var(--level); }
    .subject-tag { background: var(--subject); }
    .description { margin-top: 10px; font-size: 13px; color: var(--text-light); background: #f8f9fa; padding: 8px; border-radius: 6px; border-left: 3px solid var(--primary); }
    .action-icons { display: flex; gap: 8px; justify-content: flex-end; align-items: center; }
    .action-icon { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .action-icon:hover { transform: scale(1.15); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .action-icon svg { width: 18px; height: 18px; fill: currentColor; }
    .edit-icon { background: #e8f5e8; color: #27ae60; } .edit-icon:hover { background: #27ae60; color: white; }
    .delete-icon { background: #ffe8e8; color: #e74c3c; } .delete-icon:hover { background: #e74c3c; color: white; }
    .favorite-icon { background: #fff8e1; color: #f39c12; } .favorite-icon.active { background: #f39c12; color: white; }
    #editForm { display: none; margin-top: 25px; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    .form-group textarea { min-height: 90px; resize: vertical; }
    #editForm button { margin-right: 10px; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    #editForm button[type="submit"] { background: var(--primary); color: white; }
    #editForm button[type="button"] { background: #95a5a6; color: white; }
    .version-info {
        position: fixed;
        bottom: 10px;
        right: 10px;
        font-size: 11px;
        color: var(--text-light);
        background: var(--card);
        padding: 4px 8px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        z-index: 100;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    .version-info:hover { opacity: 1; }

/* === SCHUL-BUTTON: IDENTISCH ZUM NEUE-RESSOURCE-BUTTON (OHNE ICON) === */
.school-btn {
    background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
    margin: 16px auto 8px !important;
    max-width: 100% !important;
    font-size: 16px !important;
    padding: 14px 20px !important;
    box-shadow: 0 6px 16px rgba(155, 89, 182, 0.3) !important;
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    border: none;
    color: white;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    width: 100%;
}

.school-btn:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 12px 28px rgba(155, 89, 182, 0.4) !important;
}

.school-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.7s;
}

.school-btn:hover::before {
    left: 100%;
}

/* Wenn Schulname gesetzt → grün */
#schoolButton[data-set="true"] {
    background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
    box-shadow: 0 6px 16px rgba(46, 204, 113, 0.3) !important;
}

#schoolButton[data-set="true"]:hover {
    box-shadow: 0 12px 28px rgba(46, 204, 113, 0.4) !important;
}

/* ==================== MOBILE OPTIMIERUNGEN – FINAL ==================== */
@media (max-width: 768px) {
    body { 
        padding: 10px; 
        overflow-x: hidden; /* Verhindert horizontales Scrollen */
    }

    /* --- HEADER --- */
    .logo-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 14px;
        margin-bottom: 18px;
    }
    .logo-left, .logo-right {
        width: 100%;
        justify-content: center;
    }
    .logo-left svg { height: 85px !important; }
    .logo-right svg { height: 55px !important; }
    .title-main { font-size: 19px; }
    .title-sub { font-size: 12.5px; }

    /* --- FILTER --- */
    .filter-container { 
        padding: 12px; 
        margin-bottom: 14px;
    }
    .filters {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    .filter-group, .search-container {
        min-width: 0;
        max-width: none !important;
        flex: 1;
    }
    .search-container {
        margin: 0;
    }
    .reset-btn {
        margin: 8px 0 0 0;
        align-self: stretch;
        padding: 10px;
    }

    /* --- CONTENT: Ressourcen VOR Sidebar --- */
    .content-wrapper {
        flex-direction: column !important;
        gap: 18px;
    }

    /* --- SIDEBAR: KEIN STICKY MEHR, VOLLBREITE --- */
    .sidebar {
        width: 100% !important;
        position: static !important;   /* WICHTIG: sticky deaktivieren */
        top: auto !important;
        padding: 14px;
        order: 2; /* Sidebar NACH Ressourcen */
        margin-top: 10px;
        z-index: 1; /* Sicherstellen, dass nichts überlagert */
    }
    .resources-container {
        order: 1;
        min-width: 0;
    }
    /* --- SCHULNAME-BUTTON (MOBILE) --- */
#schoolButton {
    font-size: 12.5px;
    padding: 9px 10px;
    min-height: 42px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#schoolButton:hover {
    box-shadow: 0 4px 10px rgba(0,0,0,0.18);
}

#schoolButton[data-set="true"]:hover {
    box-shadow: 0 4px 10px rgba(197, 143, 224, 0.35);
}

/* === EXPORT-BUTTONS – EINHEITLICHES FARBKONZEPT === */
.export-buttons .btn {
    font-weight: 600;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    transition: all 0.2s ease;
}

/* 1. ALLE EXPORT → VIOLETT */
.btn.csv,
.btn.pdf,
.btn.matrix {
    background: var(--primary);
    color: white;
}

/* 2. IMPORT & VORLAGE → BLAU */
.btn.import,
.btn.template {
    background: #2980b9;
    color: white;
}

/* 3. DRUCKEN → DUNKELGRAU */
.btn.print {
    background: #2c3e50;
    color: white;
}

/* 4. BACKUP → GRÜN (wie gewünscht) */
.btn[onclick="autoBackup()"] {
    background: #2ecc71;
    color: white;
}

/* Hover für alle */
.export-buttons .btn:hover {
    opacity: 0.92;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
    .export-buttons {
        flex-wrap: wrap;
        gap: 8px;
        justify-content: stretch;
    }
    .btn {
        flex: 1 1 45%;
        min-width: 0;
        font-size: 13px;
        padding: 9px 8px;
        white-space: nowrap;
    }

/* --- NEUE RESSOURCE BUTTON (MOBILE) --- */
.new-resource-btn {
    max-width: 100%;
    font-size: 15.5px;
    padding: 13px 18px;
    margin: 18px auto;
    box-shadow: 0 6px 16px rgba(0, 210, 211, 0.3);
}

.new-resource-btn:hover {
    box-shadow: 0 10px 24px rgba(0, 210, 211, 0.4);
}

    /* --- STATS --- */
    .stats {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .stat-card span { font-size: 17px; }

    /* --- RESSOURCEN --- */
    .resource-item {
        padding: 11px;
        font-size: 14px;
    }
    .action-icons { gap: 5px; }
    .action-icon { width: 30px; height: 30px; }
    .action-icon svg { width: 15px; height: 15px; }

    /* --- VERSION INFO --- */
    .version-info {
        position: fixed;
        bottom: 8px;
        left: 8px;
        right: 8px;
        text-align: center;
        font-size: 9.5px;
        padding: 3px 6px;
        z-index: 10;
    }

    /* --- TOUCH OPTIMIERUNG --- */
    .btn, .action-icon, .tag, .reset-btn, .new-resource-btn, select, input {
        min-height: 44px;
        touch-action: manipulation;
    }
        .btn.import {
        font-weight: normal !important;
        text-align: center !important;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        padding: 9px 8px;
    }
    .btn.import span {
        display: block;
        width: 100%;
        text-align: center;
        pointer-events: none;
    }
    .btn.import input[type="file"] {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        opacity: 0;
        cursor: pointer;
    }
}
/* === NEUE RESSOURCE – TÜRKIS-GRADIENT (DESKTOP & BASIS) === */
.new-resource-btn {
    display: block;
    margin: 20px auto;
    padding: 14px 28px;
    font-size: 17px;
    font-weight: 700;
    background: linear-gradient(135deg, #00d2d3, #48cae4);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 6px 16px rgba(0, 210, 211, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    max-width: 360px;
    position: relative;
    overflow: hidden;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.new-resource-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.7s;
}

.new-resource-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 28px rgba(0, 210, 211, 0.4);
}

.new-resource-btn:hover::before {
    left: 100%;
}


/* Sehr kleine Bildschirme */
@media (max-width: 380px) {
    .stats { grid-template-columns: 1fr; }
    .export-buttons { flex-direction: column; }
    .btn { flex: 1 1 auto; }
}
/* Filter aktiv: blasses Rot + Akzent OHNE Verschiebung */
.filter-container.active {
    background: linear-gradient(135deg, #fff5f5, #ffeaea) !important;
    box-shadow: 0 2px 8px rgba(255, 0, 0, 0.08) !important;
    position: relative;
    overflow: hidden;
    transition: background 0.3s ease, box-shadow 0.3s ease;
}

.filter-container.active::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
    background: rgba(255, 0, 0, 0.4);
    pointer-events: none; /* damit Klicks durchgehen */
}
    </style>
</head>
<body>
<!-- DRUCK-FOOTER: Schulname (unsichtbar) -->
<div id="printSchoolName" style="position: fixed; bottom: 0; left: 0; font-size: 9pt; color: #666; display: none;">
    Schule: <span id="printSchoolNameText"></span>
</div>
<div style="background: #ff4444; color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
  TESTVERSION – nur für internen Gebrauch! (Diese Änderungen sind noch nicht live)
</div>

<!-- Kleiner Abstand, damit der Rest nicht unter dem Banner verschwindet -->
<div style="height: 70px;"></div>
    
    <div class="main">
        <!-- ZWEI LOGOS + TITEL -->
        <div class="logo-header">
            <div class="logo-left" onclick="toggleDarkMode()">
                <!-- APP-LOGO -->
<svg class="logo-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" style="width: auto; height: 130px; cursor: pointer;">
    <defs>
        <linearGradient id="frameGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#8e67d6"/>
            <stop offset="100%" stop-color="#5e3ab0"/>
        </linearGradient>
        <linearGradient id="screenGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#f0f4ff"/>
            <stop offset="100%" stop-color="#d0e0ff"/>
        </linearGradient>
    </defs>
    <rect x="14" y="14" width="36" height="36" rx="8" fill="url(#frameGrad)" stroke="#4a2e8c" stroke-width="2"/>
    <rect x="16" y="16" width="32" height="32" rx="6" fill="#ffffff"/>
    <rect x="18" y="18" width="28" height="28" rx="4" fill="url(#screenGrad)"/>
    <g transform="translate(19.465148,19.604556)">
        <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#4caf50"/>
        <circle cx="3.5" cy="2.5" r="1.5" fill="#ffffff"/>
        <path d="m 2.5,4.5 h 2" stroke="#ffffff" stroke-width="1"/>
        <g transform="translate(9)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#ff9800"/>
            <path d="M 2,2 5,5 M 5,2 2,5" stroke="#ffffff" stroke-width="1.2" stroke-linecap="round"/>
        </g>
        <g transform="translate(18)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#e91e63"/>
            <circle cx="3.5" cy="3.5" r="2" fill="#ffffff"/>
            <circle cx="4" cy="3" r="0.8" fill="#333333"/>
        </g>
        <g transform="translate(0,9)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#f44336"/>
            <path d="M 2,5 V 3 L 5,4 V 6 L 2,7 Z" fill="#ffffff"/>
            <circle cx="4.5" cy="1.5" r="1" fill="#ffffff"/>
        </g>
        <g transform="translate(9,9)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#2196f3"/>
            <path d="M 2.5,2 5,3.5 v -3 z" fill="#ffffff"/>
        </g>
        <g transform="translate(18,9)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#9c27b0"/>
            <path d="m 1.5,2 h 4 m -4,1.5 h 4 M 1.5,5 h 2" stroke="#ffffff" stroke-width="0.8"/>
        </g>
        <g transform="translate(0,18)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#3f51b5"/>
            <path d="m 1.5,5.5 h 1 v -2 h -1 z m 1.5,0 h 1 v -3 H 3 Z m 1.5,0 h 1 v -1 h -1 z" fill="#ffffff"/>
        </g>
        <g transform="translate(9,18)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#00bcd4"/>
            <circle cx="3.5" cy="3.5" r="2.5" stroke="#ffffff" stroke-width="0.8" fill="none"/>
            <path d="m 1.5,3.5 h 4 m -2,-2 v 4" stroke="#ffffff" stroke-width="0.6"/>
        </g>
        <g transform="translate(18,18)">
            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#eeeeee"/>
            <path d="m 1.5,2 h 4 m -4,2 h 4" stroke="#999999" stroke-width="0.8"/>
            <path d="M 1.5,2 2.2,2.7 M 1.5,2 2.9,3.4" stroke="#4caf50" stroke-width="1"/>
        </g>
    </g>
    <circle cx="20" cy="20" r="3" fill="#fff" opacity="0.5"/>
</svg>
                <div class="logo-title">
                    <div class="title-main">LernDashboard</div>
                    <div class="title-sub">Digital</div>
                </div>
            </div>
            <!-- BUNDESLAND-LOGO (rechts) -->
            <div class="logo-right">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 116.22047 61.596849" style="width: auto; height: 80px;">
                    <defs>
                        <style>
                            .cls-1{fill:#005e90;}.cls-2{fill:url(#Unbenannter_Verlauf_5);}.cls-3{fill:url(#Unbenannter_Verlauf_62);}.cls-4{fill:url(#Unbenannter_Verlauf_41);}.cls-5{fill:#f2b700;}.cls-6{fill:url(#Unbenannter_Verlauf_32);}.cls-7{fill:url(#Unbenannter_Verlauf_6);}.cls-8{fill:url(#Unbenannter_Verlauf_6-2);}
                        </style>
                        <linearGradient id="Unbenannter_Verlauf_5" x1="77.08391" y1="22.21157" x2="113.43772" y2="30.60451" gradientUnits="userSpaceOnUse">
                            <stop offset="0.05" stop-color="#5e9841"/><stop offset="0.4596" stop-color="#679d48"/><stop offset="0.65" stop-color="#6da14d"/><stop offset="0.95" stop-color="#5e9841"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_62" x1="77.08391" y1="22.21157" x2="113.43772" y2="30.60451" gradientUnits="userSpaceOnUse">
                            <stop offset="0.05" stop-color="#289b38"/><stop offset="0.36963" stop-color="#319f41"/><stop offset="0.65" stop-color="#3da54c"/><stop offset="0.95" stop-color="#289b38"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_41" x1="94.87943" y1="13.29865" x2="94.87943" y2="24.93903" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#2676a1"/><stop offset="0.00529" stop-color="#2576a1"/><stop offset="0.17354" stop-color="#116897"/><stop offset="0.33964" stop-color="#046192"/><stop offset="0.5" stop-color="#005e90"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_32" x1="90.27939" y1="14.03253" x2="90.27939" y2="0.00081" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#6dc6e8"/><stop offset="0.19323" stop-color="#58bee5"/><stop offset="0.73219" stop-color="#21a8dc"/><stop offset="0.99375" stop-color="#0ca0d9"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_6" x1="113.26653" y1="13.74329" x2="113.26653" y2="13.73981" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#96c5e2"/><stop offset="0.21183" stop-color="#7fb9dc"/><stop offset="0.51882" stop-color="#64aad5"/><stop offset="0.79155" stop-color="#54a1d1"/><stop offset="1" stop-color="#4e9ecf"/>
                        </linearGradient>
                        <linearGradient id="Unbenannter_Verlauf_6-2" x1="112.71431" y1="13.71899" x2="112.71431" y2="13.71558" xlink:href="#Unbenannter_Verlauf_6"/>
                    </defs>
                    <title>NEU_Zeichenfläche 1</title>
                    <g id="tut_gut._40" data-name="tut gut. 40">
                        <path class="cls-1" d="M53.75344,52.80545a3.9581,3.9581,0,0,1-2.40381.78858c-1.52832,0-2.90527-.84571-2.90527-3.10694V44.70438H46.76028A13.6736,13.6736,0,0,0,46.9761,43.013l1.5791-.2583.271-1.95459a11.66615,11.66615,0,0,1,1.70362-.481V43.013h3.20752a13.6736,13.6736,0,0,1-.21582,1.69141h-2.9917v5.27246c0,1.27686.6372,1.69434,1.50586,1.69434a3.2961,3.2961,0,0,0,1.93408-.68506A5.89055,5.89055,0,0,1,53.75344,52.80545Z"/>
                        <path class="cls-1" d="M63.99856,53.52469a7.80025,7.80025,0,0,1-.7041-2.63086,3.86811,3.86811,0,0,1-3.79737,2.69971c-2.06787,0-3.312-1.333-3.312-3.77393v-6.48a14.32361,14.32361,0,0,1,2.08545-.58886v6.64062c0,1.45117.70947,2.22656,1.83789,2.22656,1.64355,0,3.10742-1.59668,3.10742-3.915v-1.4624c0-1.61963-.03125-2.77685-.05517-3.19824a10.5755,10.5755,0,0,1,2.10058-.06543c.01709.35889.04053,1.48975.04053,3.26367V49.3953a12.13883,12.13883,0,0,0,.46387,3.69482A4.53265,4.53265,0,0,1,63.99856,53.52469Z"/>
                        <path class="cls-1" d="M74.62942,52.80545a3.95815,3.95815,0,0,1-2.40381.78858c-1.52832,0-2.90528-.84571-2.90528-3.10694V44.70438H67.63625a13.67169,13.67169,0,0,0,.21582-1.69141l1.5791-.2583.271-1.95459a11.66636,11.66636,0,0,1,1.70361-.481V43.013H74.6133a13.67169,13.67169,0,0,1-.21582,1.69141h-2.9917v5.27246c0,1.27686.63721,1.69434,1.50586,1.69434a3.296,3.296,0,0,0,1.93408-.68506A5.89051,5.89051,0,0,1,74.62942,52.80545Z"/>
                        <path class="cls-1" d="M88.55569,51.67264c1.75.33594,2.498,1.188,2.498,2.43164,0,2.06543-2.11426,3.78516-5.418,3.78516-2.62841,0-4.54052-1.05371-4.54052-2.6499,0-1.39454,1.23925-2.30274,2.69287-2.69629a2.03468,2.03468,0,0,1-1.27149-1.814,1.89434,1.89434,0,0,1,.78711-1.51123,3.13428,3.13428,0,0,1-1.8042-2.86865c0-2.22461,2.0708-3.59863,4.50147-3.59863a5.61022,5.61022,0,0,1,1.73144.25781H91.2051a11.4867,11.4867,0,0,1-.2207,1.56445l-1.49756-.41553a3.09669,3.09669,0,0,1,.69336,1.99707c0,2.22071-2.05811,3.58448-4.49512,3.58448a5.97529,5.97529,0,0,1-1.24121-.12451.79386.79386,0,0,0-.13672.44287c0,.4375.3291.86279,1.7417,1.13427l2.50684.48145ZM89.06447,54.49c0-.47314-.3208-.82324-1.57617-1.06445l-1.96875-.37793c-1.35449.2749-2.48925.92041-2.48925,1.71582,0,.80908,1.25048,1.42285,2.89013,1.42285C87.77346,56.18631,89.06447,55.4368,89.06447,54.49Zm-5.563-8.19726A2.0449,2.0449,0,0,0,85.77785,48.157a2.165,2.165,0,0,0,2.40088-1.94629,2.05016,2.05016,0,0,0-2.271-1.87842A2.17934,2.17934,0,0,0,83.50149,46.29276Z"/>
                        <path class="cls-1" d="M101.107,53.52469a7.80046,7.80046,0,0,1-.70411-2.63086,3.86809,3.86809,0,0,1-3.79736,2.69971c-2.06787,0-3.312-1.333-3.312-3.77393v-6.48a14.32325,14.32325,0,0,1,2.08545-.58886v6.64062c0,1.45117.70947,2.22656,1.83789,2.22656,1.64355,0,3.10742-1.59668,3.10742-3.915v-1.4624c0-1.61963-.03125-2.77685-.05518-3.19824a10.57563,10.57563,0,0,1,2.10059-.06543c.01709.35889.04053,1.48975.04053,3.26367V49.3953a12.13883,12.13883,0,0,0,.46387,3.69482A4.53265,4.53265,0,0,1,101.107,53.52469Z"/>
                        <path class="cls-1" d="M111.73781,52.80545a3.95809,3.95809,0,0,1-2.4038.78858c-1.52832,0-2.90528-.84571-2.90528-3.10694V44.70438h-1.68408a13.67169,13.67169,0,0,0,.21582-1.69141l1.5791-.2583.271-1.95459a11.66636,11.66636,0,0,1,1.70361-.481V43.013h3.20752a13.67169,13.67169,0,0,1-.21582,1.69141h-2.9917v5.27246c0,1.27686.63721,1.69434,1.50586,1.69434a3.29608,3.29608,0,0,0,1.93408-.68506A5.89055,5.89055,0,0,1,111.73781,52.80545Z"/>
                        <path class="cls-1" d="M113.79616,52.3787a1.31151,1.31151,0,0,1,1.28466-1.3794,1.129,1.129,0,0,1,1.13965,1.21436A1.31177,1.31177,0,0,1,114.9358,53.594,1.12982,1.12982,0,0,1,113.79616,52.3787Z"/>
                    </g>
                    <g id="MV_40" data-name="MV 40">
                        <path class="cls-1" d="M70.86079.186,56.3,31.2433H50.56612L36.00536.186a.09132.09132,0,0,1,.08216-.11994h.90427A13.42714,13.42714,0,0,1,40.578.44591a6.59341,6.59341,0,0,1,3.43214,3.50857c1.51057,2.97876,9.42287,19.602,9.42287,19.602s7.91237-16.6232,9.42294-19.602A6.5933,6.5933,0,0,1,66.28805.44591,13.42772,13.42772,0,0,1,69.87429.06606h.90428A.09135.09135,0,0,1,70.86079.186Z"/>
                        <path class="cls-1" d="M32.78247.07069h-.41792a15.44729,15.44729,0,0,0-3.88737.42444c-1.77327.625-3.05629,2.13153-5.26713,6.58515-1.48466,2.99024-5.77485,11.94025-5.777,11.94452-.00213-.00427-4.29232-8.95428-5.777-11.94452C9.44525,2.62666,8.16223,1.12013,6.389.49513A15.44716,15.44716,0,0,0,2.50159.07069H2.08368L0,31.2518H5.92717L7.39906,8.8536,15.75948,26.493h3.34718L27.46708,8.8536,28.939,31.2518h5.92717Z"/>
                    </g>
                    <g id="Bildzeichen_40" data-name="Bildzeichen 40">
                        <path class="cls-2" d="M100.9129,20.95462c-5.679.31559-12.82928,2.6454-17.21232,3.37a52.42079,52.42079,0,0,1-7.24636.61441v6.24207h36.85037V21.45885a47.93751,47.93751,0,0,0-8.41788-.61591C103.67309,20.84294,102.34472,20.87528,100.9129,20.95462Z"/>
                        <path class="cls-3" d="M100.9129,20.95462c-5.679.31559-12.82928,2.6454-17.21232,3.37a52.42079,52.42079,0,0,1-7.24636.61441v6.24207h36.85037V21.45885a47.93751,47.93751,0,0,0-8.41788-.61591C103.67309,20.84294,102.34472,20.87528,100.9129,20.95462Z"/>
                        <path class="cls-4" d="M94.87955,13.29865c-8.53535,0-18.42531.73388-18.42531.73388V24.939a52.41512,52.41512,0,0,0,7.24635-.61445c4.383-.72454,11.53325-3.05438,17.21228-3.37,1.43183-.07935,2.76024-.11169,3.97382-.11169a47.934,47.934,0,0,1,8.41792.616V13.74329S103.72831,13.29865,94.87955,13.29865Z"/>
                        <path class="cls-5" d="M104.10456.00061a64.43537,64.43537,0,0,0-2.6283,9.25488,39.51381,39.51381,0,0,0-.687,4.10034c6.72951.11976,12.51539.38746,12.51539.38746V0Z"/>
                        <path class="cls-6" d="M101.47625,9.25549a64.40366,64.40366,0,0,1,2.6283-9.25407L76.45424.00081V14.03253s9.88995-.73389,18.4253-.73389c1.97325,0,3.9783.02283,5.90967.05719A39.51043,39.51043,0,0,1,101.47625,9.25549Z"/>
                        <path class="cls-7" d="M113.30461,13.74329l-.07617-.00348Z"/>
                        <path class="cls-8" d="M112.75442,13.719l-.08022-.00341Z"/>
                    </g>
                </svg>
            </div>
        </div>

        <!-- FILTER -->
        <div class="filter-container">
            <div class="filters">
                <div class="filter-group">
                    <label>Fach</label>
                    <select id="filterSubject"><option value="">Alle</option></select>
                </div>
                <div class="filter-group">
                    <label>Klasse</label>
                    <select id="filterGrade"><option value="">Alle</option></select>
                </div>
                <div class="filter-group">
    <label>Kompetenz</label>
    <select id="filterCompetence"><option value="">Alle</option></select>
</div>
<div class="filter-group">
    <label>Niveaustufe</label>
    <select id="filterLevel">
        <option value="">Alle</option>
        <option value="Niveaustufe 1">Niveaustufe 1</option>
        <option value="Niveaustufe 2">Niveaustufe 2</option>
        <option value="Niveaustufe 3">Niveaustufe 3</option>
        <option value="Niveaustufe 4">Niveaustufe 4</option>
        <option value="Niveaustufe 5">Niveaustufe 5</option>
    </select>
</div>
<div class="filter-group">
    <label>Tool</label>
    <select id="filterTool"><option value="">Alle</option></select>
</div>
                <div class="filter-group">
                    <label>Favoriten</label>
                    <select id="filterFavorite">
                        <option value="">Alle</option>
                        <option value="true">Nur Favoriten</option>
                    </select>
                </div>
                <div class="search-container">
                    <label>Thema</label>
                    <input type="text" id="searchTopic" class="search-input" placeholder="z.B. Klimawandel">
                    <div id="suggestions"></div>
                </div>
                <button class="reset-btn" onclick="resetFilters()">Reset</button>
            </div>
        </div>

        <!-- STATISTIK -->
        <div class="stats">
            <div class="stat-card"><div>Gesamt</div><span id="statTotal">0</span></div>
            <div class="stat-card"><div>Favoriten</div><span id="statFavorites">0</span></div>
            <div class="stat-card"><div>Tools</div><span id="statTools">0</span></div>
            <div class="stat-card"><div>Fächer</div><span id="statSubjects">0</span></div>
        </div>

         <!-- EXPORT – HORIZONTAL GRUPPIERT + FILTERABHÄNGIGKEIT KLAR -->
        <div class="export-buttons">
            <!-- GRUPPE 1: Filter-Exporte (CSV, PDF, Matrix) -->
            <div class="export-group horizontal">
                <h4 class="export-group-title" id="filterExportTitle">Filter-Exporte</h4>
                <div class="btn-row">
                    <button class="btn csv filtered-export" onclick="exportCSV()" 
                            title="Exportiert gefilterte Ressourcen als CSV (Fach, Klasse, Tool, etc.)">CSV</button>
                    <button class="btn pdf filtered-export" onclick="exportPDF()" 
                            title="Exportiert gefilterte Ressourcen als PDF (nur sichtbare Einträge)">PDF</button>
                    <button class="btn matrix filtered-export" onclick="exportMatrixCSV()" 
                            style="background:#e67e22;" 
                            title="Matrix als CSV – basierend auf aktuellen Filtern">Matrix CSV</button>
                    <button class="btn matrix filtered-export" onclick="exportMatrixPDF()" 
                            style="background:#9c27b0; color:white;" 
                            title="Matrix als PDF – nur gefilterte Daten">Matrix PDF</button>
                    <button class="btn matrix filtered-export" onclick="exportMatrixExcel()" 
                            style="background:#27ae60; color:white; border:2px solid #1e7e34;" 
                            title="Formatierte Excel-Matrix mit aktuellen Filtern">Matrix Excel</button>
                </div>
            </div>

            <!-- GRUPPE 2: Datenmanagement (unabhängig von Filtern) -->
            <div class="export-group horizontal">
                <h4 class="export-group-title">Datenmanagement</h4>
                <div class="btn-row">
                    <button class="btn print" onclick="printOptimized()"
                            title="Druckt die aktuelle Ansicht (unabhängig von Filtern)">Drucken</button>
                    <label class="btn import" title="Importiert neue Ressourcen aus einer CSV-Datei">
                        <input type="file" accept=".csv" class="file-input" onchange="importCSV(event)">
                        <span>Import</span>
                    </label>
                    <button class="btn template" onclick="exportTemplate()" 
                            title="Lädt eine leere CSV-Vorlage zum Ausfüllen">Vorlage</button>
                    <button class="btn" onclick="autoBackup()" 
                            title="Erstellt sofort ein lokales Backup aller Daten">Backup jetzt</button>
                </div>
            </div>
        </div>

<button class="new-resource-btn" onclick="openNewResourceWindow()">
    Neue Ressource
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
</button>

        <!-- RESSOURCEN + SIDEBAR -->
        <div class="content-wrapper">
            <div class="resources-container">
                <div id="resourcesList"></div>
            </div>
            <div class="sidebar">
                <h3>Fächer-Statistik</h3>
                <div style="margin: 12px 0; text-align:center;">
                <button id="schoolButton" class="new-resource-btn school-btn" onclick="setSchoolName()">
                <span id="schoolButtonText">Schule einstellen</span></button>
                </div>
                <div id="statsFach"></div>
            </div>
        </div>
    </div>

    <!-- SVG SYMBOLS -->
    <svg style="display:none">
        <symbol id="edit-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></symbol>
        <symbol id="delete-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        <symbol id="star-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></symbol>
    </svg>

    <script>
    // === DATEN & KONFIG ===
    let resources = JSON.parse(localStorage.getItem('resources') || '[]');
    const levels = new Set(resources.map(r => r.level).filter(Boolean));
const tools = new Set();
resources.forEach(r => {
    if (r.tool) {
        const trimmed = r.tool.trim();
        r.tool = trimmed; // Sicherstellen: immer getrimmt
        tools.add(trimmed.toLowerCase()); // Nur für Filter klein
    }
});

    const subjects = ["AWT", "Astronomie", "Biologie", "Chemie", "Deutsch", "Englisch", "Französisch", "Geografie", "Geschichte", "Gesellschaftskunde", "Informatik", "Italienisch", "Kunst", "Mathematik", "Musik", "Naturwissenschaften", "Physik", "Plattdeutsch", "Russisch", "Spanisch", "Sozialkunde", "Sport", "Wirtschaft"];
    const grades = Array.from({length: 13}, (_, i) => `Klasse ${i+1}`);
    const competences = [
        "Suchen, Verarbeiten und Aufbewahren",
        "Kommunizieren und Kooperieren",
        "Produzieren und Präsentieren",
        "Schützen und sicher Agieren",
        "Problemlösen und Handeln",
        "Analysieren und Reflektieren"
    ];

    // === HILFSFUNKTIONEN ===
    function escapeJs(str) {
        if (!str) return '';
        return str.replace(/'/g, "\\'").replace(/"/g, "\\\"");
    }

    function setFilterAndApply(filterId, value) {
        const select = document.getElementById(filterId);
        if (select) {
            select.value = value;
            applyFilters();
            document.querySelector('.filter-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // === DARK MODE ===
    function toggleDarkMode() {
        document.body.classList.toggle('dark');
        localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    }
    if (localStorage.getItem('darkMode') === 'true') toggleDarkMode();

    function getSchoolName() {
    return localStorage.getItem('schoolName');
}

// === SCHULNAME FÜR PDF + BUTTON ===
function updateSchoolButton() {
    const btn = document.getElementById('schoolButton');
    if (!btn) return;

    const name = getSchoolName();
    if (name) {
        btn.textContent = name;
        btn.title = 'Schulname ändern';
        btn.dataset.set = 'true';
    } else {
        btn.textContent = 'Schule einstellen';
        btn.title = 'Schulname festlegen';
        btn.dataset.set = 'false';
    }
}

function setSchoolName() {
    const current = getSchoolName();
    const name = prompt('Name der Schule eingeben:', current || '');
    
    if (name === null) return; // Abgebrochen
    if (name.trim() === '') {
        localStorage.removeItem('schoolName');
        showAlert('Schulname entfernt.');
    } else {
        localStorage.setItem('schoolName', name.trim());
        showAlert(`Schulname gespeichert:\n\n${name.trim()}`);
    }
    
    updateSchoolButton(); // Button sofort aktualisieren
}

// Beim Laden der Seite: Button aktualisieren
document.addEventListener('DOMContentLoaded', updateSchoolButton);

    // === DROPDOWNS ===
    function populateDropdowns() {
        const addOptions = (id, options) => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Alle</option>';
                options.forEach(opt => select.add(new Option(opt, opt)));
            }
        };
        addOptions('filterSubject', subjects);
        addOptions('filterGrade', grades);
        addOptions('filterCompetence', competences);
        updateToolFilter();
    }

function updateToolFilter() {
    const s = document.getElementById('filterTool');
    if (s) {
        s.innerHTML = '<option value="">Alle</option>';
        // Original-Tools aus resources holen (für korrekte Großschreibung)
        const uniqueTools = [...new Set(resources.map(r => r.tool).filter(Boolean))];
        uniqueTools.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' })).forEach(tool => {
            s.add(new Option(tool, tool.toLowerCase()));
        });
    }
}

    function updateStats() {
        const filtered = getFilteredResources();
        document.getElementById('statTotal').textContent = filtered.length;
        document.getElementById('statFavorites').textContent = filtered.filter(r => r.favorite).length;
        document.getElementById('statTools').textContent = [...new Set(filtered.map(r => r.tool).filter(Boolean))].length;
        document.getElementById('statSubjects').textContent = [...new Set(filtered.map(r => r.subject))].length;
        updateSubjectBarStats(filtered);
    }

    function updateSubjectBarStats(filtered) {
        const count = filtered.reduce((a, r) => (a[r.subject] = (a[r.subject] || 0) + 1, a), {});
        const container = document.getElementById('statsFach');
        if (!container) return;
        container.innerHTML = '';
        const max = Math.max(...Object.values(count)) || 1;
        Object.entries(count)
            .sort((a, b) => b[1] - a[1])
            .forEach(([k, v]) => {
                const div = document.createElement('div');
                div.className = 'stat-bar';
                div.innerHTML = `
                    <label>${k} <span class="bar-value">${v}</span></label>
                    <div class="bar-container">
                        <div class="bar" style="width:${(v / max * 100)}%"></div>
                    </div>`;
                container.appendChild(div);
            });
    }

    // === EINMALIGE HILFSFUNKTION: Gefilterte Ressourcen zurückgeben ===
function getFilteredResources() {
    const f = {
        subject: document.getElementById('filterSubject')?.value?.toLowerCase() || '',
        grade: document.getElementById('filterGrade')?.value || '',
        competence: document.getElementById('filterCompetence')?.value || '',
        level: document.getElementById('filterLevel')?.value || '',
        tool: document.getElementById('filterTool')?.value?.toLowerCase() || '',
        favorite: document.getElementById('filterFavorite')?.value === 'true',
        topic: document.getElementById('searchTopic')?.value?.toLowerCase().trim() || ''
    };

    return resources.filter(r => {
        const topic = r.topic?.toLowerCase() || '';
        const subject = r.subject?.toLowerCase() || '';
        const grade = r.grade || '';
        const competence = r.competence || '';
        const level = r.level || '';
        const tool = r.tool?.toLowerCase() || '';
        const isFavorite = r.favorite || false;

        if (f.subject && subject !== f.subject) return false;
        if (f.grade && grade !== f.grade) return false;
        if (f.competence && competence !== f.competence) return false;
        if (f.level && level !== f.level) return false;
        if (f.tool && tool !== f.tool) return false;
        if (f.favorite && !isFavorite) return false;
        if (f.topic && !topic.includes(f.topic)) return false;
        return true;
    });
}

    // === FILTER & ANZEIGE ===
function applyFilters() {
    const filtered = getFilteredResources();
    displayResources(filtered);
    updateStats();
    updateFilterHighlight();
    updateFilterStatus();
}
// === FILTER-HIGHLIGHT: Färbe .filter-container bei aktivem Filter ===
function updateFilterHighlight() {
    const container = document.querySelector('.filter-container');
    if (!container) return;
    const selects = container.querySelectorAll('select');
    const search = container.querySelector('#searchTopic');
    const isActive = Array.from(selects).some(s => s.value && s.value !== '') ||
                     (search && search.value.trim() !== '');
    container.classList.toggle('active', isActive);
}

// === FILTER-STATUS FÜR EXPORT-BUTTONS ===
function updateFilterStatus() {
    const isFiltered = getFilteredResources().length < resources.length;
    const title = document.getElementById('filterExportTitle');
    if (title) {
        title.textContent = isFiltered ? 'Filter-Exporte (aktiv)' : 'Filter-Exporte';
        title.style.color = isFiltered ? '#e74c3c' : 'var(--primary)';
    }
    document.querySelectorAll('.filtered-export').forEach(btn => {
        btn.classList.toggle('active', isFiltered);
    });
}

// Wird bei jedem Filterwechsel aufgerufen
const originalApplyFilters = applyFilters;
window.applyFilters = function() {
    originalApplyFilters();
    updateFilterHighlight();
    updateFilterStatus();
};

// Beim Laden prüfen
document.addEventListener('DOMContentLoaded', () => {
    populateDropdowns();
    applyFilters();
});

    function resetFilters() {
        ['filterSubject','filterGrade','filterCompetence','filterLevel','filterTool','filterFavorite'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        const search = document.getElementById('searchTopic');
        if (search) search.value = '';
        applyFilters();
    }

function showAlert(message, callback) {
    const modal = document.createElement('div');
    modal.className = 'modal-outer';
    modal.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.6);display:flex;justify-content:center;
        align-items:center;z-index:10001;
    `;
    modal.innerHTML = `
        <div style="
            background:#fff;padding:24px;border-radius:16px;max-width:400px;
            text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.2);
        ">
            <p style="margin:0 0 16px;white-space:pre-line;line-height:1.5;">
                ${message.replace(/\n/g, '<br>')}
            </p>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button id="alert-ok-btn" 
                        style="background:#6b46c1;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">
                    OK
                </button>
                ${callback ? `
                <button id="alert-cancel-btn" 
                        style="background:#95a5a6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">
                    Abbrechen
                </button>` : ''}
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    const removeModal = () => modal.remove();

    // Jetzt mit korrekten IDs!
    modal.querySelector('#alert-ok-btn')?.addEventListener('click', () => {
        removeModal();
        if (callback) callback();
    });

    modal.querySelector('#alert-cancel-btn')?.addEventListener('click', removeModal);

    // Optional: ESC zum Abbrechen
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            removeModal();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
}

function toggleFavorite(i) {
    resources[i].favorite = !resources[i].favorite;
    localStorage.setItem('resources', JSON.stringify(resources)); // JETZT DA!
    applyFilters();
}

function displayResources(list) {
    const c = document.getElementById('resourcesList');
    if (!c) return;
    c.innerHTML = '';
    list.forEach((r, i) => {
        // SICHERER INDEX: Vergleich aller Felder
        const realIndex = resources.findIndex(res => 
            res.topic === r.topic && 
            res.subject === r.subject && 
            res.grade === r.grade && 
            res.competence === r.competence &&
            (res.tool || '') === (r.tool || '') &&
            (res.description || '') === (r.description || '')
        );

        const d = document.createElement('div');
        d.className = 'resource-item';
        d.dataset.index = realIndex >= 0 ? realIndex : i; // Fallback

        d.innerHTML = `
            <div class="resource-content">
                <strong>${r.topic}</strong>
                <span class="tag subject-tag" onclick="setFilterAndApply('filterSubject', '${escapeJs(r.subject)}')">${r.subject}</span>
                <span class="tag grade-tag" onclick="setFilterAndApply('filterGrade', '${escapeJs(r.grade)}')">${r.grade}</span>
                <span class="tag competence-tag" onclick="setFilterAndApply('filterCompetence', '${escapeJs(r.competence)}')">${r.competence}</span>
                <span class="tag level-tag">${r.level || '—'}</span>
               ${r.tool ? `<span class="tag tool-tag" onclick="setFilterAndApply('filterTool', '${escapeJs(r.tool.toLowerCase())}')">${escapeJs(r.tool)}</span>` : ''}
                ${r.description ? `<div class="description">${r.description}</div>` : ''}
                ${r.lastModified ? `<div style="font-size:11px; color:#888; margin-top:6px;">Zuletzt: ${r.lastModified}</div>` : ''}
            </div>
            <div class="action-icons">
                <div class="action-icon favorite-icon ${r.favorite ? 'active' : ''}"
                     onclick="toggleFavorite(${realIndex})">
                    <svg><use xlink:href="#star-icon"/></svg>
                </div>
                <div class="action-icon edit-icon"
                     onclick="editResource(${realIndex})">
                    <svg><use xlink:href="#edit-icon"/></svg>
                </div>
                <div class="action-icon delete-icon"
                     onclick="deleteResource(${realIndex})">
                    <svg><use xlink:href="#delete-icon"/></svg>
                </div>
            </div>`;
        c.appendChild(d);
    });
}

    // === BEARBEITEN ===
    function editResource(i) {
        const r = resources[i];
        const data = encodeURIComponent(JSON.stringify(r));
        const url = `edit-resource.html?index=${i}&data=${data}`;
        const popup = window.open(url, 'editResource', 'width=680,height=760,resizable=yes,scrollbars=yes');
        if (popup) {
            popup.focus();
        } else {
            alert('Popup wurde blockiert – bitte erlauben!');
        }
    }
// === NEUE RESSOURCE IM POPUP ===
function openNewResourcePopup() {
    const url = 'new-resource.html';
    const popup = window.open(url, 'newResource', 'width=680,height=760,resizable=yes,scrollbars=yes');
    if (popup) {
        popup.focus();
    } else {
        alert('Popup wurde blockiert – bitte erlauben!');
    }
}

function deleteResource(i) {
    const resource = resources[i];
    if (!resource) return;

    // Bestätigungs-Popup
    showAlert(
        `Möchtest du die Ressource wirklich löschen?\n\n` +
        `<strong>${resource.topic}</strong>\n` +
        `${resource.subject} | ${resource.grade} | ${resource.competence}${resource.level ? ' | ' + resource.level : ''}`,
        () => {
            // Bestätigt → Löschen mit Animation
            const anim = document.getElementById('deleteAnimation');
            anim.classList.add('delete-active');

            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBQ==');
                audio.volume = 0.2;
                audio.play();
            } catch(e) {}

            setTimeout(() => {
                resources.splice(i, 1);
                localStorage.setItem('resources', JSON.stringify(resources));
                applyFilters();
                anim.classList.remove('delete-active');
            }, 1600);
        }
    );
}

    // === AUTOCOMPLETE ===
    const searchInput = document.getElementById('searchTopic');
    const suggestions = document.getElementById('suggestions');
    if (searchInput && suggestions) {
        searchInput.oninput = e => {
            suggestions.innerHTML = '';
            const v = e.target.value.toLowerCase().trim();
            if (!v) { suggestions.style.display = 'none'; return; }
            const m = [...new Set(resources.map(r => r.topic).filter(t => t.toLowerCase().includes(v)))].slice(0, 6);
            if (!m.length) { suggestions.style.display = 'none'; return; }
            m.forEach(t => {
                const d = document.createElement('div');
                d.textContent = t;
                d.onclick = () => { searchInput.value = t; suggestions.style.display = 'none'; applyFilters(); };
                suggestions.appendChild(d);
            });
            suggestions.style.display = 'block';
        };
        document.addEventListener('click', e => {
            if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });
    }

    // === CSV-IMPORT (KORRIGIERT & VERBESSERT) ===
function importCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split(/\r\n|\n|\r/).map(l => l.trim()).filter(l => l);
        if (lines.length === 0) {
            showAlert("Die CSV-Datei ist leer!");
            return;
        }

        const parsed = parseCSV(lines);
        if (!parsed || parsed.data.length === 0) {
            showAlert("Keine gültigen Daten in der CSV gefunden!");
            return;
        }

        const { header, data } = parsed;

        // === PRÜFEN: Mindestens die 4 Pflichtfelder vorhanden? ===
        const required = ['Thema', 'Unterrichtsfach', 'Klassenstufe', 'Kompetenzbereich'];
        const missing = required.filter(col => !header.includes(col));
        if (missing.length > 0) {
            showAlert(
                `Fehlende Pflichtspalten: ${missing.join(', ')}\n\n` +
                `Gefundene Spalten: ${header.join(', ')}\n\n` +
                `Tipp: Verwende die Vorlage (Button "Vorlage")!`
            );
            return;
        }

        // === VORSCHAU ===
        const previewLines = data.slice(0, 8).map(row => 
            `${row.Thema || ''} | ${row.Unterrichtsfach || ''} | ${row.Klassenstufe || ''} | ${row.Kompetenzbereich || ''} | ${row.Niveaustufe || ''} | ${row.Digitales_Hilfsmittel || ''}`
        ).join('\n');

        const total = data.length;
        if (!confirm(
            `Vorschau (max. 8 Zeilen):\n\n${previewLines}\n${total > 8 ? `\n... und ${total - 8} weitere` : ''}\n\n` +
            `Importieren? (${total} Ressourcen)`
        )) return;

        importWithProgress(data);
    };
    reader.readAsText(file, 'UTF-8');
}
// === CSV-PARSER (ROBUST & KORREKT) ===
function parseCSV(lines) {
    const result = { header: [], data: [] };
    if (lines.length === 0) return result;

    // --- HEADER ---
    let headerLine = lines[0];
    result.header = splitCSVLine(headerLine);

    // --- DATEN ---
    for (let i = 1; i < lines.length; i++) {
        const row = {};
        const cells = splitCSVLine(lines[i]);
        result.header.forEach((key, idx) => {
            const normalizedKey = normalizeHeader(key);
            row[normalizedKey] = (cells[idx] || '').trim();
        });
        if (row.Thema) result.data.push(row); // Nur Zeilen mit Thema
    }

    return result;
}
// === HELFER: CSV-ZEILE SPLITTEN (MIT ANFÜHRUNGSZEICHEN) ===
function splitCSVLine(line) {
    const result = [];
    let cell = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                cell += '"';
                i++; // Überspringe doppeltes ""
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(cell);
            cell = '';
        } else {
            cell += char;
        }
    }
    result.push(cell);
    return result;
}
// === HEADER NORMALISIERUNG (FÜR FLEXIBILITÄT) ===
function normalizeHeader(str) {
    return str
        .replace(/Digitales Hilfsmittel/g, 'Digitales_Hilfsmittel')
        .replace(/Beschreibung/g, 'Beschreibung')
        .replace(/Niveaustufe/g, 'Niveaustufe')
        .replace(/Klassenstufe/g, 'Klassenstufe')
        .replace(/Kompetenzbereich/g, 'Kompetenzbereich')
        .replace(/Unterrichtsfach/g, 'Unterrichtsfach')
        .replace(/[^a-zA-Z0-9_ÄÖÜäöüß]/g, '_'); // Sonderzeichen → _
}
// === GLOBAL: importCSV für onchange ===
window.importCSV = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split(/\r\n|\n|\r/).map(l => l.trim()).filter(l => l);
        if (lines.length === 0) {
            showAlert("Die CSV-Datei ist leer!");
            return;
        }
        const parsed = parseCSV(lines);
        if (!parsed || parsed.data.length === 0) {
            showAlert("Keine gültigen Daten in der CSV gefunden!");
            return;
        }
        const { header, data } = parsed;
        const required = ['Thema', 'Unterrichtsfach', 'Klassenstufe', 'Kompetenzbereich'];
        const missing = required.filter(col => !header.includes(col));
        if (missing.length > 0) {
            showAlert(
                `Fehlende Pflichtspalten: ${missing.join(', ')}\n\n` +
                `Gefundene Spalten: ${header.join(', ')}\n\n` +
                `Tipp: Verwende die Vorlage!`
            );
            return;
        }
        const previewLines = data.slice(0, 8).map(row =>
            `${row.Thema || ''} | ${row.Unterrichtsfach || ''} | ${row.Klassenstufe || ''} | ${row.Kompetenzbereich || ''}`
        ).join('\n');
        const total = data.length;
        if (!confirm(`Vorschau (max. 8 Zeilen):\n\n${previewLines}\n${total > 8 ? `\n... und ${total - 8} weitere` : ''}\n\nImportieren? (${total} Ressourcen)`)) return;
        importWithProgress(data);
    };
    reader.readAsText(file, 'UTF-8');
};

function exportTemplate() {
    const template = [
        'Thema,Unterrichtsfach,Klassenstufe,Kompetenzbereich,Niveaustufe,Digitales Hilfsmittel,Beschreibung',
        'Beispiel: Klimawandel,Geografie,Klasse 7,Analysieren und Reflektieren,Niveaustufe 3,Google Earth,"Beschreibung des Einsatzes..."'
    ].join('\n');

    const blob = new Blob(['\uFEFF' + template], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Lerndashboard_Vorlage.csv';
    link.click();
}

function applyFilters() {
    const filtered = getFilteredResources();
    displayResources(filtered);
    updateStats();                  // ← Statistiken mit gefilterten Daten
    updateFilterHighlight();        // ← Filter-Container rot
    updateFilterStatus();           // ← "Filter-Exporte (aktiv)" + Button-Puls
}

function exportCSV() {
    const filtered = getFilteredResources();
    if (filtered.length === 0) {
        showAlert("Keine gefilterten Daten zum Exportieren!\nTipp: Filter zurücksetzen oder Daten prüfen.");
        return;
    }

    const COLUMNS = ['Thema', 'Unterrichtsfach', 'Klassenstufe', 'Kompetenzbereich', 'Niveaustufe', 'Digitales_Hilfsmittel', 'Beschreibung'];
    const csvContent = filtered.map(r => [
        `"${(r.topic || '').replace(/"/g, '""')}"`,
        `"${(r.subject || '')}"`,
        `"${(r.grade || '')}"`,
        `"${(r.competence || '')}"`,
        `"${(r.level || '')}"`,
        `"${(r.tool || '').replace(/"/g, '""')}"`,
        `"${(r.description || '').replace(/"/g, '""')}"`
    ].join(',')).join('\n');

    const fullCsv = `${COLUMNS.join(',')}\n${csvContent}`;
    const blob = new Blob(['\uFEFF' + fullCsv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `LernDashboard_Gefiltert_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
}

function exportPDF() {
    const filtered = getFilteredResources();
    if (filtered.length === 0) {
        showAlert("Keine gefilterten Daten zum Exportieren!\nTipp: Filter zurücksetzen oder Daten prüfen.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let y = 30;
    const lineHeight = 6;
    const startX = 15;
    let pageNumber = 1;

    // Schulname
    const schoolName = getSchoolName() || 'Deine Schule';
    doc.setFontSize(11);
    doc.setTextColor(schoolName === 'Deine Schule' ? 150 : 80);
    doc.setFont('helvetica', 'italic');
    doc.text(schoolName, pageWidth - 15, 15, { align: 'right' });

    // Titel
    doc.setFontSize(20);
    doc.setTextColor(107, 70, 193);
    doc.setFont('helvetica', 'bold');
    doc.text('LernDashboard Digital', pageWidth / 2, y, { align: 'center' });
    y += 8;
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text('Gefilterte Unterrichtsideen', pageWidth / 2, y, { align: 'center' });
    y += 10;
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text(`Exportiert am: ${new Date().toLocaleDateString('de-DE')}`, pageWidth - 15, y, { align: 'right' });
    y += 12;

    const addPageIfNeeded = (h) => {
        if (y + h > pageHeight - 25) {
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Seite ${pageNumber}`, pageWidth - 20, pageHeight - 10);
            doc.addPage();
            pageNumber++;
            y = 20;
            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text('LernDashboard Digital – Fortsetzung', pageWidth / 2, y, { align: 'center' });
            y += 8;
        }
    };

    const tagColors = { subject: [155,89,182], grade: [80,200,120], competence: [255,140,0], level: [0,191,255], tool: [30,144,255] };

    filtered.forEach((r, i) => {
        const topic = r.topic || '—';
        const subject = r.subject || '—';
        const grade = r.grade || '—';
        const competence = r.competence || '—';
        const level = r.level || '—';
        const tool = r.tool || '—';
        const description = r.description || '';

        doc.setFontSize(11);
        doc.setTextColor(0);
        doc.setFont('helvetica', 'bold');
        const topicLines = doc.splitTextToSize(`${i + 1}. ${topic}`, pageWidth - 30);
        addPageIfNeeded(topicLines.length * lineHeight + 5);
        doc.text(topicLines, startX, y);
        y += topicLines.length * lineHeight + 3;

        let x = startX;
        const tagHeight = 5, tagPadding = 2, tagGap = 6, textY = y - 0.7;
        const tags = [{text:subject,type:'subject'},{text:grade,type:'grade'},{text:competence,type:'competence'},{text:level,type:'level'},{text:tool,type:'tool'}];
        doc.setFontSize(8.5);
        doc.setFont('helvetica', 'normal');
        tags.forEach(tag => {
            if (tag.text === '—') return;
            const color = tagColors[tag.type];
            const textWidth = doc.getTextWidth(tag.text);
            const tagWidth = textWidth + 2 * tagPadding;
            doc.setFillColor(...color);
            doc.roundedRect(x, y - tagHeight + 0.8, tagWidth, tagHeight, 1.8, 1.8, 'F');
            doc.setTextColor(255);
            doc.text(tag.text, x + tagPadding, textY);
            x += tagWidth + tagGap;
        });
        y += 6;

        if (description) {
            doc.setFontSize(9);
            doc.setTextColor(70);
            doc.setFont('helvetica', 'italic');
            const descLines = doc.splitTextToSize(description, pageWidth - 30);
            const descHeight = descLines.length * lineHeight;
            addPageIfNeeded(descHeight + 8);
            doc.setFillColor(248, 250, 252);
            doc.rect(startX - 1, y - 1.5, pageWidth - 30 + 2, descHeight + 3, 'F');
            doc.text(descLines, startX, y + lineHeight - 1);
            y += descHeight + 6;
        } else y += 4;

        doc.setDrawColor(220);
        doc.setLineWidth(0.3);
        doc.line(startX, y, pageWidth - 15, y);
        y += 8;
    });

    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(`Seite ${pageNumber}`, pageWidth - 20, pageHeight - 10);
    doc.save(`LernDashboard_Gefiltert_${new Date().toISOString().slice(0, 10)}.pdf`);
}

// === BEARB. BESTÄTIGUNG (ohne Ton) ===
function showEditConfirmation() {
    const anim = document.getElementById('editAnimation');
    anim.classList.add('edit-active');

    // Nach 1,6 Sekunden automatisch ausblenden
    setTimeout(() => {
        anim.classList.remove('edit-active');
    }, 1600);
}
        // === HINZUFÜGEN BESTÄTIGUNG ===
function showAddConfirmation() {
    const anim = document.getElementById('addAnimation');
    anim.classList.add('add-active');
    setTimeout(() => anim.classList.remove('add-active'), 1600);
}
    // === INIT ===
    ['filterSubject','filterGrade','filterTool','filterCompetence','filterLevel','filterFavorite'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', applyFilters);
    });
    const searchEl = document.getElementById('searchTopic');
    if (searchEl) searchEl.addEventListener('input', applyFilters);

if (!navigator.onLine) {
    showAlert('Offline-Modus aktiv – Änderungen werden lokal gespeichert.');
}

window.addEventListener('online', () => {
    showAlert('Internetverbindung wiederhergestellt.');
});
window.addEventListener('offline', () => {
    showAlert('Offline-Modus aktiv – Änderungen werden lokal gespeichert.');
});
    populateDropdowns();
    applyFilters();

// === POPUP-KOMMUNIKATION (NEU + UPDATE) ===
window.addEventListener('message', function(event) {
    // NEUE RESSOURCE HINZUFÜGEN
    if (event.data?.action === 'addResource') {
        const resource = event.data.resource;
        if (resource && resource.topic && resource.subject && resource.grade && resource.competence && resource.level) {
            // Tool: Originalgroßschreibung beibehalten, nur für Filter klein
            const originalTool = resource.tool?.trim();
            if (originalTool) {
                resource.tool = originalTool;
                tools.add(originalTool.toLowerCase());
            }
            resources.push(resource);
            localStorage.setItem('resources', JSON.stringify(resources));
            applyFilters();
            updateToolFilter();
            showAddConfirmation();
        }
    }
    // RESSOURCE AKTUALISIEREN
    else if (event.data?.action === 'updateResource') {
        const { index, resource } = event.data;
        if (index >= 0 && index < resources.length && resource) {
            const originalTool = resource.tool?.trim();
            if (originalTool) {
                resource.tool = originalTool;
                tools.add(originalTool.toLowerCase());
            }
            resources[index] = resource;
            localStorage.setItem('resources', JSON.stringify(resources));
            applyFilters();
            updateToolFilter();
            showEditConfirmation();
        }
    }
});

// === CHROME TOOLTIP-FIX BEIM DRUCKEN ===
let printTooltipFix = false;
window.addEventListener('beforeprint', () => {
    printTooltipFix = true;  // Flag setzen
    // Sofort Tooltips ausblenden
    document.querySelectorAll('.btn[title]').forEach(btn => {
        btn.blur();  // Hover "abbrechen"
    });
});

window.addEventListener('afterprint', () => {
    printTooltipFix = false;
    // Tooltip-Container leeren (falls sichtbar)
    document.querySelectorAll('::after, ::before').forEach(el => el.remove());  // Fallback-Cleanup
    // Oder: Hover manuell zurücksetzen
    document.body.style.cursor = 'default';
});

 // Nur bei HTTP/HTTPS aktivieren (nicht bei file://)
if ('serviceWorker' in navigator && (location.protocol === 'http:' || location.protocol === 'https:')) {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
        reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker?.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    showAlert('Aktualisierung wird geladen...');
                    setTimeout(() => window.location.reload(), 1200);
                }
            });
        });
    }).catch(err => {
        console.warn('Service Worker Registrierung fehlgeschlagen (lokal):', err);
    });
}
  function openNewResourceWindow() {
    const url = 'new-resource.html';
    const popup = window.open(url, 'newResource', 'width=680,height=760,resizable=yes,scrollbars=yes');
    if (popup) {
        popup.focus();
    } else {
        alert('Popup wurde blockiert – bitte erlauben!');
    }
}
function exportMatrixPDF() {
    const { jsPDF } = window.jspdf;
    const filtered = getFilteredResources();
    if (filtered.length === 0) {
        showAlert("Keine passenden Ressourcen für die Matrix!\nTipp: Filter zurücksetzen oder Daten prüfen.");
        return;
    }

    const doc = new jsPDF('l', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // === LAYOUT ===
    const leftMargin = 12;
    const rightMargin = 12;
    const topMargin = 18;
    const usableWidth = pageWidth - leftMargin - rightMargin;
    const compColWidth = usableWidth * 0.22;
    const levelColWidth = (usableWidth - compColWidth) / 5;
    let currentY = topMargin;

    // === TITEL ===
    const subjectFilter = document.getElementById('filterSubject')?.value?.trim() || '';
    const gradeFilter = document.getElementById('filterGrade')?.value?.trim() || '';
    const toolFilter = document.getElementById('filterTool')?.value?.trim().toLowerCase() || '';
    const subjectText = subjectFilter ? subjectFilter : 'Alle Fächer';
    let gradeText = gradeFilter ? gradeFilter : 'Alle Klassen';
    const toolText = toolFilter ? ` | Tool: ${toolFilter}` : '';
    const title = `${subjectText} | ${gradeText}${toolText}`;

    doc.setFontSize(16);
    doc.setTextColor(107, 70, 193);
    doc.setFont('helvetica', 'bold');
    doc.text(title, pageWidth / 2, currentY, { align: 'center' });
    currentY += 7;

    // === KOPFZEILE: Schulname links, Datum rechts ===
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.setFont('helvetica', 'italic');
    const schoolName = localStorage.getItem('schoolName') || 'Deine Schule';
    doc.text(schoolName, leftMargin, currentY - 8);
    const exportDate = `Export: ${new Date().toLocaleDateString('de-DE')}`;
    doc.text(exportDate, pageWidth - rightMargin, currentY - 8, { align: 'right' });
    currentY += 5; // Abstand zur Tabelle

    // === DATEN ===
    const competences = [
        "Suchen, Verarbeiten und Aufbewahren",
        "Kommunizieren und Kooperieren",
        "Produzieren und Präsentieren",
        "Schützen und sicher Agieren",
        "Problemlösen und Handeln",
        "Analysieren und Reflektieren"
    ];
    const levels = ["Niveaustufe 1", "Niveaustufe 2", "Niveaustufe 3", "Niveaustufe 4", "Niveaustufe 5"];
    const levelColors = [
        [139, 195, 74], [76, 175, 80], [255, 193, 7], [255, 152, 0], [244, 67, 54]
    ];

    const matrix = {};
    competences.forEach(c => {
        matrix[c] = {};
        levels.forEach(l => matrix[c][l] = []);
    });

    // === DATEN FÜLLEN ===
    resources.forEach(r => {
        const subject = r.subject?.trim();
        const grade = r.grade?.trim();
        const tool = r.tool?.trim().toLowerCase();
        const comp = r.competence?.trim();
        const level = r.level?.trim();
        const topic = r.topic?.trim();
        if (!comp || !level || !topic) return;

        const matchesSubject = !subjectFilter || subject === subjectFilter;
        const matchesGrade = !gradeFilter || grade === gradeFilter;
        const matchesTool = !toolFilter || tool === toolFilter;

        if (matchesSubject && matchesGrade && matchesTool) {
            matrix[comp][level].push(`${topic}\nKlasse ${grade}${r.tool ? ` – ${r.tool}` : ''}`);
        }
    });

    // === HELFER ===
    const drawLine = (x1, y1, x2, y2) => {
        doc.setDrawColor(180);
        doc.setLineWidth(0.25);
        doc.line(x1, y1, x2, y2);
    };

    const drawHeader = (y) => {
        const h = 11;
        let x = leftMargin;

        doc.setFillColor(107, 70, 193);
        doc.rect(x, y, compColWidth, h, 'F');
        doc.setTextColor(255);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('Kompetenz', x + 4, y + 7.5);
        x += compColWidth;

        levels.forEach((lvl, i) => {
            doc.setFillColor(...levelColors[i]);
            doc.rect(x, y, levelColWidth, h, 'F');
            doc.setTextColor(255);
            const lines = doc.splitTextToSize(lvl, levelColWidth - 8);
            const lineHeight = 3.8;
            const startY = y + (h - lines.length * lineHeight) / 2 + lineHeight;
            doc.text(lines, x + levelColWidth / 2, startY, { align: 'center' });
            x += levelColWidth;
        });

        doc.setDrawColor(120);
        doc.setLineWidth(0.5);
        doc.line(leftMargin, y + h, pageWidth - rightMargin, y + h);
        return y + h;
    };

    // === HELFER: Zentrierter Text ===
    const drawCenteredText = (textLines, x, y, width, height, lineHeight, isBold = false) => {
        const totalTextHeight = textLines.length * lineHeight;
        const startY = y + (height - totalTextHeight) / 2 + lineHeight * 0.7;
        doc.setFont('helvetica', isBold ? 'bold' : 'normal');
        doc.text(textLines, x, startY);
    };

    // === HEADER ===
    let headerBottom = drawHeader(currentY);
    currentY = headerBottom;

    // === ZEILEN ===
    const COMP_FONT_SIZE = 9.5;
    const LEVEL_FONT_SIZE = 8.0;
    const LINE_HEIGHT_FACTOR = 1.2;
    const MIN_ROW_HEIGHT = 16;  // Erhöht
    const LINE_HEIGHT_COMP = COMP_FONT_SIZE * LINE_HEIGHT_FACTOR * 0.3528;
    const LINE_HEIGHT_LEVEL = LEVEL_FONT_SIZE * LINE_HEIGHT_FACTOR * 0.3528;

    competences.forEach((comp) => {
        // 1. Kompetenz-Text
        const compLines = doc.splitTextToSize(comp, compColWidth - 8);
        const compTextHeight = compLines.length * LINE_HEIGHT_COMP;

        // 2. Level-Texte: Exakte Höhe
        let maxLevelTextHeight = 0;
        levels.forEach(l => {
            const entries = matrix[comp][l];
            const rawText = entries.length > 0 ? entries.join('\n\n') : '—';
            const lines = doc.splitTextToSize(rawText, levelColWidth - 8);
            const height = lines.length * LINE_HEIGHT_LEVEL;
            if (height > maxLevelTextHeight) maxLevelTextHeight = height;
        });

        // 3. Zeilenhöhe
        const maxTextHeight = Math.max(compTextHeight, maxLevelTextHeight);
        const rowHeight = Math.max(MIN_ROW_HEIGHT, maxTextHeight + 8);  // +8 Puffer

        // === SEITENUMBRUCH ===
        if (currentY + rowHeight > pageHeight - 20) {
            drawLine(leftMargin, headerBottom - 3, leftMargin, currentY);
            drawLine(pageWidth - rightMargin, headerBottom - 3, pageWidth - rightMargin, currentY);
            doc.addPage();
            currentY = topMargin;
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Fortsetzung – Seite ${doc.getCurrentPageInfo().pageNumber}`, pageWidth - rightMargin, currentY, { align: 'right' });
            currentY += 8;
            headerBottom = drawHeader(currentY);
            currentY = headerBottom;
        }

        const rowY = currentY;
        let x = leftMargin;

        // === KOMPETENZ ZELLE ===
        doc.setFillColor(248, 249, 255);
        doc.rect(x, rowY, compColWidth, rowHeight, 'F');
        doc.setTextColor(0);
        doc.setFontSize(COMP_FONT_SIZE);
        drawCenteredText(compLines, x + 4, rowY, compColWidth, rowHeight, LINE_HEIGHT_COMP, true);
        drawLine(x + compColWidth, rowY, x + compColWidth, rowY + rowHeight);
        x += compColWidth;

        // === LEVEL ZELLEN ===
        levels.forEach((lvl, j) => {
            const entries = matrix[comp][lvl];
            const rawText = entries.length > 0 ? entries.join('\n\n') : '—';
            const lines = doc.splitTextToSize(rawText, levelColWidth - 8);

            doc.setFillColor(255, 255, 255);
            doc.rect(x, rowY, levelColWidth, rowHeight, 'F');
            doc.setTextColor(60);
            doc.setFontSize(LEVEL_FONT_SIZE);
            drawCenteredText(lines, x + 4, rowY, levelColWidth, rowHeight, LINE_HEIGHT_LEVEL, false);

            if (j < 4) drawLine(x + levelColWidth, rowY, x + levelColWidth, rowY + rowHeight);
            x += levelColWidth;
        });

        drawLine(leftMargin, rowY + rowHeight, pageWidth - rightMargin, rowY + rowHeight);
        currentY += rowHeight;
    });

    // === LETZTE LINIEN ===
    drawLine(leftMargin, headerBottom - 3, leftMargin, currentY);
    drawLine(pageWidth - rightMargin, headerBottom - 3, pageWidth - rightMargin, currentY);

    // === SEITENZAHL ===
    const totalPages = doc.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.setTextColor(150);
        doc.text(`Seite ${i}`, pageWidth - rightMargin, pageHeight - 8, { align: 'right' });
    }

    doc.save(`LernDashboard_Matrix_${new Date().toISOString().slice(0, 10)}.pdf`);
}
function exportMatrixExcel() {
    if (resources.length === 0) {
        showAlert("Keine Daten zum Exportieren!");
        return;
    }

    const subjectFilter = document.getElementById('filterSubject')?.value?.trim() || '';
    const gradeFilter = document.getElementById('filterGrade')?.value?.trim() || '';
    const toolFilter = document.getElementById('filterTool')?.value?.trim().toLowerCase() || '';
    const subjectText = subjectFilter ? subjectFilter : 'Alle Fächer';
    const gradeText = gradeFilter ? gradeFilter : 'Alle Klassen';
    const toolText = toolFilter ? ` | Tool: ${toolFilter}` : '';
    const title = `${subjectText} | ${gradeText}${toolText}`;

    const competences = [
        "Suchen, Verarbeiten und Aufbewahren",
        "Kommunizieren und Kooperieren",
        "Produzieren und Präsentieren",
        "Schützen und sicher Agieren",
        "Problemlösen und Handeln",
        "Analysieren und Reflektieren"
    ];
    const levels = ["Niveaustufe 1", "Niveaustufe 2", "Niveaustufe 3", "Niveaustufe 4", "Niveaustufe 5"];

    const levelRGB = {
        "Niveaustufe 1": "8BC34A",
        "Niveaustufe 2": "4CAF50",
        "Niveaustufe 3": "FFC107",
        "Niveaustufe 4": "FF9800",
        "Niveaustufe 5": "F44336"
    };

    // === MATRIX AUFBAUEN ===
    const matrix = {};
    competences.forEach(c => {
        matrix[c] = {};
        levels.forEach(l => matrix[c][l] = []);
    });

    resources.forEach(r => {
        const s = r.subject?.trim();
        const g = r.grade?.trim();
        const t = r.tool?.trim();
        const c = r.competence?.trim();
        const l = r.level?.trim();
        const topic = r.topic?.trim();
        if (!c || !l || !topic) return;

        const matchS = !subjectFilter || s === subjectFilter;
        const matchG = !gradeFilter || g === gradeFilter;
        const matchT = !toolFilter || (t && t.toLowerCase() === toolFilter);

        if (matchS && matchG && matchT) {
            const entry = `${topic}\nKlasse ${g}${t ? ` – ${t}` : ''}`;
            matrix[c][l].push(entry);
        }
    });

    // === DATEN FÜR EXCEL ===
    const data = [];
    data.push([title]);                     // A1: Titel
    data.push([]);                          // A2: Leer
    data.push(["Kompetenz", ...levels]);    // A3–F3: Header

    competences.forEach(comp => {
        const row = [comp];
        levels.forEach(lvl => {
            const entries = matrix[comp][lvl];
            row.push(entries.length > 0 ? entries.join('\n\n') : '—');
        });
        data.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);
    const range = XLSX.utils.decode_range(ws['!ref']);

    // === BASISFORMATIERUNG (Text oben, Umbruch) ===
    for (let r = range.s.r; r <= range.e.r; ++r) {
        for (let c = range.s.c; c <= range.e.c; ++c) {
            const addr = XLSX.utils.encode_cell({ r, c });
            if (!ws[addr]) continue;
            ws[addr].s = ws[addr].s || {};
            ws[addr].s.alignment = {
                wrapText: true,
                vertical: "top",
                horizontal: "left"
            };
            ws[addr].s.font = { sz: 10 };
        }
    }

    // === SPALTENBREITEN ===
    ws['!cols'] = [
        { wch: 45 }, // Kompetenz
        { wch: 38 }, { wch: 38 }, { wch: 38 }, { wch: 38 }, { wch: 38 }
    ];

    // === ZEILENHÖHEN ===
    ws['!rows'] = [
        { hpt: 30 },  // Titel
        { hpt: 15 },  // Leer
        { hpt: 50 }   // Header
    ];
    for (let r = 3; r <= 8; r++) {
        let maxLines = 1;
        for (let c = 1; c <= 5; c++) {
            const addr = XLSX.utils.encode_cell({ r, c });
            if (!ws[addr] || ws[addr].v === '—') continue;
            const lines = (ws[addr].v.match(/\n\n/g) || []).length + 1;
            if (lines > maxLines) maxLines = lines;
        }
        ws['!rows'][r] = { hpt: Math.min(45 + (maxLines * 36), 500) };
    }

    // === TITEL (A1) ===
    const titleAddr = XLSX.utils.encode_cell({ r: 0, c: 0 });
    ws[titleAddr].s = {
        font: { bold: true, sz: 14, color: { rgb: "333333" } },
        alignment: { horizontal: "left", vertical: "top" }
    };

    // === SCHULNAME (rechts oben, z. B. F1) ===
    const schoolAddr = XLSX.utils.encode_cell({ r: 0, c: 5 });
    ws[schoolAddr] = { v: localStorage.getItem('schoolName') || 'Deine Schule', t: "s" };
    ws[schoolAddr].s = {
        font: { italic: true, color: { rgb: "666666" }, sz: 11 },
        alignment: { horizontal: "right", vertical: "top" }
    };

    // === HEADER: "Kompetenz" (A3) ===
    const compHeaderAddr = XLSX.utils.encode_cell({ r: 2, c: 0 });
    ws[compHeaderAddr].s = {
        fill: { patternType: "solid", fgColor: { rgb: "6B46C1" } },
        font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
        alignment: { horizontal: "center", vertical: "top", wrapText: true }
    };

    // === HEADER: Niveaustufen (B3–F3) ===
    levels.forEach((lvl, idx) => {
        const addr = XLSX.utils.encode_cell({ r: 2, c: idx + 1 });
        ws[addr].s = {
            fill: { patternType: "solid", fgColor: { rgb: levelRGB[lvl] } },
            font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
            alignment: { horizontal: "center", vertical: "top", wrapText: true }
        };
    });

    // === KOMPETENZNAMEN (A4–A9) ===
    competences.forEach((_, idx) => {
        const addr = XLSX.utils.encode_cell({ r: idx + 3, c: 0 });
        ws[addr].s = {
            fill: { patternType: "solid", fgColor: { rgb: "F8F9FF" } },
            font: { bold: true, sz: 11 },
            alignment: { horizontal: "left", vertical: "top", wrapText: true }
        };
    });

    // === DATENZELLEN (B4–F9) ===
    for (let r = 3; r <= 8; r++) {
        for (let c = 1; c <= 5; c++) {
            const addr = XLSX.utils.encode_cell({ r, c });
            if (!ws[addr]) continue;
            const level = levels[c - 1];
            const isEmpty = ws[addr].v === '—';
            ws[addr].s = {
                fill: { patternType: "solid", fgColor: { rgb: isEmpty ? "FFFFFF" : levelRGB[level] } },
                font: {
                    color: { rgb: isEmpty ? "999999" : "000000" },
                    italic: isEmpty,
                    sz: 10
                },
                alignment: { horizontal: "left", vertical: "top", wrapText: true }
            };
        }
    }

    // === EXPORT ===
    XLSX.utils.book_append_sheet(wb, ws, "LernMatrix");
    const today = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `LernDashboard_Matrix_${today}.xlsx`);
}
// === FILTER-STATUS: HERVORHEBUNG + TITEL DYNAMISCH ===
function updateFilterStatus() {
    const filters = {
        subject: document.getElementById('filterSubject')?.value,
        grade: document.getElementById('filterGrade')?.value,
        tool: document.getElementById('filterTool')?.value,
        competence: document.getElementById('filterCompetence')?.value,
        level: document.getElementById('filterLevel')?.value,
        favorite: document.getElementById('filterFavorite')?.value,
        search: document.getElementById('searchTopic')?.value.trim()
    };

    const isFiltered = Object.values(filters).some(v => v && v !== '' && v !== 'Alle');

    // Titel dynamisch
    const title = document.getElementById('filterExportTitle');
    if (title) {
        title.textContent = isFiltered ? 'Filter-Exporte (aktiv)' : 'Filter-Exporte';
        title.style.color = isFiltered ? '#e74c3c' : 'var(--primary)';
    }

    // Buttons hervorheben
    document.querySelectorAll('.filtered-export').forEach(btn => {
        btn.classList.toggle('active', isFiltered);
    });
}

// Beim Laden
document.addEventListener('DOMContentLoaded', updateFilterStatus);

// === BACKUP MIT MODAL + AUTOMATISCHER DOWNLOAD ===
function autoBackup() {
    const allResources = JSON.parse(localStorage.getItem('resources') || '[]');
    
    if (allResources.length === 0) {
        showFancyAlert('Keine Daten zum Sichern!', 'warning');
        return;
    }

    // Modal erstellen (unverändert)
    const modal = document.createElement('div');
    modal.style.cssText = `
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.6); backdrop-filter:blur(8px);
        display:flex; justify-content:center; align-items:center;
        z-index:20000; font-family:Segoe UI,sans-serif;
    `;
    modal.innerHTML = `
        <div style="
            background:var(--card); padding:32px; border-radius:20px; text-align:center;
            width:90%; max-width:420px; box-shadow:0 16px 48px rgba(0,0,0,0.3);
            transform:scale(0.9); opacity:0;
            transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s ease;
        ">
            <div id="backupIcon" style="width:80px; height:80px; margin:0 auto 20px;">
                <svg width="80" height="80" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="4"/>
                    <circle id="backupCircle" cx="50" cy="50" r="44" fill="none" stroke="#6b46c1" stroke-width="4"
                            stroke-dasharray="276.46" stroke-dashoffset="276.46"
                            style="transition:stroke-dashoffset 1s ease;"/>
                    <path id="backupCheck" d="M30 50 L45 65 L70 35" fill="none" stroke="#27ae60" stroke-width="6"
                          stroke-linecap="round" stroke-linejoin="round"
                          style="stroke-dasharray:100; stroke-dashoffset:100;"/>
                </svg>
            </div>
            <p id="backupTitle" style="font-size:19px; font-weight:700; color:var(--text); margin:0 0 8px;">
                Backup wird erstellt...
            </p>
            <p id="backupSubtitle" style="font-size:14px; color:var(--text-light); margin:0;">
                ${allResources.length} Ressourcen werden gesichert
            </p>
            <div style="margin-top:20px; height:6px; background:#e0e0e0; border-radius:3px; overflow:hidden;">
                <div id="backupProgress" style="width:0%; height:100%; background:#6b46c1; border-radius:3px; transition:width 0.8s ease;"></div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // Animation: Modal einblenden (unverändert)
    requestAnimationFrame(() => {
        modal.querySelector('div').style.transform = 'scale(1)';
        modal.querySelector('div').style.opacity = '1';
    });

    // Fortschritt simulieren (unverändert)
    const progress = modal.querySelector('#backupProgress');
    const circle = modal.querySelector('#backupCircle');
    const title = modal.querySelector('#backupTitle');
    const subtitle = modal.querySelector('#backupSubtitle');
    const check = modal.querySelector('#backupCheck');

    setTimeout(() => {
        progress.style.width = '100%';
        circle.style.strokeDashoffset = '0';
    }, 100);

    // CSV generieren & downloaden – FRÜHER AUSLÖSEN (nach 300ms, während Animation läuft)
    setTimeout(() => {
        const headers = ['Thema','Unterrichtsfach','Klassenstufe','Kompetenzbereich','Niveaustufe','Digitales_Hilfsmittel','Beschreibung'];
        const csv = [
            headers.join(','),
            ...allResources.map(r => [
                `"${(r.topic||'').replace(/"/g,'""')}"`,
                `"${r.subject||''}"`,
                `"${r.grade||''}"`,
                `"${r.competence||''}"`,
                `"${r.level||''}"`,
                `"${(r.tool||'').replace(/"/g,'""')}"`,
                `"${(r.description||'').replace(/"/g,'""')}"`
            ].join(','))
        ].join('\n');

        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `LernDashboard_Backup_${new Date().toISOString().slice(0,10)}.csv`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Erfolg anzeigen (unverändert)
        title.textContent = 'Backup erfolgreich!';
        title.style.color = '#27ae60';
        subtitle.textContent = 'Datei wird heruntergeladen...';
        check.style.strokeDashoffset = '0';
        check.style.animation = 'draw 0.6s ease forwards';

        // Modal nach 1,5 Sek schließen (unverändert)
        setTimeout(() => {
            modal.style.opacity = '0';
            setTimeout(() => modal.remove(), 400);
        }, 1500);
    }, 300);  // ← Hier früher: 300ms statt 1000ms
}

// Hilfsfunktion: HTML escapen (sicherer für Inhalte)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function printOptimized() {
    // 1. Schulname setzen
    const schoolName = localStorage.getItem('schoolName') || 'Deine Schule';
    const printSchoolEl = document.getElementById('printSchoolNameText');
    if (printSchoolEl) {
        printSchoolEl.textContent = schoolName;
    }

    // 2. Gefilterte Ressourcen holen (deine bestehende Funktion!)
    const filtered = getFilteredResources();
    if (filtered.length === 0) {
        showAlert('Keine Daten zum Drucken!\nTipp: Filter zurücksetzen oder Daten prüfen.');
        return;
    }

    // 3. Tabelle generieren
    let tableHtml = `
        <div style="margin-bottom: 20mm;">
            <h2 style="color: #6b46c1; text-align: center; margin-bottom: 10mm;">
                LernDashboard Digital – Gefilterte Ressourcen
            </h2>
            <p style="text-align: center; color: #666; font-size: 10pt; margin-bottom: 15mm;">
                Exportiert am: ${new Date().toLocaleDateString('de-DE')}
            </p>
            <table style="width:100%; border-collapse: collapse; font-size: 10pt;">
                <thead>
                    <tr style="background: #6b46c1; color: white;">
                        <th style="padding: 8px; text-align: left;">Thema</th>
                        <th style="padding: 8px; text-align: left;">Fach</th>
                        <th style="padding: 8px; text-align: left;">Klasse</th>
                        <th style="padding: 8px; text-align: left;">Kompetenz</th>
                        <th style="padding: 8px; text-align: left;">Niveau</th>
                        <th style="padding: 8px; text-align: left;">Tool</th>
                        <th style="padding: 8px; text-align: left;">Beschreibung</th>
                    </tr>
                </thead>
                <tbody>`;
    
    filtered.forEach(r => {
        tableHtml += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 8px; vertical-align: top;">${escapeHtml(r.topic || '')}</td>
                <td style="padding: 8px; vertical-align: top;">${escapeHtml(r.subject || '')}</td>
                <td style="padding: 8px; vertical-align: top;">${escapeHtml(r.grade || '')}</td>
                <td style="padding: 8px; vertical-align: top;">${escapeHtml(r.competence || '')}</td>
                <td style="padding: 8px; vertical-align: top;">${escapeHtml(r.level || '')}</td>
                <td style="padding: 8px; vertical-align: top;">${escapeHtml(r.tool || '')}</td>
                <td style="padding: 8px; vertical-align: top; max-width: 200px;">${escapeHtml(r.description || '')}</td>
            </tr>`;
    });
    
    tableHtml += `</tbody></table></div>`;

    // 4. Inhalt temporär ersetzen
    const container = document.querySelector('.resources-container');
    const originalContent = container.innerHTML;
    container.innerHTML = tableHtml;

    // 5. Drucken und zurücksetzen
    window.print();
    setTimeout(() => { container.innerHTML = originalContent; }, 500);
}
// === AUTOMATISCHE UPDATE-PRÜFUNG MIT GITHUB + SERVICE WORKER ===
const CURRENT_VERSION = '1.3.5';  // Muss mit HTML-Version übereinstimmen
const GITHUB_REPO = 'matthiaskloss/lern-dashboard';  // Ersetze mit deinem Repo!
const UPDATE_CHECK_INTERVAL = 24 * 60 * 60 * 1000; // 24 Stunden
const LAST_CHECK_KEY = 'lastUpdateCheck';
const PENDING_UPDATE_KEY = 'pendingUpdateVersion';

let newServiceWorker = null;

// Prüfe auf GitHub-Update
async function checkForAppUpdate() {
    if (!navigator.onLine) return;

    const now = Date.now();
    const lastCheck = localStorage.getItem(LAST_CHECK_KEY);
    if (lastCheck && now - parseInt(lastCheck) < UPDATE_CHECK_INTERVAL) return;

    try {
        const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/releases/latest`);
        if (!res.ok) return;

        const data = await res.json();
        const latestVersion = data.tag_name.replace(/^v/, ''); // "v1.3.6" → "1.3.6"

        if (latestVersion !== CURRENT_VERSION) {
            localStorage.setItem(PENDING_UPDATE_KEY, latestVersion);
            showUpdateBanner(latestVersion);
        }

        localStorage.setItem(LAST_CHECK_KEY, now.toString());
    } catch (err) {
        console.warn('Update-Check fehlgeschlagen:', err);
    }
}

// Banner anzeigen
function showUpdateBanner(version) {
    if (document.getElementById('updateBanner')) return;

    const banner = document.createElement('div');
    banner.id = 'updateBanner';
    banner.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white; padding: 14px 20px; border-radius: 12px;
        box-shadow: 0 8px 24px rgba(46,204,113,0.4);
        font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 12px;
        max-width: 340px; animation: slideIn 0.4s ease;
    `;
    banner.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div>
            <strong>Update verfügbar!</strong><br>
            <span style="font-weight:normal; font-size:13px;">v${version} – Jetzt aktualisieren</span>
        </div>
        <button id="applyUpdateBtn" style="
            background:#fff; color:#27ae60; border:none; border-radius:8px;
            padding:6px 12px; font-weight:600; cursor:pointer; font-size:13px;
            margin-left:8px;
        ">Update</button>
        <button onclick="this.parentElement.remove()" style="
            background:none; border:none; color:#fff; font-size:18px; cursor:pointer; opacity:0.8;
            margin-left:8px;
        ">×</button>
    `;

    document.body.appendChild(banner);

    // Update-Button
    banner.querySelector('#applyUpdateBtn').onclick = () => {
        if (newServiceWorker) {
            newServiceWorker.postMessage({ action: 'skipWaiting' });
        } else {
            location.reload();
        }
    };
}

// Service Worker Update-Handling
function registerUpdateListener() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
            registration.addEventListener('updatefound', () => {
                newServiceWorker = registration.installing;
                if (newServiceWorker) {
                    newServiceWorker.addEventListener('statechange', () => {
                        if (newServiceWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Neuer SW ist bereit
                            const pendingVersion = localStorage.getItem(PENDING_UPDATE_KEY);
                            if (pendingVersion) {
                                showUpdateBanner(pendingVersion);
                            }
                        }
                    });
                }
            });
        });

        // Prüfe bei jedem Start
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            localStorage.removeItem(PENDING_UPDATE_KEY);
            window.location.reload();
        });
    }
}

// Starte Prüfung
document.addEventListener('DOMContentLoaded', () => {
    registerUpdateListener();
    checkForAppUpdate();

    // Optional: Prüfe auch bei Fokus (wenn App im Hintergrund war)
    window.addEventListener('focus', checkForAppUpdate);
});
// --- NUR EINMAL style ERSTELLEN ---
if (!document.getElementById('app-animations')) {
    const style = document.createElement('style');
    style.id = 'app-animations';
    style.textContent = `
        @keyframes draw { to { stroke-dashoffset: 0; } }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}
 </script>  <!-- ← ENDE SCRIPT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

     <!-- Version-Info -->
    <div class="version-info">
        v1.3.5 – © Matthias Kloß MPZ NB
    </div>

    <!-- === LÖSCH-ANIMATION === -->
    <div id="deleteAnimation" style="
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.5);backdrop-filter:blur(6px);
        display:none;justify-content:center;align-items:center;
        z-index:10000;
    ">
        <div style="
            background:var(--card);padding:40px;border-radius:20px;text-align:center;
            box-shadow:0 16px 48px rgba(0,0,0,0.25);
            transform:scale(0.8);opacity:0;
            transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1),opacity 0.4s ease;
        ">
            <div style="width:90px;height:90px;margin:0 auto 18px;position:relative;">
                <svg width="90" height="90" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="3"/>
                    <path d="M30 50 L45 65 L70 35" fill="none" stroke="#e74c3c" stroke-width="6"
                          stroke-linecap="round" stroke-linejoin="round"
                          style="stroke-dasharray:100;stroke-dashoffset:100;animation:draw 0.6s ease forwards 0.3s;"/>
                </svg>
            </div>
            <p style="font-size:20px;font-weight:700;color:#e74c3c;margin:0 0 6px;">
                Gelöscht!
            </p>
            <p style="font-size:14px;color:var(--text-light);margin:0;">
                Die Ressource wurde entfernt.
            </p>
        </div>
    </div>

    <style>
        @keyframes draw { to { stroke-dashoffset: 0; } }
        .delete-active { display: flex !important; }
        .delete-active > div { transform: scale(1) !important; opacity: 1 !important; }
        .edit-active { display: flex !important; }
         .edit-active > div { transform: scale(1) !important; opacity: 1 !important; }
        .add-active { display: flex !important; }
         .add-active > div { transform: scale(1) !important; opacity: 1 !important; }
    /* === TABELLEN: KEINE LÜCKEN ZWISCHEN ZELLEN === */
table, th, td {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    border: none !important;
}

th {
    background: #6b46c1 !important;
    color: white !important;
    padding: 14px 16px !important;
    font-weight: 600;
    text-align: left;
    font-size: 15px;
}

td {
    background: #f8f9fa !important;
    padding: 12px 16px !important;
    vertical-align: top;
    border-bottom: 1px solid #ddd !important;
}

/* Optional: Letzte Zeile ohne unteren Rand */
tr:last-child td {
    border-bottom: none !important;
}
/* === EXPORT: HORIZONTAL + FILTERABHÄNGIGKEIT KLAR === */
.export-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    align-items: flex-start;
    margin: 15px 0;
    justify-content: flex-start;
}

.export-group.horizontal {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 300px;
    flex: 1;
}

.export-group-title {
    margin: 0 !important;
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
    padding-bottom: 4px;
    border-bottom: 2px solid var(--primary-light);
    text-align: left;
}

#filterExportTitle {
    transition: color 0.3s ease;
}

.btn-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

/* === FILTER-EXPORT BUTTONS: Hervorhebung bei aktiven Filtern === */
.filtered-export {
    position: relative;
    transition: all 0.2s ease;
}

.filtered-export.active {
    animation: pulse 2s infinite;
    box-shadow: 0 0 0 2px #e74c3c !important;
    transform: translateY(-1px);
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 2px #e74c3c; }
    50% { box-shadow: 0 0 0 4px #e74c3c, 0 0 12px rgba(231, 76, 60, 0.4); }
}

/* === TOOLTIPS === */
.btn[title] {
    position: relative;
    cursor: pointer;
}

.btn[title]:hover::after,
.btn[title]:focus::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    white-space: nowrap;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    margin-bottom: 8px;
    max-width: 300px;
    white-space: normal;
    line-height: 1.4;
}

.btn[title]:hover::before,
.btn[title]:focus::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #333;
    margin-bottom: 2px;
    z-index: 1000;
}

/* === MOBILE === */
@media (max-width: 768px) {
    .export-buttons {
        flex-direction: column;
        gap: 16px;
    }
    .export-group.horizontal {
        min-width: 100%;
    }
    .export-group-title {
        text-align: center;
        font-size: 13.5px;
    }
    .btn-row {
        justify-content: center;
    }
    .btn[title]:hover::after,
    .btn[title]:hover::before {
        display: none;
    }
    .btn[title]:active::after,
    .btn[title]:active::before {
        display: block;
    }
}
@media print {
    body {
        background: white !important;
        color: black !important;
        font-size: 10pt !important;
        margin: 0 !important;
    }

    /* Verstecke unnötige Elemente */
    .logo-header, .filter-container, .export-buttons, .new-resource-btn, 
    .sidebar, .version-info, #deleteAnimation, #editAnimation, #addAnimation,
    .action-icons, .test-banner, div[style*="background: #ff4444"] {  /* Banner verstecken */
        display: none !important;
    }

    /* Ressourcen-Container optimieren */
    .content-wrapper { display: block !important; }
    .resources-container { width: 100% !important; margin: 0 !important; padding: 0 !important; }
    .resource-item { border: 1px solid #ddd !important; page-break-inside: avoid !important; margin-bottom: 10mm !important; }
    .tag { background: #eee !important; color: black !important; }
    .description { background: none !important; border-left: 3px solid #000 !important; }

    /* Schulname sichtbar machen – mit Fallback */
    #printSchoolName {
        display: block !important;
        position: running(schoolFooter) !important;  /* Für Browser, die es unterstützen (z. B. Firefox) */
        font-size: 9pt !important;
        color: #666 !important;
    }

    /* @page Regeln */
    @page {
        size: A4 portrait;
        margin: 20mm 15mm 25mm 15mm;  /* Mehr Platz unten für Footer */
        @top-center {
            content: "LernDashboard Digital - Seite " counter(page) " / " counter(pages);
            font-size: 9pt;
            color: #666;
        }
        @bottom-left {
            content: element(schoolFooter);  /* Verknüpft mit running(schoolFooter) */
            font-size: 9pt;
            color: #666;
        }
        @bottom-right {
            content: "Exportiert am: " env(date);
            font-size: 9pt;
            color: #666;
        }
    }

    /* Fallback für Browser ohne running-Support (z. B. Chrome): Fixed-Position */
    @supports not (position: running(schoolFooter)) {
        #printSchoolName {
            position: fixed !important;
            bottom: 10mm !important;
            left: 15mm !important;
        }
    }
}

    </style>
<!-- === BEARBEITUNGS-BESTÄTIGUNG (ANIMATION – OHNE TON) === -->
<div id="editAnimation" style="
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); backdrop-filter:blur(6px);
    display:none; justify-content:center; align-items:center;
    z-index:10000;
">
    <div style="
        background:var(--card); padding:40px; border-radius:20px; text-align:center;
        box-shadow:0 16px 48px rgba(0,0,0,0.25);
        transform:scale(0.8); opacity:0;
        transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s ease;
    ">
        <div style="width:90px; height:90px; margin:0 auto 18px;">
            <svg width="90" height="90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="3"/>
                <path d="M30 50 L45 65 L70 35" fill="none" stroke="#27ae60" stroke-width="6"
                      stroke-linecap="round" stroke-linejoin="round"
                      style="stroke-dasharray:100; stroke-dashoffset:100; animation:draw 0.6s ease forwards 0.3s;"/>
            </svg>
        </div>
        <p style="font-size:20px; font-weight:700; color:#27ae60; margin:0 0 6px;">
            Bearbeitet!
        </p>
        <p style="font-size:14px; color:var(--text-light); margin:0;">
            Die Ressource wurde aktualisiert.
        </p>
    </div>
</div>
        <!-- === HINZUFÜGEN-BESTÄTIGUNG (ANIMATION) === -->
<div id="addAnimation" style="
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); backdrop-filter:blur(6px);
    display:none; justify-content:center; align-items:center;
    z-index:10000;
">
    <div style="
        background:var(--card); padding:40px; border-radius:20px; text-align:center;
        box-shadow:0 16px 48px rgba(0,0,0,0.25);
        transform:scale(0.8); opacity:0;
        transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s ease;
    ">
        <div style="width:90px; height:90px; margin:0 auto 18px;">
            <svg width="90" height="90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="44" fill="none" stroke="#e0e0e0" stroke-width="3"/>
                <path d="M30 50 L45 65 L70 35" fill="none" stroke="#27ae60" stroke-width="6"
                      stroke-linecap="round" stroke-linejoin="round"
                      style="stroke-dasharray:100; stroke-dashoffset:100; animation:draw 0.6s ease forwards 0.3s;"/>
            </svg>
        </div>
        <p style="font-size:20px; font-weight:700; color:#27ae60; margin:0 0 6px;">
            Hinzugefügt!
        </p>
        <p style="font-size:14px; color:var(--text-light); margin:0;">
            Die Ressource ist im Dashboard.
        </p>
    </div>
</div>

</body>
</html>
