<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Neue Ressource</title>
<style>
:root { --primary: #6b46c1; --card: #ffffff; --bg: #f5f7fa; --shadow: 0 4px 12px rgba(0,0,0,0.1); }
.dark { --bg: #1a1a1a; --card: #2d2d2d; color: #e0e0e0; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; padding: 20px; margin: 0; }
.container { max-width: 600px; margin: 0 auto; background: var(--card); padding: 24px; border-radius: 16px; box-shadow: var(--shadow); }
h2 { color: var(--primary); margin-top: 0; text-align: center; }
.form-group { margin-bottom: 16px; }
label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
textarea { min-height: 100px; resize: vertical; }
.buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
.save { background: var(--primary); color: white; }
.cancel { background: #95a5a6; color: white; }
</style>
</head>
<body>
<div class="container">
<h2>Neue Ressource hinzufügen</h2>
<form id="resourceForm">
<div class="form-group"><label>Thema *</label><input type="text" id="topic" placeholder="z.B. Klimawandel interaktiv" required></div>
<div class="form-group"><label>Fach *</label><select id="subject" required>
<option value="">– Fach wählen –</option>
<option>AWT</option><option>Astronomie</option><option>Biologie</option>
<option>Chemie</option><option>Deutsch</option><option>Englisch</option>
<option>Französisch</option><option>Geografie</option><option>Geschichte</option>
<option>Gesellschaftskunde</option><option>Informatik</option><option>Italienisch</option>
<option>Kunst</option><option>Mathematik</option><option>Musik</option>
<option>Naturwissenschaften</option><option>Physik</option><option>Plattdeutsch</option>
<option>Russisch</option><option>Spanisch</option><option>Sozialkunde</option>
<option>Sport</option><option>Wirtschaft</option>
</select></div>
<div class="form-group"><label>Klasse *</label><select id="grade" required>
<option value="">– Klasse wählen –</option>
</select></div>
<script>
const gradeSelect = document.getElementById('grade');
for (let i = 1; i <= 13; i++) {
  const option = document.createElement('option');
  option.value = `Klasse ${i}`;
  option.textContent = `Klasse ${i}`;
  gradeSelect.appendChild(option);
}
</script>
<div class="form-group"><label>Kompetenzbereich *</label><select id="competence" required>
<option value="">– Kompetenz wählen –</option>
<option>Suchen, Verarbeiten und Aufbewahren</option>
<option>Kommunizieren und Kooperieren</option>
<option>Produzieren und Präsentieren</option>
<option>Schützen und sicher Agieren</option>
<option>Problemlösen und Handeln</option>
<option>Analysieren und Reflektieren</option>
</select></div>
<div class="form-group"><label>Niveaustufe *</label>
<select id="level" required>
<option value="">- Niveau wählen -</option>
<option value="Niveaustufe 1">Niveaustufe 1</option>
<option value="Niveaustufe 2">Niveaustufe 2</option>
<option value="Niveaustufe 3">Niveaustufe 3</option>
<option value="Niveaustufe 4">Niveaustufe 4</option>
<option value="Niveaustufe 5">Niveaustufe 5</option>
</select></div>
<div class="form-group"><label>Digitales Tool</label><input type="text" id="tool" placeholder="z.B. GeoGebra, Canva, Padlet"></div>
<div class="form-group"><label>Beschreibung (optional)</label><textarea id="description" placeholder="Kurze Beschreibung der Unterrichtsidee..."></textarea></div>
<div class="buttons">
  <button type="button" class="cancel" onclick="cancel()">Abbrechen</button>
  <button type="submit" class="save">Speichern</button>
</div>
</form>
</div>

<script>
// === Abbrechen ===
function cancel() {
  const hasInput = document.getElementById('topic').value.trim() ||
                   document.getElementById('subject').value ||
                   document.getElementById('grade').value ||
                   document.getElementById('competence').value ||
                   document.getElementById('level').value;
  if (hasInput && !confirm('Möchtest du wirklich abbrechen? Deine Eingaben gehen verloren.')) return;
  window.close();
}

// === Robuster Versand (funktioniert im Browser UND in installierter PWA) ===
// === FINALER VERSAND – KEIN DOPPEL mehr, funktioniert überall! ===
function sendToMainWindow(type, payload) {
    let sent = false;

    // 1. postMessage versuchen (funktioniert im normalen Browser-Fenster)
    if (!sent && window.opener && !window.opener.closed) {
        try {
            window.opener.postMessage({ type, ...payload }, '*');
            sent = true;                // ← Wenn postMessage ging → fertig
            console.log('Gesendet via postMessage');
        } catch (e) {
            console.warn('postMessage fehlgeschlagen', e);
        }
    }

    // 2. NUR als Fallback: BroadcastChannel (wichtig in installierter PWA)
    if (!sent) {
        try {
            const channel = new BroadcastChannel('lerndashboard-channel');
            channel.postMessage({ type, ...payload });
            channel.close();
            console.log('Gesendet via BroadcastChannel (Fallback)');
        } catch (e) {
            console.warn('BroadcastChannel nicht verfügbar', e);
        }
    }

    // Kleine Bestätigung im Popup (kann später wieder raus)
    setTimeout(() => {
        if (document.body) {
            const fb = document.createElement('div');
            fb.textContent = 'Gespeichert!';
            fb.style.cssText = 'position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#27ae60;color:white;padding:8px 16px;border-radius:8px;font-weight:bold;z-index:10000;';
            document.body.appendChild(fb);
            setTimeout(() => fb.remove(), 1500);
        }
    }, 300);
}

// === Speichern (EINZIGER Handler!) ===
document.getElementById('resourceForm').onsubmit = e => {
  e.preventDefault();

  const resource = {
    topic: document.getElementById('topic').value.trim(),
    subject: document.getElementById('subject').value,
    grade: document.getElementById('grade').value,
    competence: document.getElementById('competence').value,
    level: document.getElementById('level').value,
    tool: document.getElementById('tool').value.trim(),
    description: document.getElementById('description').value.trim(),
    favorite: false,
    lastModified: new Date().toLocaleDateString('de-DE')
  };

  // Pflichtfelder prüfen
  if (!resource.topic || !resource.subject || !resource.grade || !resource.competence || !resource.level) {
    alert('Bitte alle Pflichtfelder ausfüllen!');
    return;
  }

  // Nachricht senden
  sendToMainWindow('ADD_RESOURCE', { data: resource });

  // KEIN alert() mehr – das Hauptfenster zeigt die schöne Animation
  window.close();
};

// Dark Mode vom Hauptfenster übernehmen
if (window.opener && window.opener.document.body.classList.contains('dark')) {
  document.body.classList.add('dark');
}
</script>
</body>
</html>